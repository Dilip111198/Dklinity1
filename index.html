<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dklinity - Clinical Trials Database with ARM & References</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <!-- Add Firebase products that you want to use -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>

  <!-- CKEditor 5 -->
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: rgba(107, 114, 128, 0.5);
      border-radius: 3px;
    }
    /* Simple contenteditable styling */
    .editable-table {
      border: 1px solid #cbd5e1;
      border-radius: 0.375rem;
      padding: 0.5rem;
      min-height: 100px;
      overflow: auto;
      background-color: #f9fafb;
    }
    /* JSGrid custom styling */
    .jsgrid-table {
      font-size: 12px;
    }
    .jsgrid-header-cell, .jsgrid-cell {
      padding: 4px 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .jsgrid-grid-header {
      background-color: #1e3a8a;
      color: white;
    }
    .jsgrid-header-row > .jsgrid-header-cell {
      background-color: #1e3a8a;
      color: white;
      border-color: #1e40af;
    }
    .jsgrid-alt-row {
      background-color: #f9fafb;
    }
    .jsgrid-row:hover {
      background-color: #f3f4f6;
    }
    /* Hide jsgrid default paging info text */
    .jsgrid-pager .jsgrid-pager-info {
      display: none;
    }
    /* Responsive grid container */
    .survival-grid-container {
      overflow-x: auto;
      max-width: 100%;
    }

    /* CKEditor styling */
    .ck-editor__editable {
      min-height: 200px;
    }
    .ck-editor {
      margin-bottom: 1rem;
    }
    .ck.ck-editor__main > .ck-editor__editable {
      border-radius: 0.375rem;
    }
    .ck.ck-editor__top .ck-sticky-panel .ck-toolbar {
      border-radius: 0.375rem 0.375rem 0 0;
    }

    /* Table formatting for rich text content - both in editor and display */
    /* Compact format matching application data tables */
    .ck-editor__editable table,
    .rich-text-display table {
      border-collapse: collapse;
      border: 1px solid #d1d5db;
      width: 100%;
      margin: 1rem 0;
      font-size: 0.875rem; /* text-sm equivalent */
      max-height: 20rem; /* max-h-80 equivalent */
      overflow-y: auto;
      display: block;
    }

    .ck-editor__editable table thead,
    .rich-text-display table thead {
      display: table-header-group;
      background-color: #4f46e5; /* indigo-600 for rich text tables */
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .ck-editor__editable table tbody,
    .rich-text-display table tbody {
      display: table-row-group;
    }

    .ck-editor__editable table tr,
    .rich-text-display table tr {
      display: table-row;
      border-top: 1px solid #e5e7eb;
    }

    .ck-editor__editable table td,
    .ck-editor__editable table th,
    .rich-text-display table td,
    .rich-text-display table th {
      border: 1px solid #d1d5db;
      padding: 0.25rem 0.5rem; /* px-2 py-1 equivalent */
      text-align: left;
      vertical-align: top;
      display: table-cell;
    }

    .ck-editor__editable table th,
    .rich-text-display table th {
      background-color: #4f46e5; /* indigo-600 */
      color: white;
      font-weight: 600;
      border: 1px solid #d1d5db;
    }

    .ck-editor__editable table tbody tr:nth-child(even),
    .rich-text-display table tbody tr:nth-child(even) {
      background-color: #f9fafb;
    }

    .ck-editor__editable table tbody tr:nth-child(odd),
    .rich-text-display table tbody tr:nth-child(odd) {
      background-color: white;
    }

    .ck-editor__editable table tbody tr:hover,
    .rich-text-display table tbody tr:hover {
      background-color: #e0e7ff; /* indigo-100 */
    }

    /* Wrapper for rich text tables to handle scrolling properly */
    .rich-text-display table {
      display: table; /* Reset to normal table display for rich text */
      max-height: none; /* Remove height restriction for rich text tables */
      overflow: visible; /* Remove overflow for rich text tables */
    }

    /* Container for rich text tables - show all content */
    .rich-text-display {
      max-height: none; /* Remove height restriction */
      overflow: visible; /* Show all content */
    }

    /* Ensure table headers are visible in rich text */
    .rich-text-display table thead th {
      position: sticky;
      top: 0;
      z-index: 5;
    }

    /* Show all content in rich text tables - no truncation */
    .rich-text-display table td {
      max-width: none; /* Remove width restriction */
      overflow: visible; /* Show all content */
      white-space: normal; /* Allow text wrapping */
      word-wrap: break-word; /* Break long words */
    }

    .rich-text-display table td:hover {
      background-color: #f3f4f6;
    }

    /* Ensure CKEditor tables in edit mode also follow compact format */
    .ck-editor__editable table {
      display: table;
      max-height: none;
      overflow: visible;
    }

    /* CKEditor specific table styling to match compact format */
    .ck-editor__editable table thead th {
      background-color: #4f46e5 !important;
      color: white !important;
      font-weight: 600 !important;
    }

    /* Override CKEditor default table styles */
    .ck-editor__editable .ck-table-resized {
      table-layout: auto !important;
    }

    .ck-editor__editable table td.ck-editor__editable,
    .ck-editor__editable table th.ck-editor__editable {
      padding: 0.25rem 0.5rem !important;
      border: 1px solid #d1d5db !important;
    }

    /* Force consistent font styling in CKEditor */
    .ck-editor__editable,
    .ck-editor__editable *,
    .rich-text-display,
    .rich-text-display * {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
      font-size: 14px !important;
      line-height: 1.5 !important;
    }

    /* Ensure italic formatting works properly */
    .ck-editor__editable em,
    .ck-editor__editable i,
    .ck-editor__editable [style*="font-style: italic"],
    .rich-text-display em,
    .rich-text-display i,
    .rich-text-display [style*="font-style: italic"] {
      font-style: italic !important;
    }

    /* Ensure bold formatting works properly */
    .ck-editor__editable strong,
    .ck-editor__editable b,
    .ck-editor__editable [style*="font-weight: bold"],
    .rich-text-display strong,
    .rich-text-display b,
    .rich-text-display [style*="font-weight: bold"] {
      font-weight: bold !important;
    }

    /* Remove any font-family and font-size from pasted content */
    .ck-editor__editable [style*="font-family"],
    .ck-editor__editable [style*="font-size"],
    .rich-text-display [style*="font-family"],
    .rich-text-display [style*="font-size"] {
      font-family: inherit !important;
      font-size: inherit !important;
    }

    /* Rich text formatting for display - preserve all CKEditor formatting */
    .rich-text-display {
      line-height: 1.6;
      color: #374151;
    }

    /* Bullet points and lists formatting - for both editor and display */
    .rich-text-display ul,
    .rich-text-display ol,
    .ck-editor__editable ul,
    .ck-editor__editable ol {
      margin: 1rem 0;
      padding-left: 2rem;
    }

    .rich-text-display ul,
    .ck-editor__editable ul {
      list-style-type: disc;
    }

    .rich-text-display ul ul,
    .ck-editor__editable ul ul {
      list-style-type: circle;
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }

    .rich-text-display ul ul ul,
    .ck-editor__editable ul ul ul {
      list-style-type: square;
      margin: 0.25rem 0;
      padding-left: 1.5rem;
    }

    .rich-text-display ol,
    .ck-editor__editable ol {
      list-style-type: decimal;
    }

    .rich-text-display ol ol,
    .ck-editor__editable ol ol {
      list-style-type: lower-alpha;
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }

    .rich-text-display ol ol ol,
    .ck-editor__editable ol ol ol {
      list-style-type: lower-roman;
      margin: 0.25rem 0;
      padding-left: 1.5rem;
    }

    .rich-text-display li,
    .ck-editor__editable li {
      margin: 0.25rem 0;
      padding-left: 0.25rem;
      display: list-item;
    }

    /* Ensure proper list item display in CKEditor */
    .ck-editor__editable .ck-list-bogus-paragraph {
      margin: 0;
      padding: 0;
    }

    /* Fix CKEditor list indentation */
    .ck-editor__editable[data-placeholder]::before {
      color: #999;
    }

    /* Ensure nested lists show proper hierarchy in editor */
    .ck-editor__editable ul li,
    .ck-editor__editable ol li {
      position: relative;
      margin-left: 0;
    }

    /* Override CKEditor default list styles that might flatten hierarchy */
    .ck-editor__editable ul,
    .ck-editor__editable ol {
      list-style-position: outside;
    }

    /* Text formatting */
    .rich-text-display strong,
    .rich-text-display b {
      font-weight: 700;
    }

    .rich-text-display em,
    .rich-text-display i {
      font-style: italic;
    }

    .rich-text-display u {
      text-decoration: underline;
    }

    .rich-text-display s,
    .rich-text-display strike {
      text-decoration: line-through;
    }

    /* Headings */
    .rich-text-display h1 {
      font-size: 2rem;
      font-weight: 700;
      margin: 1.5rem 0 1rem 0;
      color: #1f2937;
    }

    .rich-text-display h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 1.25rem 0 0.75rem 0;
      color: #1f2937;
    }

    .rich-text-display h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem 0;
      color: #374151;
    }

    .rich-text-display h4 {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0.75rem 0 0.5rem 0;
      color: #374151;
    }

    /* Paragraphs and spacing */
    .rich-text-display p {
      margin: 0.75rem 0;
    }

    .rich-text-display blockquote {
      border-left: 4px solid #d1d5db;
      padding-left: 1rem;
      margin: 1rem 0;
      font-style: italic;
      color: #6b7280;
    }

    /* Links */
    .rich-text-display a {
      color: #2563eb;
      text-decoration: underline;
    }

    .rich-text-display a:hover {
      color: #1d4ed8;
    }

    /* Alignment */
    .rich-text-display .text-align-left {
      text-align: left;
    }

    .rich-text-display .text-align-center {
      text-align: center;
    }

    .rich-text-display .text-align-right {
      text-align: right;
    }

    .rich-text-display .text-align-justify {
      text-align: justify;
    }

    /* Additional formatting support for pasted content */
    .rich-text-display .ck-widget {
      display: block;
    }

    /* Font sizes from external sources */
    .rich-text-display .text-tiny {
      font-size: 0.7em;
    }

    .rich-text-display .text-small {
      font-size: 0.85em;
    }

    .rich-text-display .text-big {
      font-size: 1.4em;
    }

    .rich-text-display .text-huge {
      font-size: 1.8em;
    }

    /* Background colors that might come from external sources */
    .rich-text-display .marker-yellow {
      background-color: #fdfd77;
    }

    .rich-text-display .marker-green {
      background-color: #63f963;
    }

    .rich-text-display .marker-pink {
      background-color: #fc7999;
    }

    .rich-text-display .marker-blue {
      background-color: #72cdfd;
    }

    .rich-text-display .pen-red {
      color: #e91e63;
    }

    .rich-text-display .pen-green {
      color: #00e676;
    }

    /* Preserve spacing and indentation from external sources */
    .rich-text-display pre {
      background-color: #f4f4f4;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 1rem;
      overflow-x: auto;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }

    .rich-text-display code {
      background-color: #f4f4f4;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    /* Preserve images from external sources */
    .rich-text-display img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin: 0.5rem 0;
    }

    /* Preserve div and span formatting from external sources */
    .rich-text-display div,
    .rich-text-display span {
      display: inherit;
      margin: inherit;
      padding: inherit;
      color: inherit;
      font-weight: inherit;
      font-style: inherit;
      text-decoration: inherit;
    }

    /* Support for Word-style formatting */
    .rich-text-display .MsoNormal {
      margin: 0;
      padding: 0;
    }

    /* Enhanced support for pasted list content from various sources */

    /* Word/Office list styles preservation */
    .ck-editor__editable .MsoListParagraph,
    .rich-text-display .MsoListParagraph {
      margin-left: 36pt;
      text-indent: -18pt;
    }

    /* Handle pasted content with style-based indentation */
    .ck-editor__editable p[style*="margin-left"],
    .rich-text-display p[style*="margin-left"] {
      margin-left: inherit;
      padding-left: inherit;
    }

    /* Convert margin-based indentation to proper list structure */
    .ck-editor__editable p[style*="margin-left: 36pt"],
    .ck-editor__editable p[style*="margin-left: 1in"],
    .ck-editor__editable p[style*="margin-left: 72px"] {
      /* First level indentation */
      padding-left: 2em;
    }

    .ck-editor__editable p[style*="margin-left: 72pt"],
    .ck-editor__editable p[style*="margin-left: 2in"],
    .ck-editor__editable p[style*="margin-left: 144px"] {
      /* Second level indentation */
      padding-left: 3.5em;
    }

    /* Handle Google Docs style lists */
    .ck-editor__editable .c0,
    .ck-editor__editable .c1,
    .ck-editor__editable .c2 {
      /* Google Docs list classes */
      display: list-item;
    }

    /* Handle HTML lists with inline styles */
    .ck-editor__editable ul[style],
    .ck-editor__editable ol[style] {
      /* Preserve inline styles from pasted content */
      list-style-position: outside !important;
    }

    /* Handle nested lists with specific margin/padding */
    .ck-editor__editable ul[style*="margin"],
    .ck-editor__editable ol[style*="margin"] {
      margin-top: 0.5em !important;
      margin-bottom: 0.5em !important;
    }

    /* Preserve list-style-type from pasted content */
    .ck-editor__editable ul[style*="list-style-type"],
    .ck-editor__editable ol[style*="list-style-type"] {
      list-style-type: inherit;
      list-style-position: outside;
    }

    /* Handle pasted content with text-indent (common in Word) */
    .ck-editor__editable li[style*="text-indent"],
    .rich-text-display li[style*="text-indent"] {
      text-indent: 0 !important;
      padding-left: 0.5em;
    }

    /* Preserve line breaks and spacing */
    .rich-text-display br {
      line-height: 1.6;
    }

    /* Additional CKEditor list fixes for proper hierarchy display */
    .ck-editor__editable {
      /* Ensure lists are properly styled */
      counter-reset: none;
    }

    /* Force proper list styling in CKEditor */
    .ck-editor__editable ul > li {
      list-style: disc outside;
      margin-left: 0;
      padding-left: 0;
    }

    .ck-editor__editable ul ul > li {
      list-style: circle outside;
      margin-left: 0;
      padding-left: 0;
    }

    .ck-editor__editable ul ul ul > li {
      list-style: square outside;
      margin-left: 0;
      padding-left: 0;
    }

    .ck-editor__editable ol > li {
      list-style: decimal outside;
      margin-left: 0;
      padding-left: 0;
    }

    .ck-editor__editable ol ol > li {
      list-style: lower-alpha outside;
      margin-left: 0;
      padding-left: 0;
    }

    .ck-editor__editable ol ol ol > li {
      list-style: lower-roman outside;
      margin-left: 0;
      padding-left: 0;
    }

    /* Ensure proper indentation is visible */
    .ck-editor__editable ul,
    .ck-editor__editable ol {
      margin-left: 0;
      padding-left: 2em !important;
    }

    .ck-editor__editable ul ul,
    .ck-editor__editable ol ol {
      margin-left: 0;
      padding-left: 1.5em !important;
    }

    .ck-editor__editable ul ul ul,
    .ck-editor__editable ol ol ol {
      margin-left: 0;
      padding-left: 1.5em !important;
    }

    /* Override any CKEditor theme that might be flattening lists */
    .ck-content ul,
    .ck-content ol {
      padding-left: 2em !important;
    }

    .ck-content ul ul,
    .ck-content ol ol {
      padding-left: 1.5em !important;
    }

    /* Ensure list items are properly displayed */
    .ck-content li {
      display: list-item !important;
      margin: 0.25em 0;
    }
    .survival-grid-container .jsgrid {
      min-width: 1200px;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Login Overlay -->
  <div id="loginOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md">
      <!-- Login Form -->
      <div id="loginSection">
        <h2 class="text-2xl font-semibold mb-6 text-center text-blue-900">Login to Dklinity</h2>
        <form id="loginForm" class="space-y-4" autocomplete="off" novalidate>
          <div>
            <label for="username" class="block font-medium mb-1">Username</label>
            <input type="text" id="username" name="username" required autocomplete="username" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="password" class="block font-medium mb-1">Password</label>
            <input type="password" id="password" name="password" required autocomplete="current-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div id="loginMessage" class="text-sm text-red-600 min-h-[1.25rem]"></div>
          <button type="submit" class="w-full bg-blue-900 text-white font-semibold rounded px-4 py-2 hover:bg-blue-800 transition">
            <i class="fas fa-sign-in-alt mr-2"></i> Login
          </button>
        </form>
        <div class="mt-4 text-center space-y-2">
          <button id="showCreateUserBtn" class="text-blue-600 hover:text-blue-800 underline text-sm">
            <i class="fas fa-user-plus mr-1"></i> Create New User Account
          </button>
          <br>
          <button id="createAdminBtn" class="text-green-600 hover:text-green-800 underline text-xs">
            <i class="fas fa-user-shield mr-1"></i> Initialize Admin User
          </button>
        </div>
      </div>

      <!-- Create User Form -->
      <div id="createUserSection" class="hidden">
        <h2 class="text-2xl font-semibold mb-6 text-center text-blue-900">Create New User Account</h2>
        <p class="text-sm text-gray-600 mb-4 text-center">Admin access required to create new users</p>
        <form id="createUserForm" class="space-y-4" autocomplete="off" novalidate>
          <div>
            <label for="fullName" class="block font-medium mb-1">Full Name</label>
            <input type="text" id="fullName" name="fullName" required autocomplete="off" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Enter full name" />
          </div>
          <div>
            <label for="email" class="block font-medium mb-1">Email (Optional)</label>
            <input type="email" id="email" name="email" autocomplete="off" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Enter email address" />
          </div>
          <div>
            <label for="newUsername" class="block font-medium mb-1">Username</label>
            <input type="text" id="newUsername" name="newUsername" required autocomplete="off" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Enter username" />
          </div>
          <div>
            <label for="newPassword" class="block font-medium mb-1">Password</label>
            <input type="password" id="newPassword" name="newPassword" required autocomplete="new-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Enter password (min 6 characters)" />
          </div>
          <div>
            <label for="confirmPassword" class="block font-medium mb-1">Confirm Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword" required autocomplete="new-password" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Confirm password" />
          </div>
          <div>
            <label for="userRole" class="block font-medium mb-1">Access Role</label>
            <select id="userRole" name="userRole" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Select Access Level</option>
              <option value="admin">Admin - Full access to all features</option>
              <option value="editor">Editor - Can view and edit data</option>
              <option value="viewer">Viewer - Read-only access</option>
            </select>
          </div>
          <div id="createUserMessage" class="text-sm text-red-600 min-h-[1.25rem]"></div>
          <button type="submit" class="w-full bg-green-600 text-white font-semibold rounded px-4 py-2 hover:bg-green-700 transition">
            <i class="fas fa-user-plus mr-2"></i> Create User Account
          </button>
        </form>
        <div class="mt-4 text-center">
          <button id="showLoginBtn" class="text-blue-600 hover:text-blue-800 underline text-sm">
            <i class="fas fa-arrow-left mr-1"></i> Back to Login
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="appContent" class="hidden flex flex-col min-h-screen">
    <header class="bg-blue-900 text-white shadow">
      <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row md:items-center md:justify-between">
        <h1 class="text-2xl font-semibold flex items-center gap-2 cursor-pointer" id="homeBtn">
          <i class="fas fa-database"></i> Dklinity
        </h1>
        <nav class="mt-3 md:mt-0">
          <ul class="flex flex-wrap gap-4 text-sm md:text-base items-center">
            <li><button id="searchTrialsBtn" class="hover:underline text-white">🔍 Search Trials</button></li>
            <li><button id="addTrialBtn" class="hover:underline text-white">➕ Add New Trial</button></li>
            <li>
              <button id="userManagementBtn" class="bg-purple-600 text-white font-semibold rounded px-3 py-1 hover:bg-purple-700 transition text-sm hidden">
                <i class="fas fa-users mr-1"></i> Manage Users
              </button>
            </li>
            <li>
              <button id="auditTrailBtn" class="bg-orange-600 text-white font-semibold rounded px-3 py-1 hover:bg-orange-700 transition text-sm hidden">
                <i class="fas fa-history mr-1"></i> Audit Trail
              </button>
            </li>
            <li>
              <span id="welcomeMessage" class="text-white text-sm font-medium px-3 py-1 bg-blue-800 rounded hidden">
                <i class="fas fa-user mr-1"></i> Welcome, <span id="currentUserName">User</span>
              </span>
            </li>
            <li>
              <button id="logoutBtn" aria-label="Logout" class="bg-red-600 text-white font-semibold rounded px-3 py-1 hover:bg-red-700 transition text-sm">
                <i class="fas fa-sign-out-alt mr-1"></i> Logout
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container mx-auto px-4 py-6 flex-grow">
      <!-- Trial Search Section -->
      <section id="search" class="mb-12">
        <!-- Professional Layout with Side Filter Panel -->
        <div class="flex gap-6">
          <!-- Left Side Filter Panel -->
          <div class="w-80 flex-shrink-0">
            <div class="bg-white rounded-lg shadow-lg border border-gray-200 sticky top-4">
              <!-- Filter Header -->
              <div class="bg-blue-900 text-white p-4 rounded-t-lg">
                <h3 class="text-lg font-semibold flex items-center">
                  <i class="fas fa-filter mr-2"></i> Advanced Filters
                </h3>
              </div>

              <!-- Filter Content -->
              <div class="p-4 space-y-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                <!-- Trial ID Filter -->
                <div class="filter-group">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-hashtag text-blue-600 mr-1"></i> Trial ID / Other Study ID
                  </label>
                  <input type="text" id="filterTrialId" placeholder="Enter Trial ID or Other Study ID"
                         class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Product Filter -->
                <div class="filter-group">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-pills text-green-600 mr-1"></i> Product/Drug
                  </label>
                  <select id="filterProduct" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Products</option>
                  </select>
                </div>

                <!-- Phase Filter -->
                <div class="filter-group">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-flask text-purple-600 mr-1"></i> Phase
                  </label>
                  <select id="filterPhase" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Phases</option>
                    <option value="Phase I">Phase I</option>
                    <option value="Phase I/II">Phase I/II</option>
                    <option value="Phase II">Phase II</option>
                    <option value="Phase II/III">Phase II/III</option>
                    <option value="Phase III">Phase III</option>
                    <option value="Phase IV">Phase IV</option>
                  </select>
                </div>

                <!-- Status Filter -->
                <div class="filter-group">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-chart-line text-orange-600 mr-1"></i> Status
                  </label>
                  <select id="filterStatus" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Statuses</option>
                    <option value="Recruiting">Recruiting</option>
                    <option value="Active">Active</option>
                    <option value="Completed">Completed</option>
                    <option value="Terminated">Terminated</option>
                    <option value="Suspended">Suspended</option>
                  </select>
                </div>

                <!-- Study Type Filter -->
                <div class="filter-group">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-microscope text-indigo-600 mr-1"></i> Study Type
                  </label>
                  <select id="filterStudyType" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Study Types</option>
                    <option value="Interventional">Interventional</option>
                    <option value="Observational">Observational</option>
                    <option value="Expanded Access">Expanded Access</option>
                  </select>
                </div>

                <!-- Sponsor Filter -->
                <div class="filter-group">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-building text-gray-600 mr-1"></i> Sponsor
                  </label>
                  <select id="filterSponsor" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Sponsors</option>
                  </select>
                </div>

                <!-- Indication Filter -->
                <div class="filter-group">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-heartbeat text-red-600 mr-1"></i> Indication
                  </label>
                  <select id="filterIndication" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Indications</option>
                  </select>
                </div>

                <!-- Admin Only Filters -->
                <div id="adminOnlyFilters" class="admin-only-section hidden">
                  <div class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="text-sm font-semibold text-gray-600 mb-3 flex items-center">
                      <i class="fas fa-user-shield text-yellow-600 mr-1"></i> Admin Filters
                    </h4>

                    <!-- Created By Filter (Admin Only) -->
                    <div class="filter-group mb-4">
                      <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-user-plus text-green-600 mr-1"></i> Created By
                      </label>
                      <select id="filterCreatedBy" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Users</option>
                      </select>
                    </div>

                    <!-- Last Updated By Filter (Admin Only) -->
                    <div class="filter-group">
                      <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-user-edit text-blue-600 mr-1"></i> Last Updated By
                      </label>
                      <select id="filterUpdatedBy" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Users</option>
                      </select>
                    </div>
                  </div>
                </div>



                <!-- Filter Actions -->
                <div class="border-t border-gray-200 pt-4 mt-4 space-y-2">
                  <button id="applyFiltersBtn" type="button" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm font-semibold transition flex items-center justify-center">
                    <i class="fas fa-filter mr-2"></i> Apply Filters
                  </button>
                  <button id="clearFiltersBtn" type="button" class="w-full bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 text-sm font-semibold transition flex items-center justify-center">
                    <i class="fas fa-times mr-2"></i> Clear All Filters
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Side Content Area -->
          <div class="flex-1 min-w-0">
            <div class="bg-white rounded-lg shadow-lg">
              <!-- Content Header -->
              <div class="bg-blue-900 px-6 py-4 rounded-t-lg">
                <h2 class="text-2xl font-semibold text-white flex items-center gap-3">
                  <i class="fas fa-database"></i> Trials
                </h2>
              </div>

              <!-- Professional Search Form -->
              <div class="p-6 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                  <i class="fas fa-search mr-2"></i> Search Trial
                </h3>
                <form id="trialSearchForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  <div>
                    <label for="searchTrialId" class="block text-sm font-medium text-gray-700 mb-1">Trial ID / Other Study ID</label>
                    <input type="text" id="searchTrialId" name="trial_id" placeholder="Enter Trial ID or Other Study ID" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                  </div>
                  <div>
                    <label for="searchTitle" class="block text-sm font-medium text-gray-700 mb-1">Title Keywords</label>
                    <input type="text" id="searchTitle" name="title" placeholder="Enter title keywords" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                  </div>
                  <div>
                    <label for="searchPhase" class="block text-sm font-medium text-gray-700 mb-1">Phase</label>
                    <select id="searchPhase" name="phase" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                      <option value="">All Phases</option>
                      <option value="Phase I">Phase I</option>
                      <option value="Phase II">Phase II</option>
                      <option value="Phase III">Phase III</option>
                      <option value="Phase IV">Phase IV</option>
                    </select>
                  </div>
                  <div>
                    <label for="searchStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="searchStatus" name="status" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                      <option value="">All Statuses</option>
                      <option value="Recruiting">Recruiting</option>
                      <option value="Active">Active</option>
                      <option value="Completed">Completed</option>
                      <option value="Terminated">Terminated</option>
                      <option value="Suspended">Suspended</option>
                    </select>
                  </div>
                  <div class="lg:col-span-4 flex gap-3">
                    <button type="submit" class="flex-1 bg-blue-600 text-white font-medium rounded-md px-4 py-2 hover:bg-blue-700 transition flex items-center justify-center">
                      <i class="fas fa-search mr-2"></i> Search
                    </button>
                    <button type="button" id="clearSearchForm" class="bg-gray-500 text-white font-medium rounded-md px-4 py-2 hover:bg-gray-600 transition flex items-center justify-center">
                      <i class="fas fa-times mr-2"></i> Clear
                    </button>
                  </div>
                </form>
              </div>

              <!-- Trials Table Container -->
              <div class="p-6">
                <!-- Search Results will be displayed here -->
                <div id="searchResults" class="min-h-[150px]">
                  <p class="text-gray-600 italic">Loading trials...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

      </section>

      <!-- Add Trial Section -->
      <section id="add-trial" class="mb-12">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-3xl font-semibold text-blue-900 flex items-center gap-3">
            <i class="fas fa-plus-circle"></i> Add New Trial
          </h2>
          <button id="backToSearchFromAddTrial" class="text-blue-600 hover:text-blue-800">
            <i class="fas fa-arrow-left mr-2"></i> Back to Search
          </button>
        </div>
        <form id="addTrialForm" class="bg-white p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl">
          <div class="md:col-span-2">
            <label for="trialId" class="block font-medium mb-1">Trial ID *</label>
            <input type="text" id="trialId" name="trial_id" required placeholder="Unique Trial ID (can include letters and numbers)" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2">
            <label class="block font-medium mb-1">Other Study ID(s)</label>
            <div id="addOtherStudyIdsContainer" class="space-y-2">
              <input type="text" name="other_study_id" placeholder="Other Study ID" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
            </div>
            <button type="button" id="addOtherStudyIdBtn" class="mt-2 text-blue-700 hover:underline text-sm flex items-center gap-1">
              <i class="fas fa-plus"></i> Add another Other Study ID
            </button>
          </div>
          <div class="md:col-span-2">
            <label class="block font-medium mb-1">Indication(s) *</label>
            <div id="addIndicationsContainer" class="space-y-2">
              <div class="indication-selector">
                <div class="relative">
                  <input type="text" name="indication_search" placeholder="Search or type indication..."
                         class="w-full border border-gray-300 rounded px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-600 indication-search-input" />
                  <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 dropdown-toggle">
                    <i class="fas fa-chevron-down"></i>
                  </button>
                  <div class="dropdown-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b max-h-40 overflow-y-auto shadow-lg">
                    <!-- Options will be loaded here -->
                  </div>
                </div>
                <input type="hidden" name="indication" required />
              </div>
            </div>
            <button type="button" id="addIndicationBtn" class="mt-2 text-green-600 hover:text-green-800 text-sm flex items-center gap-1">
              <i class="fas fa-plus"></i> Add another Indication
            </button>
          </div>
          <div>
            <label for="trialTitle" class="block font-medium mb-1">Title *</label>
            <input type="text" id="trialTitle" name="title" required placeholder="Trial title" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="trialEnrollment" class="block font-medium mb-1">Enrollment</label>
            <input type="number" id="trialEnrollment" name="enrollment" min="0" placeholder="Number of participants" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="trialPhase" class="block font-medium mb-1">Phase</label>
            <select id="trialPhase" name="phase" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Select phase</option>
              <option value="Phase 1">Phase 1</option>
              <option value="Phase 2">Phase 2</option>
              <option value="Phase 3">Phase 3</option>
              <option value="Phase 4">Phase 4</option>
            </select>
          </div>
          <div>
            <label for="trialStudyType" class="block font-medium mb-1">Study Type</label>
            <select id="trialStudyType" name="study_type" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Select study type</option>
              <option value="Interventional">Interventional</option>
              <option value="Observational">Observational</option>
              <option value="Expanded Access">Expanded Access</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label for="trialStatus" class="block font-medium mb-1">Status *</label>
            <select id="trialStatus" name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Select status</option>
              <option value="Recruiting">Recruiting</option>
              <option value="Active">Active</option>
              <option value="Completed">Completed</option>
              <option value="Terminated">Terminated</option>
              <option value="Suspended">Suspended</option>
            </select>
          </div>
          <div>
            <label for="trialSponsor" class="block font-medium mb-1">Sponsor</label>
            <input type="text" id="trialSponsor" name="sponsor" placeholder="Sponsor company name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2">
            <label class="block font-medium mb-1">Product Tags *</label>
            <div id="productTagsContainer" class="space-y-2">
              <div class="product-tag-selector">
                <div class="relative">
                  <input type="text" name="product_tag_search" placeholder="Search or type product name..."
                         class="w-full border border-gray-300 rounded px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-600 product-search-input" />
                  <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 dropdown-toggle">
                    <i class="fas fa-chevron-down"></i>
                  </button>
                  <div class="dropdown-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b max-h-40 overflow-y-auto shadow-lg">
                    <!-- Options will be loaded here -->
                  </div>
                </div>
                <input type="hidden" name="product_tag" required />
              </div>
            </div>
            <button type="button" id="addProductTagBtn" class="mt-2 text-green-600 hover:text-green-800 text-sm flex items-center gap-1">
              <i class="fas fa-plus"></i> Add another Product
            </button>
          </div>
          <div class="md:col-span-2">
            <label class="block font-medium mb-1">Biomarker(s)</label>
            <div id="addBiomarkersContainer" class="space-y-2">
              <input type="text" name="biomarker" placeholder="Biomarker name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
            </div>
            <button type="button" id="addBiomarkerBtn" class="mt-2 text-blue-700 hover:underline text-sm flex items-center gap-1">
              <i class="fas fa-plus"></i> Add another Biomarker
            </button>
          </div>
          <div>
            <label for="trialAllocation" class="block font-medium mb-1">Allocation</label>
            <select id="trialAllocation" name="allocation" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Select allocation</option>
              <option value="Randomized">Randomized</option>
              <option value="Non-Randomized">Non-Randomized</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label for="trialStartDate" class="block font-medium mb-1">Start Date</label>
            <input type="date" id="trialStartDate" name="start_date" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="trialEndDate" class="block font-medium mb-1">End Date</label>
            <input type="date" id="trialEndDate" name="end_date" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div class="md:col-span-2 flex justify-end gap-4">
            <button type="reset" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">
              Reset
            </button>
            <button type="submit" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
              <i class="fas fa-save mr-2"></i> Add Trial
            </button>
          </div>
        </form>
        <div id="addTrialMessage" class="mt-4 text-sm"></div>
      </section>

      <!-- Trial Details & Tabs Section (hidden initially) -->
      <section id="trialDetailsSection" class="hidden bg-white rounded-lg shadow-md p-6 max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-4">
          <div>
            <button id="backToSearchFromDetails" class="text-blue-600 hover:text-blue-800 mb-2">
              <i class="fas fa-arrow-left mr-2"></i> Back to Search
            </button>
            <h2 id="trialDetailsTitle" class="text-3xl font-semibold text-blue-900">
              Trial Details
            </h2>
          </div>
        </div>

        <!-- Trial summary moved to Summary tab -->

        <nav class="mb-6 border-b border-gray-400">
          <ul id="tabs" class="flex flex-wrap gap-2 text-sm font-semibold text-gray-700">
            <li><button data-tab="summary" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-blue-600 text-white">Summary</button></li>
            <li><button data-tab="products" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-gray-300 text-gray-700 hover:bg-gray-400 hover:text-white">ARMs</button></li>
            <li><button data-tab="patients" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-gray-300 text-gray-700 hover:bg-gray-400 hover:text-white">Patients</button></li>
            <li><button data-tab="outcome" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-gray-300 text-gray-700 hover:bg-gray-400 hover:text-white">Outcome Measures</button></li>
            <li><button data-tab="inclusion" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-gray-300 text-gray-700 hover:bg-gray-400 hover:text-white">Inclusion/Exclusion</button></li>
            <li><button data-tab="safetyAssessments" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-gray-300 text-gray-700 hover:bg-gray-400 hover:text-white">Safety Assessment</button></li>
            <li><button data-tab="responseAssessment" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-gray-300 text-gray-700 hover:bg-gray-400 hover:text-white">Response Assessment</button></li>
            <li><button data-tab="survivalData" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-gray-300 text-gray-700 hover:bg-gray-400 hover:text-white">Survival Data</button></li>
            <li><button data-tab="milestones" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-gray-300 text-gray-700 hover:bg-gray-400 hover:text-white">Milestones</button></li>
            <li><button data-tab="references" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-gray-300 text-gray-700 hover:bg-gray-400 hover:text-white">References</button></li>
            <li><button data-tab="commentary" class="tab-btn px-4 py-2 rounded-t border border-b-0 border-gray-400 bg-gray-300 text-gray-700 hover:bg-gray-400 hover:text-white">Commentary</button></li>
          </ul>
        </nav>

        <div id="tabContent" class="min-h-[400px]"></div>
      </section>
    </main>

    <footer class="bg-blue-900 text-white py-4 text-center text-sm">
      Dklinity &copy; 2025 Clinical Trials
    </footer>
  </div>

  <!-- Audit Trail Modal -->
  <div id="auditTrailModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-7xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold text-blue-900">Audit Trail & Activity Logs</h2>
        <button id="closeAuditTrailBtn" class="text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button>
      </div>

      <!-- Filter Controls -->
      <div class="mb-6 bg-gray-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold text-blue-800 mb-4">🔍 Search & Filter Audit Logs</h3>

        <!-- Search Bar -->
        <div class="mb-4">
          <label for="auditSearch" class="block font-medium mb-1">Search (Trial ID, User, Action, Entity)</label>
          <input type="text" id="auditSearch" placeholder="Search for trial ID, user name, action type, etc..."
                 class="w-full border border-gray-300 rounded px-3 py-2">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <div>
            <label for="auditLogType" class="block font-medium mb-1">Log Type</label>
            <select id="auditLogType" class="w-full border border-gray-300 rounded px-3 py-2">
              <option value="all">All Logs</option>
              <option value="audit_trail">Data Changes Only</option>
              <option value="user_activity">User Activity Only</option>
              <option value="error_logs">Error Logs Only</option>
            </select>
          </div>
          <div>
            <label for="auditAction" class="block font-medium mb-1">Action Type</label>
            <select id="auditAction" class="w-full border border-gray-300 rounded px-3 py-2">
              <option value="all">All Actions</option>
              <option value="CREATE">Created Data</option>
              <option value="UPDATE">Updated Data</option>
              <option value="DELETE">Deleted Data</option>
            </select>
          </div>
          <div>
            <label for="auditEntity" class="block font-medium mb-1">Data Type</label>
            <select id="auditEntity" class="w-full border border-gray-300 rounded px-3 py-2">
              <option value="all">All Data Types</option>
              <option value="trial">Clinical Trials</option>
              <option value="arm">Trial ARMs</option>
              <option value="demographics">Demographics</option>
              <option value="outcome">Outcomes</option>
              <option value="safety">Safety Data</option>
              <option value="response">Response Data</option>
              <option value="survival_main">Survival Data</option>
              <option value="milestone">Milestones</option>
            </select>
          </div>
          <div>
            <label for="auditUser" class="block font-medium mb-1">User</label>
            <select id="auditUser" class="w-full border border-gray-300 rounded px-3 py-2">
              <option value="all">All Users</option>
            </select>
          </div>
          <div>
            <label for="auditTrialId" class="block font-medium mb-1">Trial ID</label>
            <input type="text" id="auditTrialId" placeholder="Enter Trial ID"
                   class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div>
            <label for="auditDateFrom" class="block font-medium mb-1">From Date</label>
            <input type="date" id="auditDateFrom" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
          <div>
            <label for="auditDateTo" class="block font-medium mb-1">To Date</label>
            <input type="date" id="auditDateTo" class="w-full border border-gray-300 rounded px-3 py-2">
          </div>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
          <button id="applyAuditFilters" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            <i class="fas fa-search mr-2"></i> Search & Filter
          </button>
          <button id="clearAuditFilters" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
            <i class="fas fa-times mr-2"></i> Clear All
          </button>
          <button id="showRecentChanges" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">
            <i class="fas fa-clock mr-2"></i> Recent Changes
          </button>
          <button id="exportAuditData" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            <i class="fas fa-download mr-2"></i> Export CSV
          </button>
          <button id="testAuditLogging" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
            <i class="fas fa-flask mr-2"></i> Test System
          </button>
        </div>
      </div>

      <!-- Enhanced Dropdown Management Section -->
      <div id="dropdownManagementSection" class="mb-8 bg-blue-50 p-6 rounded-lg shadow-md">
        <h3 class="text-xl font-semibold text-blue-900 mb-4">
          <i class="fas fa-list mr-2"></i>Enhanced Dropdown Management
        </h3>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Dropdown Category Selection -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h4 class="text-lg font-semibold text-gray-800 mb-3">Select Dropdown Category</h4>
            <select id="dropdownCategory" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600 mb-4">
              <option value="">Select Category</option>
              <optgroup label="Trial Management">
                <option value="phases">Trial Phases</option>
                <option value="statuses">Trial Statuses</option>
                <option value="study_types">Study Types</option>
                <option value="allocations">Allocations</option>
              </optgroup>
              <optgroup label="Products & Indications">
                <option value="product_list">Product List</option>
                <option value="indications_list">Indications List</option>
              </optgroup>
              <optgroup label="ARM & Response">
                <option value="arm_types">ARM Types</option>
                <option value="response_types">Response Types</option>
                <option value="duration_formats">Duration Formats</option>
                <option value="assessment_types">Assessment Types</option>
              </optgroup>
              <optgroup label="Survival & Endpoints">
                <option value="survival_endpoints">Survival Endpoints</option>
                <option value="mfu_units">MFU Units</option>
              </optgroup>
              <optgroup label="Milestones">
                <option value="milestone_events">Milestone Events</option>
                <option value="milestone_statuses">Milestone Statuses</option>
                <option value="active_statuses">Active Statuses</option>
              </optgroup>
              <optgroup label="System">
                <option value="user_roles">User Roles</option>
              </optgroup>
            </select>

            <!-- Search Options -->
            <div class="mb-4">
              <label for="optionsSearch" class="block font-medium mb-1">Search Options</label>
              <input type="text" id="optionsSearch" placeholder="Search existing options..."
                     class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
            </div>

            <div id="currentOptions" class="mt-4">
              <h5 class="font-medium text-gray-700 mb-2">Current Options:</h5>
              <div id="optionsList" class="space-y-2 max-h-60 overflow-y-auto">
                <p class="text-gray-500 italic">Select a category to view options</p>
              </div>
            </div>
          </div>

          <!-- Add New Option -->
          <div class="bg-white p-4 rounded-lg shadow">
            <h4 class="text-lg font-semibold text-gray-800 mb-3">Add New Option</h4>
            <form id="addDropdownOptionForm">
              <div class="mb-4">
                <label for="newOptionValue" class="block font-medium mb-1">Option Value *</label>
                <input type="text" id="newOptionValue" name="value" required
                       placeholder="Enter option value"
                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              </div>

              <!-- Synonyms field - only show for product_list -->
              <div id="synonymsField" class="mb-4 hidden">
                <label for="newOptionSynonyms" class="block font-medium mb-1">Synonyms (Optional)</label>
                <textarea id="newOptionSynonyms" name="synonyms" rows="2"
                          placeholder="Enter synonyms separated by commas (e.g., Drug A, Compound X, ABC-123)"
                          class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"></textarea>
                <small class="text-gray-500">Synonyms help users find this product with different search terms</small>
              </div>

              <button type="submit" class="w-full bg-green-700 text-white font-semibold rounded px-4 py-2 hover:bg-green-600 transition">
                <i class="fas fa-plus mr-2"></i>Add Option
              </button>
            </form>

            <div id="dropdownMessage" class="mt-4 text-sm"></div>
          </div>
        </div>
      </div>

      <!-- Audit Logs Display -->
      <div id="auditLogsContainer">
        <div class="text-center py-8">
          <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
          <p class="text-gray-500 mt-2">Loading audit logs...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- User Management Modal -->
  <div id="userManagementModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-semibold text-blue-900">User Management</h2>
        <button id="closeUserManagementBtn" class="text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button>
      </div>

      <!-- Create New User Section -->
      <div class="mb-8 bg-gray-50 p-4 rounded-lg">
        <h3 class="text-lg font-semibold text-blue-800 mb-4">Create New User</h3>
        <form id="adminCreateUserForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="adminFullName" class="block font-medium mb-1">Full Name</label>
            <input type="text" id="adminFullName" name="fullName" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="adminEmail" class="block font-medium mb-1">Email</label>
            <input type="email" id="adminEmail" name="email" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="adminUsername" class="block font-medium mb-1">Username</label>
            <input type="text" id="adminUsername" name="username" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="adminPassword" class="block font-medium mb-1">Password</label>
            <input type="password" id="adminPassword" name="password" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
          </div>
          <div>
            <label for="adminRole" class="block font-medium mb-1">Role</label>
            <select id="adminRole" name="role" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
              <option value="">Select Role</option>
              <option value="admin">Admin</option>
              <option value="editor">Editor</option>
              <option value="viewer">Viewer</option>
            </select>
          </div>
          <div class="flex items-end">
            <button type="submit" class="bg-green-600 text-white font-semibold rounded px-4 py-2 hover:bg-green-700 transition">
              <i class="fas fa-user-plus mr-2"></i> Create User
            </button>
          </div>
          <div id="adminCreateUserMessage" class="md:col-span-2 text-sm min-h-[1.25rem]"></div>
        </form>
      </div>

      <!-- Users List Section -->
      <div>
        <h3 class="text-lg font-semibold text-blue-800 mb-4">Existing Users</h3>
        <div id="usersListContainer" class="overflow-x-auto">
          <table class="min-w-full border-collapse border border-gray-300 text-sm">
            <thead class="bg-blue-900 text-white">
              <tr>
                <th class="px-3 py-2 text-left border border-gray-300">Full Name</th>
                <th class="px-3 py-2 text-left border border-gray-300">Username</th>
                <th class="px-3 py-2 text-left border border-gray-300">Email</th>
                <th class="px-3 py-2 text-left border border-gray-300">Role</th>
                <th class="px-3 py-2 text-left border border-gray-300">Status</th>
                <th class="px-3 py-2 text-left border border-gray-300">Last Login</th>
                <th class="px-3 py-2 text-left border border-gray-300">Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- Users will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // In-memory data storage simulation
    const trials = [];
    const products = [];
    const patients = [];
    const adverseEvents = [];
    const responseData = [];
    const survivalData = [];
    const regulatoryEvents = [];
    const references = []; // unified references for all tabs
    const trial_products = [];

    // === Firebase Config ===
    // TODO: Replace with your own Firebase project config
    const firebaseConfig = {
      apiKey: "AIzaSyAbqH9HAqyhYQoKyXz98NiFeR5J4_MMrC8",
      authDomain: "dklinity-e7007.firebaseapp.com",
      projectId: "dklinity-e7007",
      storageBucket: "dklinity-e7007.appspot.com",
      messagingSenderId: "337796630433",
      appId: "1:337796630433:web:7216fface5e385c3acade0",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // CKEditor Configuration
    const ckEditorConfig = {
      toolbar: [
        'heading', '|',
        'bold', 'italic', 'underline', 'strikethrough', '|',
        'bulletedList', 'numberedList', 'outdent', 'indent', '|',
        'blockQuote', 'insertTable', 'undo', 'redo', '|',
        'alignment', 'fontColor', 'fontBackgroundColor', '|',
        'link', 'removeFormat', '|',
        'pasteFromOffice'
      ],
      // Font configuration for consistency
      fontSize: {
        options: [
          'default',
          '12px',
          '14px',
          '16px',
          '18px',
          '20px'
        ],
        supportAllValues: false
      },
      fontFamily: {
        options: [
          'default',
          'Arial, sans-serif',
          'Times New Roman, serif',
          'Courier New, monospace'
        ],
        supportAllValues: false
      },
      table: {
        contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells', 'tableProperties', 'tableCellProperties']
      },
      list: {
        properties: {
          styles: true,
          startIndex: true,
          reversed: true
        }
      },
      heading: {
        options: [
          { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
          { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
          { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
          { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
          { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' }
        ]
      },
      // Enhanced paste configuration for font consistency
      clipboard: {
        // Process pasted content to normalize fonts
        preventDefaultPasteContent: false,
        // Filter content to maintain consistency
        allowedContent: true
      },
      // Paste from Office configuration with font normalization
      pasteFromOffice: {
        // Preserve tables from Word/Excel
        preserveTables: true,
        // Preserve lists formatting and hierarchy
        preserveLists: true,
        // Normalize text formatting while preserving structure
        preserveStyles: false, // Changed to false to normalize fonts
        // Preserve list indentation and nesting
        preserveListIndentation: true,
        // Remove font family and size from pasted content
        removeFontStyles: true
      },
      // Enhanced HTML filter to preserve list hierarchy
      htmlSupport: {
        allow: [
          {
            name: /^(ul|ol|li)$/,
            attributes: true,
            classes: true,
            styles: true
          },
          {
            name: /^(p|div|span)$/,
            attributes: true,
            classes: true,
            styles: true
          }
        ]
      },
      // Allow all HTML content for maximum compatibility
      allowedContent: true,
      // Disable content filtering to preserve original formatting
      disallowedContent: '',
      // Enable keyboard shortcuts
      keystrokes: [
        ['Ctrl+B', 'bold'],
        ['Ctrl+I', 'italic'],
        ['Ctrl+U', 'underline'],
        ['Ctrl+Z', 'undo'],
        ['Ctrl+Y', 'redo'],
        ['Ctrl+Shift+Z', 'redo'],
        ['Tab', 'indent'],
        ['Shift+Tab', 'outdent'],
        ['Ctrl+V', 'paste']
      ]
    };

    // CKEditor instances storage
    const ckEditorInstances = {};

    // Helper function to create CKEditor instance
    async function createCKEditor(elementId, initialData = '') {
      try {
        const element = document.getElementById(elementId);
        if (!element) {
          console.error(`Element with ID ${elementId} not found`);
          return null;
        }

        // If instance already exists, destroy it first
        if (ckEditorInstances[elementId]) {
          await ckEditorInstances[elementId].destroy();
          delete ckEditorInstances[elementId];
        }

        const editor = await ClassicEditor.create(element, ckEditorConfig);
        if (initialData) {
          editor.setData(initialData);
        }

        // Enhanced paste event handler to normalize fonts and preserve formatting
        editor.editing.view.document.on('paste', (evt, data) => {
          // Process pasted content after a short delay to allow CKEditor to process it first
          setTimeout(() => {
            processListHierarchy(editor);
            normalizePastedContent(editor);
          }, 200);

          // Also normalize after a longer delay to catch any delayed content
          setTimeout(() => {
            normalizePastedContent(editor);
          }, 1000);
        });

        // Add input event listener to continuously normalize content
        editor.editing.view.document.on('input', (evt, data) => {
          // Debounce the normalization to avoid performance issues
          clearTimeout(editor._fontNormalizationTimeout);
          editor._fontNormalizationTimeout = setTimeout(() => {
            normalizePastedContent(editor);
          }, 500);
        });

        // Handle input events to maintain list hierarchy
        editor.editing.view.document.on('input', (evt, data) => {
          if (data.inputType === 'insertFromPaste') {
            setTimeout(() => {
              processListHierarchy(editor);
            }, 100);
          }
        });

        ckEditorInstances[elementId] = editor;
        return editor;
      } catch (error) {
        console.error('Error creating CKEditor:', error);
        return null;
      }
    }

    // Function to normalize pasted content fonts and fix formatting
    function normalizePastedContent(editor) {
      try {
        const model = editor.model;
        const root = model.document.getRoot();

        model.change(writer => {
          // Walk through all content in the editor
          const walker = model.createRangeIn(root).getWalker({
            ignoreElementEnd: true
          });

          for (const value of walker) {
            if (value.item.is('$text')) {
              const textNode = value.item;

              // Remove font family and font size attributes to normalize
              if (textNode.hasAttribute('fontFamily')) {
                writer.removeAttribute('fontFamily', textNode);
              }
              if (textNode.hasAttribute('fontSize')) {
                writer.removeAttribute('fontSize', textNode);
              }

              // Ensure italic formatting is properly applied
              if (textNode.hasAttribute('italic') || textNode.hasAttribute('fontStyle')) {
                writer.removeAttribute('fontStyle', textNode);
                writer.setAttribute('italic', true, textNode);
              }

              // Ensure bold formatting is properly applied
              if (textNode.hasAttribute('bold') || textNode.hasAttribute('fontWeight')) {
                writer.removeAttribute('fontWeight', textNode);
                writer.setAttribute('bold', true, textNode);
              }
            } else if (value.item.is('element')) {
              const element = value.item;

              // Remove font-related styles from elements
              if (element.hasAttribute('style')) {
                const style = element.getAttribute('style');
                if (style) {
                  // Remove font-family, font-size, and other font-related styles
                  const cleanStyle = style
                    .replace(/font-family[^;]*;?/gi, '')
                    .replace(/font-size[^;]*;?/gi, '')
                    .replace(/font-weight[^;]*;?/gi, '')
                    .replace(/font-style[^;]*;?/gi, '')
                    .replace(/;\s*;/g, ';')
                    .replace(/^;|;$/g, '')
                    .trim();

                  if (cleanStyle) {
                    writer.setAttribute('style', cleanStyle, element);
                  } else {
                    writer.removeAttribute('style', element);
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.log('Font normalization completed with minor issues:', error);
      }
    }

    // Function to process and fix list hierarchy after paste
    function processListHierarchy(editor) {
      try {
        const model = editor.model;
        const root = model.document.getRoot();

        model.change(writer => {
          // Find all paragraphs that might be converted list items
          const walker = model.createRangeIn(root).getWalker();

          for (const value of walker) {
            const item = value.item;

            // Check for paragraphs with list-like content
            if (item.is('element', 'paragraph')) {
              const text = item.getChild(0);
              if (text && text.is('$text')) {
                const textContent = text.data.trim();

                // Check for bullet-like patterns
                const bulletPatterns = [
                  /^[•·▪▫◦‣⁃]\s+/,  // Various bullet symbols
                  /^[-*+]\s+/,       // Dash, asterisk, plus
                  /^\d+\.\s+/,       // Numbered lists
                  /^[a-z]\.\s+/,     // Lettered lists
                  /^[ivx]+\.\s+/i    // Roman numerals
                ];

                for (const pattern of bulletPatterns) {
                  if (pattern.test(textContent)) {
                    // Convert to list item
                    const listType = /^\d+\./.test(textContent) ? 'numbered' : 'bulleted';
                    const cleanText = textContent.replace(pattern, '');

                    // Determine indent level based on leading spaces or content
                    let indent = 0;
                    const leadingSpaces = textContent.match(/^\s*/)[0].length;
                    if (leadingSpaces > 10) indent = 2;
                    else if (leadingSpaces > 5) indent = 1;

                    // Create list item
                    const listItem = writer.createElement('listItem', {
                      listType: listType,
                      listIndent: indent
                    });

                    writer.insertText(cleanText, listItem);
                    writer.replace(item, listItem);
                    break;
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.log('List hierarchy processing completed');
      }
    }

    // Helper function to get CKEditor data
    function getCKEditorData(elementId) {
      const editor = ckEditorInstances[elementId];
      return editor ? editor.getData() : '';
    }

    // Helper function to set CKEditor data
    function setCKEditorData(elementId, data) {
      const editor = ckEditorInstances[elementId];
      if (editor) {
        editor.setData(data || '');
      }
    }

    // Helper function to destroy CKEditor instance
    async function destroyCKEditor(elementId) {
      if (ckEditorInstances[elementId]) {
        await ckEditorInstances[elementId].destroy();
        delete ckEditorInstances[elementId];
      }
    }

    // Helper function to cleanup all CKEditor instances
    async function cleanupAllCKEditorInstances() {
      try {
        const instanceIds = Object.keys(ckEditorInstances);
        for (const elementId of instanceIds) {
          await destroyCKEditor(elementId);
        }
      } catch (error) {
        console.error('Error cleaning up CKEditor instances:', error);
      }
    }

    // Login credentials
    // Initialize Firestore user management system
    async function initializeUserSystem() {
      try {
        console.log('Initializing user system...');

        // Check if default admin user exists in Firestore
        const usersRef = db.collection('users');
        const adminQuery = usersRef.where('username', '==', 'Dilip');
        const adminSnapshot = await adminQuery.get();

        if (adminSnapshot.empty) {
          // Create default admin user in Firestore
          const defaultAdmin = {
            username: 'Dilip',
            password: 'Dilip@321',
            role: 'admin',
            fullName: 'Dilip Admin',
            email: 'dilip@dklinity.com',
            createdAt: new Date().toISOString(),
            createdBy: 'system',
            isActive: true,
            lastLogin: null
          };

          const docRef = await usersRef.add(defaultAdmin);
          console.log('Default admin user created in Firestore with ID:', docRef.id);
        } else {
          console.log('Default admin user already exists in Firestore');
        }

        // Verify the admin user exists
        const verifyQuery = usersRef.where('username', '==', 'Dilip');
        const verifySnapshot = await verifyQuery.get();
        if (!verifySnapshot.empty) {
          const adminUser = verifySnapshot.docs[0].data();
          console.log('Admin user verified:', adminUser.username, adminUser.role);
        }

      } catch (error) {
        console.error('Error initializing user system:', error);
        // Fallback: Show error message to user
        alert('Error initializing user system. Please refresh the page and try again.');
      }
    }

    // Get all users from Firestore
    async function getUsers() {
      try {
        const usersRef = db.collection('users');
        const snapshot = await usersRef.get();
        const users = [];

        snapshot.forEach(doc => {
          users.push({
            id: doc.id,
            ...doc.data()
          });
        });

        return users;
      } catch (error) {
        console.error('Error getting users:', error);
        return [];
      }
    }

    // Validate user credentials against Firestore
    async function validateUser(username, password) {
      try {
        console.log('Attempting to validate user:', username);

        const usersRef = db.collection('users');

        // First, let's check if any users exist
        const allUsersSnapshot = await usersRef.get();
        console.log('Total users in database:', allUsersSnapshot.size);

        // Check for the specific user
        const userQuery = usersRef
          .where('username', '==', username)
          .where('password', '==', password)
          .where('isActive', '==', true);
        const snapshot = await userQuery.get();

        console.log('Query results for user:', snapshot.size, 'documents found');

        if (!snapshot.empty) {
          const userDoc = snapshot.docs[0];
          const userData = {
            id: userDoc.id,
            ...userDoc.data()
          };
          console.log('User validation successful:', userData.username, userData.role);
          return userData;
        }

        // If no exact match, let's check if user exists with different password
        const usernameOnlyQuery = usersRef.where('username', '==', username);
        const usernameSnapshot = await usernameOnlyQuery.get();

        if (!usernameSnapshot.empty) {
          console.log('User exists but password mismatch');
        } else {
          console.log('User does not exist in database');
        }

        return null;
      } catch (error) {
        console.error('Error validating user:', error);
        return null;
      }
    }

    // Create new user in Firestore (Admin only)
    async function createUser(username, password, role, fullName, email, createdByUserId) {
      try {
        // Check if username already exists
        const usersRef = db.collection('users');
        const existingUserQuery = usersRef.where('username', '==', username);
        const existingUserSnapshot = await existingUserQuery.get();

        if (!existingUserSnapshot.empty) {
          return { success: false, message: 'Username already exists' };
        }

        // Check if email already exists (if provided)
        if (email) {
          const emailQuery = usersRef.where('email', '==', email);
          const emailSnapshot = await emailQuery.get();

          if (!emailSnapshot.empty) {
            return { success: false, message: 'Email already exists' };
          }
        }

        // Create new user document
        const newUser = {
          username: username,
          password: password, // In production, this should be hashed
          role: role,
          fullName: fullName || '',
          email: email || '',
          createdAt: new Date().toISOString(),
          createdBy: createdByUserId,
          isActive: true,
          lastLogin: null
        };

        const docRef = await usersRef.add(newUser);
        console.log('User created with ID:', docRef.id);

        return { success: true, message: 'User created successfully', userId: docRef.id };
      } catch (error) {
        console.error('Error creating user:', error);
        return { success: false, message: 'Error creating user: ' + error.message };
      }
    }

    // Update user's last login time
    async function updateLastLogin(userId) {
      try {
        const userRef = db.collection('users').doc(userId);
        await userRef.update({
          lastLogin: new Date().toISOString()
        });
      } catch (error) {
        console.error('Error updating last login:', error);
      }
    }

    // Deactivate user (Admin only)
    async function deactivateUser(userId) {
      try {
        const userRef = db.collection('users').doc(userId);
        await userRef.update({
          isActive: false,
          deactivatedAt: new Date().toISOString()
        });
        return { success: true, message: 'User deactivated successfully' };
      } catch (error) {
        console.error('Error deactivating user:', error);
        return { success: false, message: 'Error deactivating user: ' + error.message };
      }
    }

    // Check if current user is admin
    function isCurrentUserAdmin() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      return currentUser.role === 'admin';
    }

    // Debug function to list all users
    async function debugListAllUsers() {
      try {
        const usersRef = db.collection('users');
        const snapshot = await usersRef.get();
        console.log('=== ALL USERS IN DATABASE ===');
        snapshot.forEach(doc => {
          const userData = doc.data();
          console.log(`ID: ${doc.id}, Username: ${userData.username}, Role: ${userData.role}, Active: ${userData.isActive}`);
        });
        console.log('=== END USER LIST ===');
      } catch (error) {
        console.error('Error listing users:', error);
      }
    }

    // Add debug function to window for manual testing
    window.debugListAllUsers = debugListAllUsers;

    // Simple Page Navigation System - No changes to existing functionality
    function showPage(pageId) {
      console.log(`📱 showPage called with pageId: ${pageId}`);

      // Hide all main sections
      const searchSection = document.getElementById('search');
      const addTrialSection = document.getElementById('add-trial');
      const trialDetailsSection = document.getElementById('trialDetailsSection');

      console.log('📱 Found sections:', {
        search: !!searchSection,
        addTrial: !!addTrialSection,
        trialDetails: !!trialDetailsSection
      });

      if (searchSection) searchSection.style.display = 'none';
      if (addTrialSection) addTrialSection.style.display = 'none';
      if (trialDetailsSection) {
        trialDetailsSection.style.display = 'none';
        trialDetailsSection.classList.add('hidden');
      }

      // Show the requested section
      if (pageId === 'search') {
        if (searchSection) {
          searchSection.style.display = 'block';
          console.log('✅ Search section shown');
        }
      } else if (pageId === 'add-trial') {
        if (addTrialSection) {
          addTrialSection.style.display = 'block';
          console.log('✅ Add trial section shown');
        } else {
          console.log('❌ Add trial section not found!');
        }
      } else if (pageId === 'trial-details') {
        if (trialDetailsSection) {
          trialDetailsSection.style.display = 'block';
          trialDetailsSection.classList.remove('hidden');
          console.log('✅ Trial details section shown');
        }
      }

      console.log(`✅ Navigated to page: ${pageId}`);
    }

    // Show search page (default landing page)
    function showSearchPage() {
      console.log('🔍 showSearchPage called');
      showPage('search');
      // Load all trials by default
      setTimeout(() => {
        loadAllTrialsInSearch();
      }, 500);
    }

    // Show add trial page
    function showAddTrialPage() {
      console.log('📝 showAddTrialPage called');
      showPage('add-trial');
    }

    // Show trial details page
    function showTrialDetailsPage(trialId) {
      showPage('trial-details');
      // Use existing functionality to load trial details
      if (trialId) {
        // Use the existing loadTrialDetails function if available
        if (window.loadTrialDetails) {
          window.loadTrialDetails(trialId);
        } else {
          // Fallback: trigger the existing trial details loading
          setTimeout(() => {
            const event = new CustomEvent('loadTrialDetails', { detail: { trialId: trialId } });
            document.dispatchEvent(event);
          }, 100);
        }
      }
    }

    // Load all trials in search results by default
    function loadAllTrialsInSearch() {
      console.log('📊 Loading all trials in search...');
      const resultsContainer = document.getElementById('searchResults');
      if (!resultsContainer) {
        console.log('❌ Search results container not found');
        return;
      }

      resultsContainer.innerHTML = '<p class="text-gray-600 italic">Loading all trials...</p>';

      // Fetch all trials from Firestore
      db.collection('trials').orderBy('created_at', 'desc').get().then(async querySnapshot => {
        const trialsFromFirestore = [];
        querySnapshot.forEach(doc => {
          trialsFromFirestore.push(doc.data());
        });

        console.log(`📊 Found ${trialsFromFirestore.length} trials`);

        if (trialsFromFirestore.length === 0) {
          resultsContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-flask text-2xl"></i>
              <p class="mt-2">No trials found in database.</p>
              <p class="text-sm mt-1">Add your first trial to get started!</p>
            </div>
          `;
          return;
        }

        // Populate filter dropdowns
        populateFilterDropdowns(trialsFromFirestore);

        // Display all trials using the same format as search results
        await displayTrialsInTable(trialsFromFirestore, resultsContainer);

        // Setup filter event listeners
        setupFilterEventListeners();

        // Show admin filters if user is admin
        showAdminFiltersIfAdmin();

        // Setup search form clear button
        setupSearchFormClear();

      }).catch(error => {
        console.error('❌ Error loading trials:', error);
        resultsContainer.innerHTML = `
          <div class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-triangle text-2xl"></i>
            <p class="mt-2">Error loading trials: ${error.message}</p>
          </div>
        `;
      });
    }

    // Display trials in table format (reusable function)
    async function displayTrialsInTable(trials, container) {
      let html = `
        <div class="mb-4 flex justify-between items-center">
          <h4 class="text-lg font-semibold text-blue-800">📊 Clinical Trials (${trials.length} trials)</h4>
          <div class="text-sm text-gray-600">
            <button id="refreshTrialsList" class="text-blue-600 hover:text-blue-800">
              <i class="fas fa-refresh mr-1"></i> Refresh
            </button>
          </div>
        </div>
        <div class="overflow-x-auto max-h-96 scrollbar-thin border border-gray-300 rounded">
          <table class="min-w-full border-collapse border border-gray-300 text-sm">
            <thead class="bg-blue-900 text-white sticky top-0">
              <tr>
                <th class="px-2 py-1 text-left">Trial ID</th>
                <th class="px-2 py-1 text-left">Other Study ID(s)</th>
                <th class="px-2 py-1 text-left">Title</th>
                <th class="px-2 py-1 text-left">Indication(s)</th>
                <th class="px-2 py-1 text-left">Enrollment</th>
                <th class="px-2 py-1 text-left">Phase</th>
                <th class="px-2 py-1 text-left">Study Type</th>
                <th class="px-2 py-1 text-left">Status</th>
                <th class="px-2 py-1 text-left">Sponsor</th>
                <th class="px-2 py-1 text-left">Product Tags</th>
                <th class="px-2 py-1 text-left">Allocation</th>
                <th class="px-2 py-1 text-left">Start Date</th>
                <th class="px-2 py-1 text-left">End Date</th>
                <th class="px-2 py-1 text-left">Commentary</th>
                <th class="px-2 py-1 text-left">Created</th>
                <th class="px-2 py-1 text-left">Last Updated</th>
                <th class="px-2 py-1 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
      `;

      // Fetch latest commentary for all trials (doesn't affect existing data)
      const commentaryMap = new Map();
      try {
        const commentarySnapshot = await db.collection('trial_commentary').get();
        const allComments = [];
        commentarySnapshot.forEach(doc => {
          const data = doc.data();
          allComments.push(data);
        });

        // Sort by created_at and get the latest comment for each trial
        allComments.sort((a, b) => {
          const dateA = new Date(a.created_at || 0);
          const dateB = new Date(b.created_at || 0);
          return dateB - dateA;
        });

        // Map latest comment for each trial
        allComments.forEach(comment => {
          if (!commentaryMap.has(comment.trial_id)) {
            commentaryMap.set(comment.trial_id, comment);
          }
        });
      } catch (error) {
        console.log('Commentary collection not found or empty, this is normal for new installations:', error.message);
        // This is expected for new installations - collection will be created when first comment is added
      }

      for (const [index, trial] of trials.entries()) {
        const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        const title = trial.title && trial.title.length > 30 ? trial.title.substring(0, 30) + '...' : trial.title || '';
        const indication = trial.indication && Array.isArray(trial.indication) ? trial.indication.join(', ') : '';
        const indicationDisplay = indication.length > 20 ? indication.substring(0, 20) + '...' : indication;
        const sponsor = trial.sponsor && trial.sponsor.length > 15 ? trial.sponsor.substring(0, 15) + '...' : trial.sponsor || '';
        const productTags = trial.product_tags && trial.product_tags.length ? trial.product_tags.join(', ') : '';
        const productTagsDisplay = productTags.length > 20 ? productTags.substring(0, 20) + '...' : productTags;

        // Get latest commentary for this trial
        const latestComment = commentaryMap.get(trial.id);
        let commentaryDisplay = '';
        if (latestComment) {
          const commentText = latestComment.comment_text || '';
          const commentBy = latestComment.created_by_user || 'Unknown';
          const commentDate = latestComment.created_at ? new Date(latestComment.created_at).toLocaleDateString() : '';

          // Get first line only for table display
          const firstLine = commentText.split('\n')[0];
          const truncatedText = firstLine.length > 30 ? firstLine.substring(0, 30) + '...' : firstLine;

          commentaryDisplay = `
            <div class="text-xs relative group">
              <div class="text-gray-700 cursor-pointer truncate">${truncatedText}</div>
              <div class="absolute top-full left-0 mt-1 bg-black text-white text-xs rounded px-1 py-0.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 max-w-48 whitespace-pre-wrap shadow-md">
                <div class="font-medium text-yellow-300 text-xs">${commentBy} • ${commentDate}</div>
                <div class="text-xs">${commentText}</div>
              </div>
            </div>
          `;
        } else {
          commentaryDisplay = '<span class="text-gray-400 text-xs italic">No comments</span>';
        }

        html += `<tr class="${rowClass} hover:bg-blue-100 border-t border-gray-200" tabindex="0" aria-label="View or edit trial ${trial.id}">
          <td class="px-2 py-1 font-semibold text-blue-900">${trial.id}</td>
          <td class="px-2 py-1" title="${trial.other_study_id && Array.isArray(trial.other_study_id) ? trial.other_study_id.join(', ') : ''}">${trial.other_study_id && Array.isArray(trial.other_study_id) ? trial.other_study_id.join(', ') : ''}</td>
          <td class="px-2 py-1" title="${trial.title || ''}">${title}</td>
          <td class="px-2 py-1" title="${indication}">${indicationDisplay}</td>
          <td class="px-2 py-1">${trial.enrollment !== null && trial.enrollment !== undefined ? trial.enrollment : ''}</td>
          <td class="px-2 py-1">${trial.phase || ''}</td>
          <td class="px-2 py-1">${trial.study_type || ''}</td>
          <td class="px-2 py-1">${trial.status || ''}</td>
          <td class="px-2 py-1" title="${trial.sponsor || ''}">${sponsor}</td>
          <td class="px-2 py-1" title="${productTags}">${productTagsDisplay}</td>
          <td class="px-2 py-1">${trial.allocation || ''}</td>
          <td class="px-2 py-1">${trial.start_date || ''}</td>
          <td class="px-2 py-1">${trial.end_date || ''}</td>
          <td class="px-2 py-1">${commentaryDisplay}</td>
          <td class="px-2 py-1 text-xs" title="${trial.created_at ? new Date(trial.created_at).toLocaleString() : 'N/A'}">${trial.created_at ? new Date(trial.created_at).toLocaleDateString() : 'N/A'}<br><small class="text-gray-500">${trial.created_by_user || ''}</small></td>
          <td class="px-2 py-1 text-xs" title="${trial.last_updated_at ? new Date(trial.last_updated_at).toLocaleString() : 'N/A'}">${trial.last_updated_at ? new Date(trial.last_updated_at).toLocaleDateString() : 'N/A'}<br><small class="text-gray-500">${trial.last_updated_by_user || ''}</small></td>
          <td class="px-2 py-1">
            <button data-trial-id="${trial.id}" class="view-edit-btn text-blue-700 hover:underline text-sm" title="Edit">
              Edit
            </button>
          </td>
        </tr>`;
      }

      html += `</tbody></table></div>`;
      container.innerHTML = html;

      // Add event listeners for edit buttons
      container.querySelectorAll('.view-edit-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
          const trialId = this.getAttribute('data-trial-id');
          console.log('✏️ Edit button clicked for trial:', trialId);

          try {
            const docSnapshot = await db.collection('trials').doc(trialId).get();
            if (docSnapshot.exists) {
              const trial = docSnapshot.data();
              await loadTrialDetailsFromFirestore(trial);
              showTrialDetailsPage(trialId);
            } else {
              alert('❌ Trial not found');
            }
          } catch (error) {
            console.error('❌ Error loading trial:', error);
            alert(`❌ Error loading trial: ${error.message}`);
          }
        });
      });

      // Add refresh button functionality
      const refreshBtn = container.querySelector('#refreshTrialsList');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
          loadAllTrialsInSearch();
        });
      }
    }

    // Populate filter dropdowns with unique values from trials data
    function populateFilterDropdowns(trials) {
      console.log('🔧 Populating filter dropdowns...');

      // Get unique values for each filter
      const products = new Set();
      const sponsors = new Set();
      const indications = new Set();
      const createdByUsers = new Set();
      const updatedByUsers = new Set();

      trials.forEach(trial => {
        // Products
        if (trial.product_tags && Array.isArray(trial.product_tags)) {
          trial.product_tags.forEach(product => products.add(product));
        }

        // Sponsors
        if (trial.sponsor) {
          sponsors.add(trial.sponsor);
        }

        // Indications
        if (trial.indication && Array.isArray(trial.indication)) {
          trial.indication.forEach(indication => indications.add(indication));
        }

        // Created by users
        if (trial.created_by_user) {
          createdByUsers.add(trial.created_by_user);
        }

        // Updated by users
        if (trial.last_updated_by_user) {
          updatedByUsers.add(trial.last_updated_by_user);
        }
      });

      // Populate dropdowns
      populateDropdown('filterProduct', Array.from(products).sort());
      populateDropdown('filterSponsor', Array.from(sponsors).sort());
      populateDropdown('filterIndication', Array.from(indications).sort());
      populateDropdown('filterCreatedBy', Array.from(createdByUsers).sort());
      populateDropdown('filterUpdatedBy', Array.from(updatedByUsers).sort());

      console.log('✅ Filter dropdowns populated');
    }

    // Helper function to populate a dropdown
    function populateDropdown(selectId, options) {
      const select = document.getElementById(selectId);
      if (!select) return;

      // Keep the first option (All...)
      const firstOption = select.options[0];
      select.innerHTML = '';
      select.appendChild(firstOption);

      // Add options
      options.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        select.appendChild(optionElement);
      });
    }

    // Setup filter event listeners
    function setupFilterEventListeners() {
      console.log('🔧 Setting up filter event listeners...');

      // Apply filters button
      const applyBtn = document.getElementById('applyFiltersBtn');
      if (applyBtn) {
        applyBtn.addEventListener('click', applyFilters);
      }

      // Clear filters button
      const clearBtn = document.getElementById('clearFiltersBtn');
      if (clearBtn) {
        clearBtn.addEventListener('click', clearAllFilters);
      }



      // Real-time filtering on input change
      const filterInputs = [
        'filterTrialId', 'filterProduct', 'filterPhase', 'filterStatus',
        'filterStudyType', 'filterSponsor', 'filterIndication',
        'filterCreatedBy', 'filterUpdatedBy'
      ];

      filterInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.addEventListener('change', applyFilters);
          if (input.type === 'text') {
            input.addEventListener('input', debounce(applyFilters, 500));
          }
        }
      });

      console.log('✅ Filter event listeners set up');
    }

    // Apply filters to the trials data
    async function applyFilters() {
      console.log('🔍 Applying filters...');

      const filters = {
        trialId: document.getElementById('filterTrialId')?.value.toLowerCase() || '',
        product: document.getElementById('filterProduct')?.value || '',
        phase: document.getElementById('filterPhase')?.value || '',
        status: document.getElementById('filterStatus')?.value || '',
        studyType: document.getElementById('filterStudyType')?.value || '',
        sponsor: document.getElementById('filterSponsor')?.value || '',
        indication: document.getElementById('filterIndication')?.value || '',
        createdBy: document.getElementById('filterCreatedBy')?.value || '',
        updatedBy: document.getElementById('filterUpdatedBy')?.value || ''
      };

      console.log('🔍 Filter values:', filters);

      // Filter the trials data
      let filteredTrials = allTrialsData.filter(trial => {
        // Trial ID filter - also search in Other Study IDs
        if (filters.trialId) {
          // Check main trial ID
          const mainIdMatch = trial.id && trial.id.toLowerCase().includes(filters.trialId);

          // Check other study IDs
          let otherIdMatch = false;
          if (trial.other_study_id && Array.isArray(trial.other_study_id)) {
            otherIdMatch = trial.other_study_id.some(otherId =>
              otherId && otherId.toLowerCase().includes(filters.trialId)
            );
          }

          // If not found in either main ID or other study IDs, exclude this trial
          if (!mainIdMatch && !otherIdMatch) {
            return false;
          }
        }

        // Product filter
        if (filters.product && (!trial.product_tags || !trial.product_tags.includes(filters.product))) {
          return false;
        }

        // Phase filter
        if (filters.phase && trial.phase !== filters.phase) {
          return false;
        }

        // Status filter
        if (filters.status && trial.status !== filters.status) {
          return false;
        }

        // Study type filter
        if (filters.studyType && trial.study_type !== filters.studyType) {
          return false;
        }

        // Sponsor filter
        if (filters.sponsor && trial.sponsor !== filters.sponsor) {
          return false;
        }

        // Indication filter
        if (filters.indication && (!trial.indication || !trial.indication.includes(filters.indication))) {
          return false;
        }

        // Created by filter
        if (filters.createdBy && trial.created_by_user !== filters.createdBy) {
          return false;
        }

        // Updated by filter
        if (filters.updatedBy && trial.last_updated_by_user !== filters.updatedBy) {
          return false;
        }

        return true;
      });

      console.log(`📊 Filtered results: ${filteredTrials.length} of ${allTrialsData.length} trials`);

      // Display filtered results
      const resultsContainer = document.getElementById('searchResults');
      if (resultsContainer) {
        if (filteredTrials.length === 0) {
          resultsContainer.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-filter text-2xl"></i>
              <p class="mt-2">No trials match the selected filters.</p>
              <p class="text-sm mt-1">Try adjusting your filter criteria.</p>
              <button onclick="clearAllFilters()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Clear All Filters
              </button>
            </div>
          `;
        } else {
          await displayTrialsInTable(filteredTrials, resultsContainer);
        }
      }
    }

    // Clear all filters
    async function clearAllFilters() {
      console.log('🧹 Clearing all filters...');

      // Clear all filter inputs
      document.getElementById('filterTrialId').value = '';
      document.getElementById('filterProduct').value = '';
      document.getElementById('filterPhase').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterStudyType').value = '';
      document.getElementById('filterSponsor').value = '';
      document.getElementById('filterIndication').value = '';
      document.getElementById('filterCreatedBy').value = '';
      document.getElementById('filterUpdatedBy').value = '';

      // Display all trials
      const resultsContainer = document.getElementById('searchResults');
      if (resultsContainer && allTrialsData.length > 0) {
        await displayTrialsInTable(allTrialsData, resultsContainer);
      }

      console.log('✅ All filters cleared');
    }

    // Debounce function for real-time filtering
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Show admin filters only for admin users
    function showAdminFiltersIfAdmin() {
      console.log('🔧 Checking admin status for filter visibility...');

      // Check if user is admin (you can modify this logic based on your auth system)
      const currentUser = localStorage.getItem('currentUser');
      const isAdmin = localStorage.getItem('isAdmin') === 'true' ||
                     (currentUser && currentUser.toLowerCase().includes('admin'));

      console.log('👤 Current user:', currentUser);
      console.log('🔐 Is admin:', isAdmin);

      const adminFiltersSection = document.getElementById('adminOnlyFilters');
      if (adminFiltersSection) {
        if (isAdmin) {
          adminFiltersSection.classList.remove('hidden');
          console.log('✅ Admin filters shown');
        } else {
          adminFiltersSection.classList.add('hidden');
          console.log('❌ Admin filters hidden (user is not admin)');
        }
      } else {
        console.log('❌ Admin filters section not found');
      }
    }

    // Setup search form clear functionality
    function setupSearchFormClear() {
      const clearBtn = document.getElementById('clearSearchForm');
      if (clearBtn) {
        clearBtn.addEventListener('click', async () => {
          // Clear search form fields
          document.getElementById('searchTrialId').value = '';
          document.getElementById('searchTitle').value = '';
          document.getElementById('searchPhase').value = '';
          document.getElementById('searchStatus').value = '';

          // Show all trials again
          if (allTrialsData.length > 0) {
            const resultsContainer = document.getElementById('searchResults');
            if (resultsContainer) {
              await displayTrialsInTable(allTrialsData, resultsContainer);
            }
          }

          console.log('✅ Search form cleared');
        });
      }
    }

    // Show welcome message with user name
    function showWelcomeMessage() {
      console.log('🔧 showWelcomeMessage called');

      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const currentUserName = document.getElementById('currentUserName');

      console.log('👤 Current user data:', currentUser);
      console.log('📱 Welcome message element:', welcomeMessage);
      console.log('📝 Current user name element:', currentUserName);

      if (currentUser && welcomeMessage && currentUserName) {
        // Try different possible name fields
        let displayName = '';

        if (currentUser.full_name) {
          displayName = currentUser.full_name.split(' ')[0];
        } else if (currentUser.fullName) {
          displayName = currentUser.fullName.split(' ')[0];
        } else if (currentUser.name) {
          displayName = currentUser.name.split(' ')[0];
        } else if (currentUser.username) {
          displayName = currentUser.username;
        } else {
          displayName = 'User';
        }

        currentUserName.textContent = displayName;
        welcomeMessage.classList.remove('hidden');
        console.log(`✅ Welcome message shown for user: ${displayName}`);
      } else {
        console.log('❌ Could not show welcome message');
        console.log('❌ Missing data:', {
          hasUser: !!currentUser,
          hasWelcomeElement: !!welcomeMessage,
          hasNameElement: !!currentUserName,
          userKeys: currentUser ? Object.keys(currentUser) : []
        });
      }
    }

    // Hide welcome message
    function hideWelcomeMessage() {
      const welcomeMessage = document.getElementById('welcomeMessage');
      if (welcomeMessage) {
        welcomeMessage.classList.add('hidden');
        console.log('✅ Welcome message hidden');
      }
    }

    // Setup simple page navigation - no changes to existing functionality
    function setupSimplePageNavigation() {
      // Get navigation buttons
      const homeBtn = document.getElementById('homeBtn');
      const searchTrialsBtn = document.getElementById('searchTrialsBtn');
      const addTrialBtn = document.getElementById('addTrialBtn');

      // Home button - go to search page
      if (homeBtn) {
        console.log('✅ Home button found and event listener added');
        homeBtn.addEventListener('click', () => {
          console.log('🏠 Home button clicked');
          showSearchPage();
        });
      } else {
        console.log('❌ Home button not found');
      }

      // Search trials button
      if (searchTrialsBtn) {
        console.log('✅ Search trials button found and event listener added');
        searchTrialsBtn.addEventListener('click', () => {
          console.log('🔍 Search trials button clicked');
          showSearchPage();
        });
      } else {
        console.log('❌ Search trials button not found');
      }

      // Add trial button
      if (addTrialBtn) {
        console.log('✅ Add trial button found and event listener added');
        addTrialBtn.addEventListener('click', () => {
          console.log('➕ Add trial button clicked');
          showAddTrialPage();
        });
      } else {
        console.log('❌ Add trial button not found');
      }

      // Back buttons
      const backToSearchFromAddTrial = document.getElementById('backToSearchFromAddTrial');
      const backToSearchFromDetails = document.getElementById('backToSearchFromDetails');

      if (backToSearchFromAddTrial) {
        backToSearchFromAddTrial.addEventListener('click', () => {
          showSearchPage();
        });
      }

      if (backToSearchFromDetails) {
        backToSearchFromDetails.addEventListener('click', () => {
          showSearchPage();
        });
      }

      // Set up existing form redirects
      setupFormRedirects();

      // Show search page by default after login
      setTimeout(() => {
        if (localStorage.getItem('isLoggedIn') === 'true') {
          showSearchPage();
        }
      }, 1000);

      // Make sure add trial section is initially hidden
      const addTrialSection = document.getElementById('add-trial');
      const trialDetailsSection = document.getElementById('trialDetailsSection');
      if (addTrialSection) addTrialSection.style.display = 'none';
      if (trialDetailsSection) {
        trialDetailsSection.style.display = 'none';
        trialDetailsSection.classList.add('hidden');
      }
    }

    // Setup form redirects to use page navigation
    function setupFormRedirects() {
      // The existing addTrialForm already has proper redirect logic
      // No need to override it, just ensure search results work

      // Override search results to use page navigation (if needed)
      setTimeout(() => {
        const searchResults = document.querySelectorAll('.trial-result, .trial-link');
        searchResults.forEach(result => {
          result.addEventListener('click', function(e) {
            e.preventDefault();
            const trialId = this.getAttribute('data-trial-id') || this.textContent.trim();
            if (trialId) {
              showTrialDetailsPage(trialId);
            }
          });
        });
      }, 2000);
    }

    // Comprehensive Audit Trail System
    async function logAuditTrail(action, entityType, entityId, oldData, newData, additionalInfo = {}) {
      try {
        const userInfo = getCurrentUserInfo();
        const timestamp = new Date().toISOString();

        const auditRecord = {
          // User Information
          user_id: userInfo.userId,
          user_name: userInfo.fullName,
          username: userInfo.username,

          // Action Information
          action: action, // 'CREATE', 'UPDATE', 'DELETE'
          entity_type: entityType, // 'trial', 'arm', 'demographics', 'outcome', etc.
          entity_id: entityId,

          // Data Changes
          old_data: oldData || null,
          new_data: newData || null,
          changes: calculateChanges(oldData, newData),

          // Metadata
          timestamp: timestamp,
          session_id: getSessionId(),
          ip_address: 'client', // Could be enhanced with actual IP
          user_agent: navigator.userAgent,

          // Additional Context
          trial_id: additionalInfo.trial_id || null,
          tab_name: additionalInfo.tab_name || null,
          form_name: additionalInfo.form_name || null,
          error_details: additionalInfo.error_details || null,

          // System Information
          browser: getBrowserInfo(),
          timestamp_local: new Date().toLocaleString(),
          created_at: new Date()
        };

        // Save to Firestore audit collection
        console.log('Attempting to save audit record:', auditRecord);
        const docRef = await db.collection('audit_trail').add(auditRecord);
        console.log(`✅ Audit logged successfully: ${action} ${entityType} by ${userInfo.fullName} - Doc ID: ${docRef.id}`);

        // Also log to console for immediate debugging
        console.log('📊 AUDIT TRAIL:', {
          action: action,
          entity: entityType,
          user: userInfo.fullName,
          timestamp: timestamp,
          trial_id: additionalInfo.trial_id
        });

      } catch (error) {
        console.error('❌ Error logging audit trail:', error);
        console.error('Audit record that failed:', {action, entityType, entityId, additionalInfo});
        // Don't throw error to avoid breaking main functionality
      }
    }

    // Calculate what changed between old and new data
    function calculateChanges(oldData, newData) {
      if (!oldData && !newData) return null;
      if (!oldData) return { type: 'creation', all_fields: Object.keys(newData || {}) };
      if (!newData) return { type: 'deletion', all_fields: Object.keys(oldData || {}) };

      const changes = {
        type: 'modification',
        added_fields: [],
        removed_fields: [],
        modified_fields: []
      };

      // Find added and modified fields
      for (const key in newData) {
        if (!(key in oldData)) {
          changes.added_fields.push(key);
        } else if (JSON.stringify(oldData[key]) !== JSON.stringify(newData[key])) {
          changes.modified_fields.push({
            field: key,
            old_value: oldData[key],
            new_value: newData[key]
          });
        }
      }

      // Find removed fields
      for (const key in oldData) {
        if (!(key in newData)) {
          changes.removed_fields.push(key);
        }
      }

      return changes;
    }

    // Get or create session ID
    function getSessionId() {
      let sessionId = sessionStorage.getItem('audit_session_id');
      if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('audit_session_id', sessionId);
      }
      return sessionId;
    }

    // Get browser information
    function getBrowserInfo() {
      const ua = navigator.userAgent;
      let browser = 'Unknown';

      if (ua.includes('Chrome')) browser = 'Chrome';
      else if (ua.includes('Firefox')) browser = 'Firefox';
      else if (ua.includes('Safari')) browser = 'Safari';
      else if (ua.includes('Edge')) browser = 'Edge';

      return {
        name: browser,
        version: navigator.appVersion,
        platform: navigator.platform
      };
    }

    // Log user login/logout events
    async function logUserActivity(activityType, details = {}) {
      try {
        const userInfo = getCurrentUserInfo();

        const activityRecord = {
          user_id: userInfo.userId,
          user_name: userInfo.fullName,
          username: userInfo.username,
          activity_type: activityType, // 'LOGIN', 'LOGOUT', 'SESSION_TIMEOUT'
          timestamp: new Date().toISOString(),
          session_id: getSessionId(),
          browser: getBrowserInfo(),
          details: details,
          created_at: new Date()
        };

        await db.collection('user_activity').add(activityRecord);
        console.log(`User activity logged: ${activityType} by ${userInfo.fullName}`);

      } catch (error) {
        console.error('Error logging user activity:', error);
      }
    }

    // Log errors and exceptions
    async function logError(errorType, errorMessage, context = {}) {
      try {
        const userInfo = getCurrentUserInfo();

        const errorRecord = {
          user_id: userInfo.userId,
          user_name: userInfo.fullName,
          username: userInfo.username,
          error_type: errorType,
          error_message: errorMessage,
          context: context,
          timestamp: new Date().toISOString(),
          session_id: getSessionId(),
          browser: getBrowserInfo(),
          url: window.location.href,
          stack_trace: context.stack || null,
          created_at: new Date()
        };

        await db.collection('error_logs').add(errorRecord);
        console.log(`Error logged: ${errorType} by ${userInfo.fullName}`);

      } catch (error) {
        console.error('Error logging error:', error);
      }
    }

    // Wrapper function to add audit logging to any Firestore operation
    async function auditedFirestoreOperation(operation, entityType, entityId, newData, additionalInfo = {}) {
      try {
        let oldData = null;
        let result = null;

        // Get old data if this is an update operation
        if (operation === 'UPDATE' && entityId) {
          const collection = additionalInfo.collection || getCollectionName(entityType);
          const oldDoc = await db.collection(collection).doc(entityId).get();
          oldData = oldDoc.exists ? oldDoc.data() : null;
        }

        // Perform the operation
        if (operation === 'CREATE') {
          const collection = additionalInfo.collection || getCollectionName(entityType);
          if (entityId) {
            result = await db.collection(collection).doc(entityId).set(newData);
          } else {
            result = await db.collection(collection).add(newData);
            entityId = result.id;
          }
        } else if (operation === 'UPDATE') {
          const collection = additionalInfo.collection || getCollectionName(entityType);
          result = await db.collection(collection).doc(entityId).update(newData);
        } else if (operation === 'DELETE') {
          const collection = additionalInfo.collection || getCollectionName(entityType);
          const oldDoc = await db.collection(collection).doc(entityId).get();
          oldData = oldDoc.exists ? oldDoc.data() : null;
          result = await db.collection(collection).doc(entityId).delete();
        }

        // Log the audit trail
        await logAuditTrail(operation, entityType, entityId, oldData, newData, additionalInfo);

        return { success: true, result: result, entityId: entityId };

      } catch (error) {
        // Log the error
        await logError(`${entityType.toUpperCase()}_${operation}_ERROR`, error.message, {
          entity_type: entityType,
          entity_id: entityId,
          operation: operation,
          data: newData,
          additional_info: additionalInfo
        });

        return { success: false, error: error };
      }
    }

    // Helper function to get collection name from entity type
    function getCollectionName(entityType) {
      const collectionMap = {
        'trial': 'trials',
        'arm': 'trial_arms',
        'demographics': 'patient_demographics',
        'outcome': 'trial_outcomes',
        'criteria': 'trial_criteria',
        'safety': 'trial_safety_assessments',
        'response': 'trial_response_assessments',
        'survival_main': 'survival_data_main',
        'survival_subgroup': 'survival_data_subgroup',
        'milestone': 'trial_milestones',
        'reference': 'trial_specific_references'
      };

      return collectionMap[entityType] || entityType;
    }

    // Function to add audit logging to existing operations without changing their structure
    async function addAuditToExistingOperation(originalFunction, entityType, additionalInfo = {}) {
      return async function(...args) {
        try {
          const result = await originalFunction.apply(this, args);

          // Try to extract entity information from the result or arguments
          const entityId = additionalInfo.getEntityId ? additionalInfo.getEntityId(args, result) : null;
          const data = additionalInfo.getData ? additionalInfo.getData(args, result) : args[0];

          // Log the operation
          await logAuditTrail(additionalInfo.operation || 'UNKNOWN', entityType, entityId, null, data, additionalInfo);

          return result;
        } catch (error) {
          await logError(`${entityType.toUpperCase()}_OPERATION_ERROR`, error.message, {
            entity_type: entityType,
            arguments: args,
            additional_info: additionalInfo
          });
          throw error;
        }
      };
    }

    // Helper function to get current user info
    function getCurrentUserInfo() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      return {
        userId: currentUser.id || 'unknown',
        username: currentUser.username || 'Unknown User',
        fullName: currentUser.fullName || currentUser.username || 'Unknown User'
      };
    }

    // Helper function to add user tracking metadata to trial data
    function addUserTrackingToTrial(trialData, isCreation = false) {
      const userInfo = getCurrentUserInfo();
      const timestamp = new Date().toISOString();

      if (isCreation) {
        trialData.created_by_user_id = userInfo.userId;
        trialData.created_by_user = userInfo.fullName;
        trialData.created_at = timestamp;
      }

      trialData.last_updated_by_user_id = userInfo.userId;
      trialData.last_updated_by_user = userInfo.fullName;
      trialData.last_updated_at = timestamp;

      return trialData;
    }

    // Helper function to add user tracking metadata to any data
    function addUserTrackingToData(data, isCreation = false) {
      const userInfo = getCurrentUserInfo();
      const timestamp = new Date().toISOString();

      if (isCreation) {
        data.created_by_user_id = userInfo.userId;
        data.created_by_user = userInfo.fullName;
        data.created_at = timestamp;
      }

      data.last_updated_by_user_id = userInfo.userId;
      data.last_updated_by_user = userInfo.fullName;
      data.last_updated_at = timestamp;

      return data;
    }

    // Helper function to update trial's last modified information
    async function updateTrialLastModified(trialId) {
      try {
        const userInfo = getCurrentUserInfo();
        const updateData = {
          last_updated_by_user_id: userInfo.userId,
          last_updated_by_user: userInfo.fullName,
          last_updated_at: new Date().toISOString()
        };

        await db.collection('trials').doc(trialId).update(updateData);
        console.log(`Trial ${trialId} last modified info updated by ${userInfo.fullName}`);
      } catch (error) {
        console.error('Error updating trial last modified info:', error);
      }
    }

    // Helper function to format user tracking information for display
    function formatUserTrackingInfo(data, showBorder = true) {
      if (!data) return '';

      const createdBy = data.created_by_user || 'Unknown User';
      const createdAt = data.created_at ? new Date(data.created_at).toLocaleString() : 'Unknown';
      const updatedBy = data.last_updated_by_user || data.created_by_user || 'Unknown User';
      const updatedAt = data.last_updated_at ? new Date(data.last_updated_at).toLocaleString() :
                       data.created_at ? new Date(data.created_at).toLocaleString() : 'Unknown';

      const borderClass = showBorder ? 'border-t border-gray-200 pt-2 mt-2' : '';

      return `
        <div class="${borderClass} text-xs text-gray-500 bg-gray-50 p-2 rounded">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-1">
            <div><strong>Created by:</strong> ${createdBy}</div>
            <div><strong>Created at:</strong> ${createdAt}</div>
            <div><strong>Last updated by:</strong> ${updatedBy}</div>
            <div><strong>Last updated at:</strong> ${updatedAt}</div>
          </div>
        </div>
      `;
    }

    // Helper function to create hover-based user tracking columns for tables
    function createUserTrackingColumns(data) {
      if (!data) return '<td class="px-3 py-1 text-xs text-gray-400">-</td><td class="px-3 py-1 text-xs text-gray-400">-</td>';

      const createdBy = data.created_by_user || 'Unknown';
      const createdAt = data.created_at ? new Date(data.created_at).toLocaleString() : 'Unknown';
      const updatedBy = data.last_updated_by_user || data.created_by_user || 'Unknown';
      const updatedAt = data.last_updated_at ? new Date(data.last_updated_at).toLocaleString() :
                       data.created_at ? new Date(data.created_at).toLocaleString() : 'Unknown';

      return `
        <td class="px-3 py-1 text-xs text-gray-600 relative group cursor-help">
          <div class="truncate max-w-20">${createdBy}</div>
          <div class="absolute bottom-full left-0 mb-2 hidden group-hover:block bg-black text-white text-xs rounded py-2 px-3 whitespace-nowrap z-10 shadow-lg">
            <div><strong>Created by:</strong> ${createdBy}</div>
            <div><strong>Created at:</strong> ${createdAt}</div>
          </div>
        </td>
        <td class="px-3 py-1 text-xs text-gray-600 relative group cursor-help">
          <div class="truncate max-w-20">${updatedBy}</div>
          <div class="absolute bottom-full left-0 mb-2 hidden group-hover:block bg-black text-white text-xs rounded py-2 px-3 whitespace-nowrap z-10 shadow-lg">
            <div><strong>Last updated by:</strong> ${updatedBy}</div>
            <div><strong>Last updated at:</strong> ${updatedAt}</div>
          </div>
        </td>
      `;
    }

    // Helper function to create single combined user tracking column for tables
    function createSingleUserTrackingColumn(data) {
      if (!data) return '<td class="px-3 py-1 text-xs text-gray-400">-</td>';

      const createdBy = data.created_by_user || 'Unknown';
      const createdAt = data.created_at ? new Date(data.created_at).toLocaleString() : 'Unknown';
      const updatedBy = data.last_updated_by_user || data.created_by_user || 'Unknown';
      const updatedAt = data.last_updated_at ? new Date(data.last_updated_at).toLocaleString() :
                       data.created_at ? new Date(data.created_at).toLocaleString() : 'Unknown';

      // Show the most recent user (updated by if different from created by, otherwise created by)
      const displayUser = (updatedBy !== createdBy) ? updatedBy : createdBy;

      return `
        <td class="px-3 py-1 text-xs text-gray-600 relative group cursor-help">
          <div class="truncate max-w-24">${displayUser}</div>
          <div class="absolute bottom-full left-0 mb-2 hidden group-hover:block bg-black text-white text-xs rounded py-2 px-3 whitespace-nowrap z-10 shadow-lg">
            <div><strong>Created by:</strong> ${createdBy}</div>
            <div><strong>Created at:</strong> ${createdAt}</div>
            <div class="border-t border-gray-400 mt-1 pt-1">
              <div><strong>Last updated by:</strong> ${updatedBy}</div>
              <div><strong>Last updated at:</strong> ${updatedAt}</div>
            </div>
          </div>
        </td>
      `;
    }

    // Helper function to add user tracking info to any data display
    function addUserTrackingToDisplay(container, data) {
      const trackingInfo = formatUserTrackingInfo(data);
      if (trackingInfo) {
        container.insertAdjacentHTML('beforeend', trackingInfo);
      }
    }

    // Initialize the user system after Firebase is ready
    document.addEventListener('DOMContentLoaded', async () => {
      // Wait a moment for Firebase to fully initialize
      setTimeout(async () => {
        await initializeUserSystem();
      }, 1000);
    });


    // Show login overlay or app content based on login status
    const loginOverlay = document.getElementById('loginOverlay');
    const appContent = document.getElementById('appContent');
    const loginForm = document.getElementById('loginForm');
    const loginMessage = document.getElementById('loginMessage');
    const createUserForm = document.getElementById('createUserForm');
    const createUserMessage = document.getElementById('createUserMessage');
    const loginSection = document.getElementById('loginSection');
    const createUserSection = document.getElementById('createUserSection');
    const showCreateUserBtn = document.getElementById('showCreateUserBtn');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const createAdminBtn = document.getElementById('createAdminBtn');

    // Check login status on page load
    if (localStorage.getItem('isLoggedIn') === 'true') {
      loginOverlay.classList.add('hidden');
      appContent.classList.remove('hidden');
      // Show welcome message for already logged in users
      showWelcomeMessage();
    } else {
      loginOverlay.classList.remove('hidden');
      appContent.classList.add('hidden');
      // Hide welcome message for logged out users
      hideWelcomeMessage();
    }

    // Login form handler
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = loginForm.username.value.trim();
      const password = loginForm.password.value;

      // Show loading state
      const submitBtn = loginForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Logging in...';
      submitBtn.disabled = true;

      try {
        const user = await validateUser(username, password);
        if (user) {
          // Update last login time
          await updateLastLogin(user.id);

          localStorage.setItem('isLoggedIn', 'true');
          localStorage.setItem('currentUser', JSON.stringify(user));
          loginOverlay.classList.add('hidden');
          appContent.classList.remove('hidden');
          loginForm.reset();
          loginMessage.textContent = '';

          // Show welcome message with user name
          showWelcomeMessage();

          // Check admin access and show user management button if admin
          checkAdminAccess();

          // Log user login activity
          await logUserActivity('LOGIN', {
            login_method: 'username_password',
            user_role: user.role
          });

          console.log(`User ${user.username} (${user.role}) logged in successfully`);

          // Test audit logging immediately after login
          setTimeout(async () => {
            try {
              await testAuditLogging();
            } catch (error) {
              console.error('Test audit logging failed:', error);
            }
          }, 2000);
        } else {
          loginMessage.textContent = 'Invalid username or password.';
        }
      } catch (error) {
        console.error('Login error:', error);
        loginMessage.textContent = 'Login failed. Please try again.';
      } finally {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // Create user form handler
    createUserForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fullName = createUserForm.fullName.value.trim();
      const email = createUserForm.email.value.trim();
      const username = createUserForm.newUsername.value.trim();
      const password = createUserForm.newPassword.value;
      const confirmPassword = createUserForm.confirmPassword.value;
      const role = createUserForm.userRole.value;

      // Get current user to check admin privileges
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

      // Check if current user is admin (for logged-in users) or if no one is logged in (initial setup)
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      if (isLoggedIn && currentUser.role !== 'admin') {
        createUserMessage.textContent = 'Only administrators can create new user accounts.';
        createUserMessage.className = 'text-sm text-red-600 min-h-[1.25rem]';
        return;
      }

      // Validation
      if (!fullName) {
        createUserMessage.textContent = 'Full name is required.';
        createUserMessage.className = 'text-sm text-red-600 min-h-[1.25rem]';
        return;
      }

      if (password !== confirmPassword) {
        createUserMessage.textContent = 'Passwords do not match.';
        createUserMessage.className = 'text-sm text-red-600 min-h-[1.25rem]';
        return;
      }

      if (password.length < 6) {
        createUserMessage.textContent = 'Password must be at least 6 characters long.';
        createUserMessage.className = 'text-sm text-red-600 min-h-[1.25rem]';
        return;
      }

      // Show loading state
      const submitBtn = createUserForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Creating User...';
      submitBtn.disabled = true;

      try {
        const result = await createUser(username, password, role, fullName, email, currentUser.id || 'system');

        if (result.success) {
          createUserMessage.textContent = `User account created successfully for ${fullName}`;
          createUserMessage.className = 'text-sm text-green-600 min-h-[1.25rem]';
          createUserForm.reset();

          // If not logged in (initial setup), redirect to login
          if (!isLoggedIn) {
            setTimeout(() => {
              showLoginSection();
            }, 2000);
          } else {
            // If admin is creating user, show success and reset form
            setTimeout(() => {
              createUserMessage.textContent = '';
            }, 3000);
          }
        } else {
          createUserMessage.textContent = result.message;
          createUserMessage.className = 'text-sm text-red-600 min-h-[1.25rem]';
        }
      } catch (error) {
        console.error('Create user error:', error);
        createUserMessage.textContent = 'Failed to create user. Please try again.';
        createUserMessage.className = 'text-sm text-red-600 min-h-[1.25rem]';
      } finally {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // Show create user section
    showCreateUserBtn.addEventListener('click', () => {
      loginSection.classList.add('hidden');
      createUserSection.classList.remove('hidden');
      createUserMessage.textContent = '';
    });

    // Show login section
    showLoginBtn.addEventListener('click', () => {
      showLoginSection();
    });

    // Manual admin creation button
    createAdminBtn.addEventListener('click', async () => {
      createAdminBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Creating Admin...';
      createAdminBtn.disabled = true;

      try {
        await initializeUserSystem();
        alert('Admin user initialization completed. You can now login with:\nUsername: Dilip\nPassword: Dilip@321');
      } catch (error) {
        console.error('Error creating admin:', error);
        alert('Error creating admin user. Please check the console for details.');
      } finally {
        createAdminBtn.innerHTML = '<i class="fas fa-user-shield mr-1"></i> Initialize Admin User';
        createAdminBtn.disabled = false;
      }
    });

    function showLoginSection() {
      createUserSection.classList.add('hidden');
      loginSection.classList.remove('hidden');
      loginMessage.textContent = '';
      createUserMessage.textContent = '';
    }

    // User Management Modal Functions
    const userManagementBtn = document.getElementById('userManagementBtn');
    const userManagementModal = document.getElementById('userManagementModal');
    const closeUserManagementBtn = document.getElementById('closeUserManagementBtn');
    const adminCreateUserForm = document.getElementById('adminCreateUserForm');
    const adminCreateUserMessage = document.getElementById('adminCreateUserMessage');
    const usersTableBody = document.getElementById('usersTableBody');

    // Show user management modal (Admin only)
    userManagementBtn.addEventListener('click', async () => {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

      // Double-check admin access
      if (currentUser.role !== 'admin') {
        alert('Access denied. Only administrators can manage users.');
        return;
      }

      userManagementModal.classList.remove('hidden');
      await loadUsersList();
    });

    // Close user management modal
    closeUserManagementBtn.addEventListener('click', () => {
      userManagementModal.classList.add('hidden');
    });

    // Admin create user form handler
    adminCreateUserForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

      // Verify admin access
      if (currentUser.role !== 'admin') {
        adminCreateUserMessage.textContent = 'Access denied. Only administrators can create users.';
        adminCreateUserMessage.className = 'md:col-span-2 text-sm text-red-600 min-h-[1.25rem]';
        return;
      }

      const formData = new FormData(adminCreateUserForm);
      const fullName = formData.get('fullName').trim();
      const email = formData.get('email').trim();
      const username = formData.get('username').trim();
      const password = formData.get('password');
      const role = formData.get('role');

      // Show loading state
      const submitBtn = adminCreateUserForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Creating...';
      submitBtn.disabled = true;

      try {
        const result = await createUser(username, password, role, fullName, email, currentUser.id);

        if (result.success) {
          adminCreateUserMessage.textContent = `User account created successfully for ${fullName}`;
          adminCreateUserMessage.className = 'md:col-span-2 text-sm text-green-600 min-h-[1.25rem]';
          adminCreateUserForm.reset();
          await loadUsersList(); // Refresh users list
        } else {
          adminCreateUserMessage.textContent = result.message;
          adminCreateUserMessage.className = 'md:col-span-2 text-sm text-red-600 min-h-[1.25rem]';
        }
      } catch (error) {
        console.error('Create user error:', error);
        adminCreateUserMessage.textContent = 'Failed to create user. Please try again.';
        adminCreateUserMessage.className = 'md:col-span-2 text-sm text-red-600 min-h-[1.25rem]';
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // Load users list
    async function loadUsersList() {
      try {
        const users = await getUsers();
        let html = '';

        users.forEach(user => {
          const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never';
          const status = user.isActive ? 'Active' : 'Inactive';
          const statusClass = user.isActive ? 'text-green-600' : 'text-red-600';

          html += `
            <tr class="border-t border-gray-200 hover:bg-gray-50">
              <td class="px-3 py-2 border border-gray-300">${user.fullName || 'N/A'}</td>
              <td class="px-3 py-2 border border-gray-300">${user.username}</td>
              <td class="px-3 py-2 border border-gray-300">${user.email || 'N/A'}</td>
              <td class="px-3 py-2 border border-gray-300">
                <span class="px-2 py-1 rounded text-xs font-medium ${getRoleBadgeClass(user.role)}">${user.role}</span>
              </td>
              <td class="px-3 py-2 border border-gray-300">
                <span class="${statusClass} font-medium">${status}</span>
              </td>
              <td class="px-3 py-2 border border-gray-300">${lastLogin}</td>
              <td class="px-3 py-2 border border-gray-300">
                ${user.isActive ?
                  `<button class="deactivate-user-btn text-red-600 hover:underline text-sm" data-user-id="${user.id}" data-username="${user.username}">Deactivate</button>` :
                  `<span class="text-gray-400 text-sm">Inactive</span>`
                }
              </td>
            </tr>
          `;
        });

        usersTableBody.innerHTML = html;

        // Add event listeners for deactivate buttons
        document.querySelectorAll('.deactivate-user-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const userId = e.target.dataset.userId;
            const username = e.target.dataset.username;

            if (confirm(`Are you sure you want to deactivate user "${username}"?`)) {
              const result = await deactivateUser(userId);
              if (result.success) {
                await loadUsersList(); // Refresh list
              } else {
                alert('Failed to deactivate user: ' + result.message);
              }
            }
          });
        });

      } catch (error) {
        console.error('Error loading users:', error);
        usersTableBody.innerHTML = '<tr><td colspan="7" class="px-3 py-2 text-center text-red-600">Error loading users</td></tr>';
      }
    }

    // Get role badge class
    function getRoleBadgeClass(role) {
      switch (role) {
        case 'admin': return 'bg-red-100 text-red-800';
        case 'editor': return 'bg-blue-100 text-blue-800';
        case 'viewer': return 'bg-gray-100 text-gray-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    // Show user management button for admins only
    function checkAdminAccess() {
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (currentUser.role === 'admin') {
        userManagementBtn.classList.remove('hidden');
        auditTrailBtn.classList.remove('hidden');
        console.log('Admin access granted - User Management and Audit Trail buttons visible');
      } else {
        userManagementBtn.classList.add('hidden');
        auditTrailBtn.classList.add('hidden');
        console.log('Non-admin user - Admin buttons hidden');
      }
    }

    // Hide user management button by default for all users
    function hideAdminFeatures() {
      userManagementBtn.classList.add('hidden');
      userManagementModal.classList.add('hidden');
      auditTrailBtn.classList.add('hidden');
      auditTrailModal.classList.add('hidden');
    }

    // Check admin access on login
    if (localStorage.getItem('isLoggedIn') === 'true') {
      checkAdminAccess();
    } else {
      // Ensure admin features are hidden when not logged in
      hideAdminFeatures();
    }

    // Logout functionality
    const logoutBtn = document.getElementById('logoutBtn');
    logoutBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        // Log user logout activity before clearing session
        await logUserActivity('LOGOUT', {
          logout_method: 'manual',
          session_duration: Date.now() - (sessionStorage.getItem('login_time') || Date.now())
        });

        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('currentUser');
        loginOverlay.classList.remove('hidden');
        appContent.classList.add('hidden');

        // Hide welcome message on logout
        hideWelcomeMessage();

        // Hide all admin features
        hideAdminFeatures();

        // Reset forms
        loginForm.reset();
        createUserForm.reset();
        adminCreateUserForm.reset();

        // Clear messages
        loginMessage.textContent = '';
        createUserMessage.textContent = '';
        adminCreateUserMessage.textContent = '';

        console.log('User logged out successfully - Admin features hidden');
      }
    });

    // Update login success to check admin access
    const originalLoginSuccess = () => {
      localStorage.setItem('isLoggedIn', 'true');
      loginOverlay.classList.add('hidden');
      appContent.classList.remove('hidden');
      checkAdminAccess(); // Check if user is admin
    };

    function generateId(collection) {
      return collection.length ? collection[collection.length - 1].id + 1 : 1;
    }

    function showMessage(elementId, message, isError = false) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = isError ? 'mt-4 text-sm text-red-600' : 'mt-4 text-sm text-green-600';
      setTimeout(() => {
        el.textContent = '';
      }, 5000);
    }

    // Add Other Study ID input fields dynamically (Add Trial Form)
    const addOtherStudyIdBtn = document.getElementById('addOtherStudyIdBtn');
    const addOtherStudyIdsContainer = document.getElementById('addOtherStudyIdsContainer');
    addOtherStudyIdBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'text';
      input.name = 'other_study_id';
      input.placeholder = 'Other Study ID';
      input.className = 'w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600';
      addOtherStudyIdsContainer.appendChild(input);
    });

    // Add Indication searchable dropdown dynamically (Add Trial Form)
    const addIndicationBtn = document.getElementById('addIndicationBtn');
    const addIndicationsContainer = document.getElementById('addIndicationsContainer');
    addIndicationBtn.addEventListener('click', async () => {
      const selectorDiv = document.createElement('div');
      selectorDiv.className = 'indication-selector';
      selectorDiv.innerHTML = `
        <div class="relative">
          <input type="text" name="indication_search" placeholder="Search or type indication..."
                 class="w-full border border-gray-300 rounded px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-600 indication-search-input" />
          <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 dropdown-toggle">
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="dropdown-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b max-h-40 overflow-y-auto shadow-lg">
            <!-- Options will be loaded here -->
          </div>
        </div>
        <input type="hidden" name="indication" />
      `;
      addIndicationsContainer.appendChild(selectorDiv);

      // Initialize the new dropdown
      await initializeIndicationDropdown(selectorDiv);
    });

    // Removed old dynamic field addition code for simplified search form

    // Add Product Tag searchable dropdown dynamically (Add Trial Form)
    const addProductTagBtn = document.getElementById('addProductTagBtn');
    const productTagsContainer = document.getElementById('productTagsContainer');
    addProductTagBtn.addEventListener('click', async () => {
      const selectorDiv = document.createElement('div');
      selectorDiv.className = 'product-tag-selector';
      selectorDiv.innerHTML = `
        <div class="relative">
          <input type="text" name="product_tag_search" placeholder="Search or type product name..."
                 class="w-full border border-gray-300 rounded px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-600 product-search-input" />
          <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 dropdown-toggle">
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="dropdown-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b max-h-40 overflow-y-auto shadow-lg">
            <!-- Options will be loaded here -->
          </div>
        </div>
        <input type="hidden" name="product_tag" />
      `;
      productTagsContainer.appendChild(selectorDiv);

      // Initialize the new dropdown
      await initializeProductDropdown(selectorDiv);
    });

    // Add Biomarker input fields dynamically (Add Trial Form)
    const addBiomarkerBtn = document.getElementById('addBiomarkerBtn');
    const addBiomarkersContainer = document.getElementById('addBiomarkersContainer');
    addBiomarkerBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'text';
      input.name = 'biomarker';
      input.placeholder = 'Biomarker name';
      input.className = 'w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600';
      addBiomarkersContainer.appendChild(input);
    });

    // Add Trial Form Submission
    document.getElementById('addTrialForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const trial_id = formData.get('trial_id').trim();
      if (!trial_id) {
        showMessage('addTrialMessage', 'Trial ID is required.', true);
        return;
      }
      const title = formData.get('title').trim();
      if (!title) {
        showMessage('addTrialMessage', 'Title is required.', true);
        return;
      }

      // Collect multiple other_study_id inputs
      const other_study_ids = [];
      this.querySelectorAll('input[name="other_study_id"]').forEach(input => {
        const val = input.value.trim();
        if (val) other_study_ids.push(val);
      });

      // Collect multiple indications inputs
      const indications = [];
      this.querySelectorAll('input[name="indication"]').forEach(input => {
        const val = input.value.trim();
        if (val) indications.push(val);
      });

      // Validate mandatory field: Indication(s)
      if (indications.length === 0) {
        showMessage('addTrialMessage', 'At least one indication is required.', true);
        return;
      }

      // Collect multiple product_tag inputs (from hidden inputs)
      const product_tags = [];
      this.querySelectorAll('input[name="product_tag"]').forEach(input => {
        const val = input.value.trim();
        if (val) product_tags.push(val);
      });

      // Validate mandatory field: Product Tags
      if (product_tags.length === 0) {
        showMessage('addTrialMessage', 'At least one product tag is required.', true);
        return;
      }

      const enrollmentRaw = formData.get('enrollment');
      const enrollment = enrollmentRaw ? parseInt(enrollmentRaw) : null;
      const phase = formData.get('phase');
      const study_type = formData.get('study_type') || null;
      const status = formData.get('status');

      // Validate mandatory field: Status
      if (!status) {
        showMessage('addTrialMessage', 'Status is required.', true);
        return;
      }

      const sponsor = formData.get('sponsor').trim() || null;
      // Collect multiple biomarker inputs
      const biomarkers = [];
      this.querySelectorAll('input[name="biomarker"]').forEach(input => {
        const val = input.value.trim();
        if (val) biomarkers.push(val);
      });

      const allocation = formData.get('allocation') || null;
      const start_date = formData.get('start_date') || null;
      const end_date = formData.get('end_date') || null;

      const newTrial = {
        id: trial_id,
        title,
        other_study_id: other_study_ids.length ? other_study_ids : null,
        indication: indications.length ? indications : null,
        enrollment,
        phase: phase || null,
        study_type,
        status: status || null,
        sponsor,
        product_tags,
        biomarkers: biomarkers.length ? biomarkers : null,
        allocation,
        start_date,
        end_date
      };

      // Add user tracking metadata for trial creation
      addUserTrackingToTrial(newTrial, true);

      // Save to Firestore using trial_id as document ID for easier updates and duplicate prevention
      console.log('[Firestore] Attempting to save trial:', newTrial);
      try {
        const docSnapshot = await db.collection('trials').doc(trial_id).get();
        if (docSnapshot.exists) {
          showMessage('addTrialMessage', `Trial ID "${trial_id}" already exists in Firestore. Please use a unique Trial ID.`, true);
          return;
        }

        await db.collection('trials').doc(trial_id).set(newTrial);
        console.log('[Firestore] Trial saved successfully:', newTrial);

        // Log audit trail for trial creation
        await logAuditTrail('CREATE', 'trial', trial_id, null, newTrial, {
          trial_id: trial_id,
          tab_name: 'trial_creation',
          form_name: 'addTrialForm'
        });

        showMessage('addTrialMessage', `Trial ID "${newTrial.id}" added successfully to Firebase.`);

        // Reset form
        document.getElementById('addTrialForm').reset();
        addOtherStudyIdsContainer.innerHTML = '';
        const firstOtherStudyInput = document.createElement('input');
        firstOtherStudyInput.type = 'text';
        firstOtherStudyInput.name = 'other_study_id';
        firstOtherStudyInput.placeholder = 'Other Study ID';
        firstOtherStudyInput.className = 'w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600';
        addOtherStudyIdsContainer.appendChild(firstOtherStudyInput);
        // Reset indications container with searchable dropdown
        addIndicationsContainer.innerHTML = '';
        const firstIndicationSelector = document.createElement('div');
        firstIndicationSelector.className = 'indication-selector';
        firstIndicationSelector.innerHTML = `
          <div class="relative">
            <input type="text" name="indication_search" placeholder="Search or type indication..."
                   class="w-full border border-gray-300 rounded px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-600 indication-search-input" />
            <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 dropdown-toggle">
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b max-h-40 overflow-y-auto shadow-lg">
              <!-- Options will be loaded here -->
            </div>
          </div>
          <input type="hidden" name="indication" />
        `;
        addIndicationsContainer.appendChild(firstIndicationSelector);

        // Reset product tags container with searchable dropdown
        productTagsContainer.innerHTML = '';
        const firstProductSelector = document.createElement('div');
        firstProductSelector.className = 'product-tag-selector';
        firstProductSelector.innerHTML = `
          <div class="relative">
            <input type="text" name="product_tag_search" placeholder="Search or type product name..."
                   class="w-full border border-gray-300 rounded px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-600 product-search-input" />
            <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 dropdown-toggle">
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b max-h-40 overflow-y-auto shadow-lg">
              <!-- Options will be loaded here -->
            </div>
          </div>
          <input type="hidden" name="product_tag" />
        `;
        productTagsContainer.appendChild(firstProductSelector);

        // Initialize the new dropdowns
        setTimeout(async () => {
          await initializeIndicationDropdown(firstIndicationSelector);
          await initializeProductDropdown(firstProductSelector);
        }, 100);
        addBiomarkersContainer.innerHTML = '';
        const firstBiomarkerInput = document.createElement('input');
        firstBiomarkerInput.type = 'text';
        firstBiomarkerInput.name = 'biomarker';
        firstBiomarkerInput.placeholder = 'Biomarker name';
        firstBiomarkerInput.className = 'w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600';
        addBiomarkersContainer.appendChild(firstBiomarkerInput);

        // Show details using page navigation
        await loadTrialDetailsFromFirestore(newTrial);
        showTrialDetailsPage(trial_id);

        // --- Refresh search results if visible ---
        const searchSection = document.getElementById('search');
        if (searchSection && !searchSection.classList.contains('hidden')) {
          // Simulate a search submit to refresh results
          const searchForm = document.getElementById('trialSearchForm');
          if (searchForm) {
            searchForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
          }
        }
      } catch (error) {
        console.error('[Firestore] Error with trial operations:', error);

        // Log error
        await logError('TRIAL_CREATION_ERROR', error.message, {
          trial_id: trial_id,
          form_data: newTrial,
          action: 'create_trial'
        });

        showMessage('addTrialMessage', `Error with trial operations: ${error.message}`, true);
      }
    });

    // Search Trials
document.getElementById('trialSearchForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const formData = new FormData(this);
  const trialId = formData.get('trial_id').trim().toLowerCase();
  // Collect multiple other_study_id inputs
  const otherStudyIds = [];
  this.querySelectorAll('input[name="other_study_id"]').forEach(input => {
    const val = input.value.trim().toLowerCase();
    if (val) otherStudyIds.push(val);
  });
  // Collect multiple indications inputs
  const indications = [];
  this.querySelectorAll('input[name="indication"]').forEach(input => {
    const val = input.value.trim().toLowerCase();
    if (val) indications.push(val);
  });
  const title = formData.get('title').trim().toLowerCase();
  const phase = formData.get('phase');
  const status = formData.get('status');
  const resultsContainer = document.getElementById('searchResults');
  resultsContainer.innerHTML = '<p class="text-gray-600 italic">Searching Firestore...</p>';
  // Fetch all trials from Firestore
  db.collection('trials').get().then(async querySnapshot => {
    const trialsFromFirestore = [];
    querySnapshot.forEach(doc => {
      trialsFromFirestore.push(doc.data());
    });
    // Filter as before
    let results = trialsFromFirestore.filter(trial => {
      // Trial ID match (case insensitive) - also search in Other Study IDs
      let trialIdMatch = true;
      if (trialId !== '') {
        // Check main trial ID
        const mainIdMatch = trial.id && trial.id.toLowerCase().includes(trialId);

        // Check other study IDs
        let otherIdMatch = false;
        if (trial.other_study_id && Array.isArray(trial.other_study_id)) {
          otherIdMatch = trial.other_study_id.some(otherId =>
            otherId && otherId.toLowerCase().includes(trialId)
          );
        }

        // Match if found in either main ID or other study IDs
        trialIdMatch = mainIdMatch || otherIdMatch;
      }
      // Other Study ID match: any of the entered otherStudyIds matches any in trial.other_study_id array (case insensitive)
      let otherStudyIdMatch = true;
      if (otherStudyIds.length > 0) {
        if (!trial.other_study_id || !Array.isArray(trial.other_study_id)) {
          otherStudyIdMatch = false;
        } else {
          otherStudyIdMatch = otherStudyIds.some(osid => trial.other_study_id.some(tosid => tosid.toLowerCase() === osid));
        }
      }
      // Indication match: any of the entered indications matches any in trial.indication array (case insensitive)
      let indicationMatch = true;
      if (indications.length > 0) {
        if (!trial.indication || !Array.isArray(trial.indication)) {
          indicationMatch = false;
        } else {
          indicationMatch = indications.some(ind => trial.indication.some(tind => tind.toLowerCase().includes(ind)));
        }
      }
      // Title match
      const titleMatch = title === '' || (trial.title && trial.title.toLowerCase().includes(title));
      // Phase match
      const phaseMatch = phase === '' || trial.phase === phase;
      // Status match
      const statusMatch = status === '' || trial.status === status;
      return trialIdMatch && otherStudyIdMatch && indicationMatch && titleMatch && phaseMatch && statusMatch;
    });
    if (results.length === 0) {
      resultsContainer.innerHTML = `
        <div class="text-center py-8 text-gray-500">
          <i class="fas fa-search text-2xl"></i>
          <p class="mt-2">No trials found matching your search criteria.</p>
          <p class="text-sm mt-1">Try adjusting your search filters or clear filters to see all trials.</p>
        </div>
      `;
      return;
    }

    // Use the new table display function
    await displayTrialsInTable(results, resultsContainer);
    return;
  }).catch(error => {
    resultsContainer.innerHTML = `<p class='text-red-600'>Error fetching trials from Firestore: ${error.message}</p>`;
    console.error('[Firestore] Error fetching trials:', error);
  });
});


let currentTrialId = null;
// Old edit trial functionality removed - now handled in Summary tab

// Old showEditTrialForm function removed - edit functionality now in Summary tab

// Edit functionality now handled in Summary tab

// Load trial details from Firestore result
async function loadTrialDetailsFromFirestore(trial) {
  if (!trial) return;
  const detailsSection = document.getElementById('trialDetailsSection');
  detailsSection.classList.remove('hidden');
  const summary = `
    <div><strong>Trial ID:</strong> ${trial.id}</div>
    <div><strong>Other Study ID(s):</strong> ${trial.other_study_id && Array.isArray(trial.other_study_id) ? trial.other_study_id.join(', ') : 'N/A'}</div>
    <div><strong>Title:</strong> ${trial.title}</div>
    <div><strong>Indication(s):</strong> ${trial.indication && Array.isArray(trial.indication) ? trial.indication.join(', ') : 'N/A'}</div>
    <div><strong>Enrollment:</strong> ${trial.enrollment !== null && trial.enrollment !== undefined ? trial.enrollment : 'N/A'}</div>
    <div><strong>Phase:</strong> ${trial.phase || 'N/A'}</div>
    <div><strong>Study Type:</strong> ${trial.study_type || 'N/A'}</div>
    <div><strong>Status:</strong> ${trial.status || 'N/A'}</div>
    <div><strong>Sponsor:</strong> ${trial.sponsor || 'N/A'}</div>
    <div><strong>Product Tags:</strong> ${trial.product_tags && trial.product_tags.length ? trial.product_tags.join(', ') : 'N/A'}</div>
    <div><strong>Biomarkers:</strong> ${trial.biomarkers && Array.isArray(trial.biomarkers) && trial.biomarkers.length ? trial.biomarkers.join(', ') : 'N/A'}</div>
    <div><strong>Allocation:</strong> ${trial.allocation || 'N/A'}</div>
    <div><strong>Start Date:</strong> ${trial.start_date || 'N/A'}</div>
    <div><strong>End Date:</strong> ${trial.end_date || 'N/A'}</div>
    <div class="mt-4 pt-4 border-t border-gray-200">
      <div><strong>Created By:</strong> ${trial.created_by_user || 'N/A'}</div>
      <div><strong>Created At:</strong> ${trial.created_at ? new Date(trial.created_at).toLocaleString() : 'N/A'}</div>
      <div><strong>Last Updated By:</strong> ${trial.last_updated_by_user || 'N/A'}</div>
      <div><strong>Last Updated At:</strong> ${trial.last_updated_at ? new Date(trial.last_updated_at).toLocaleString() : 'N/A'}</div>
    </div>
  `;
  // Trial summary is now handled in the Summary tab
  currentTrialId = trial.id;
  const tabButtons = document.querySelectorAll('.tab-btn');
  tabButtons.forEach(btn => {
    btn.classList.remove('bg-blue-600', 'text-white');
    btn.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400', 'hover:text-white');
  });

  // Restore saved tab or default to 'summary'
  const savedTab = localStorage.getItem('currentTab') || 'summary';
  const savedTabBtn = document.querySelector(`[data-tab="${savedTab}"]`);

  if (savedTabBtn) {
    savedTabBtn.classList.add('bg-blue-600', 'text-white');
    savedTabBtn.classList.remove('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400', 'hover:text-white');
    await loadTabContent(savedTab);
  } else {
    // Fallback to summary tab if saved tab doesn't exist
    tabButtons[0].classList.add('bg-blue-600', 'text-white');
    tabButtons[0].classList.remove('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400', 'hover:text-white');
    await loadTabContent('summary');
  }

  resetAllTabForms();
  // Edit functionality now handled in Summary tab
}

// For backward compatibility, keep the old function for localStorage
async function loadTrialDetails(trialId) {
  let storedTrials = localStorage.getItem('trials');
  let trialsArr = storedTrials ? JSON.parse(storedTrials) : trials;
  const trial = trialsArr.find(t => t.id === trialId);
  if (!trial) return;
  await loadTrialDetailsFromFirestore(trial);
}

    // Close button removed - use Back to Search button instead

    document.getElementById('tabs').addEventListener('click', async e => {
      if (!e.target.classList.contains('tab-btn')) return;
      const tab = e.target.getAttribute('data-tab');
      if (!tab) return;

      // Clean up all CKEditor instances before switching tabs
      await cleanupAllCKEditorInstances();

      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400', 'hover:text-white');
      });
      e.target.classList.add('bg-blue-600', 'text-white');
      e.target.classList.remove('bg-gray-300', 'text-gray-700', 'hover:bg-gray-400', 'hover:text-white');

      // Save current tab to localStorage
      localStorage.setItem('currentTab', tab);

      await loadTabContent(tab);
    });

    function resetAllTabForms() {
      const forms = document.querySelectorAll('#tabContent form');
      forms.forEach(f => f.reset());
    }

    // === ARM management ===
    // For simplicity, arms are stored as array of strings per trial
    // We'll allow user to add arms in product tab and reuse in other tabs

    // Store arms per trial: { trialId: [armName1, armName2, ...] }
    const trialArms = {};

    // Get arms for current trial or empty array
    function getArms(trialId) {
      if (!trialArms[trialId]) trialArms[trialId] = [];
      return trialArms[trialId];
    }

    // Add arm if not exists
    function addArm(trialId, armName) {
      if (!trialArms[trialId]) trialArms[trialId] = [];
      if (!trialArms[trialId].includes(armName)) trialArms[trialId].push(armName);
    }

    // === References management ===
    // references: { id, trial_id, tab, source_name, link }
    // We'll add references from all tabs here and show in References tab

    // Add reference helper
    function addReference(trialId, tab, source_name, link) {
      if (!source_name || !link) return;
      // Check duplicate
      if (references.some(r => r.trial_id === trialId && r.tab === tab && r.source_name === source_name && r.link === link)) return;
      references.push({
        id: generateId(references),
        trial_id: trialId,
        tab,
        source_name,
        link
      });
    }

    // Load tab content dispatcher
    async function loadTabContent(tab) {
      if (!currentTrialId) return;

      // Clean up all existing CKEditor instances before loading new content
      await cleanupAllCKEditorInstances();

      const container = document.getElementById('tabContent');
      container.innerHTML = '';

      switch (tab) {
        case 'summary': renderSummaryTab(container, currentTrialId); break;
        case 'products': renderProductsTab(container, currentTrialId); break;
        case 'patients': renderPatientsTab(container, currentTrialId); break;
        case 'outcome': renderOutcomeTab(container, currentTrialId); break;
        case 'inclusion': renderInclusionExclusionTab(container, currentTrialId); break;
        case 'safetyAssessments': renderSafetyAssessmentsTab(container, currentTrialId); break;
        case 'responseAssessment': renderResponseAssessmentTab(container, currentTrialId); break;
        case 'survivalData': renderSurvivalDataTab(container, currentTrialId); break;
        case 'milestones': renderMilestonesTab(container, currentTrialId); break;
        case 'references': renderReferencesTab(container, currentTrialId); break;
        case 'commentary': renderCommentaryTab(container, currentTrialId); break;
        default: container.innerHTML = `<p class="text-gray-600 italic">Tab "${tab}" content not implemented.</p>`;
      }
    }

    // Test function to verify audit logging is working with realistic data
    async function testAuditLogging() {
      try {
        console.log('🧪 Testing audit logging with realistic data...');

        // Test 1: Create a trial ARM
        const armData = {
          arm_type: 'Experimental',
          products: ['Drug A', 'Drug B'],
          dosage: '20mg daily',
          arm_n: '150',
          arm_free_text: 'Combination therapy with Drug A and Drug B',
          is_active: true,
          trial_id: 'TEST_TRIAL_001'
        };

        await logAuditTrail('CREATE', 'arm', 'test_arm_123', null, armData, {
          trial_id: 'TEST_TRIAL_001',
          tab_name: 'arms',
          form_name: 'armForm'
        });

        console.log('✅ Test ARM creation logged');

        // Test 2: Update the ARM (simulate a change)
        const oldArmData = { ...armData };
        const newArmData = {
          ...armData,
          arm_type: 'Control',
          dosage: '10mg daily',
          arm_n: '100'
        };

        await logAuditTrail('UPDATE', 'arm', 'test_arm_123', oldArmData, newArmData, {
          trial_id: 'TEST_TRIAL_001',
          tab_name: 'arms',
          form_name: 'armForm'
        });

        console.log('✅ Test ARM update logged');

        // Test 3: Create demographics data
        const demoData = {
          demographics_text: 'Median age 65 years (range 45-80), 60% male, 40% female. ECOG performance status 0-1.',
          source: 'Clinical Study Report',
          source_link: 'https://example.com/study-report.pdf',
          trial_id: 'TEST_TRIAL_001'
        };

        await logAuditTrail('CREATE', 'demographics', 'test_demo_456', null, demoData, {
          trial_id: 'TEST_TRIAL_001',
          tab_name: 'demographics',
          form_name: 'demographicsForm'
        });

        console.log('✅ Test demographics creation logged');

        // Test 4: Delete the demographics (simulate deletion)
        await logAuditTrail('DELETE', 'demographics', 'test_demo_456', demoData, null, {
          trial_id: 'TEST_TRIAL_001',
          tab_name: 'demographics',
          form_name: 'deleteAction'
        });

        console.log('✅ Test demographics deletion logged');

        // Test 5: Create a milestone
        const milestoneData = {
          milestone_event: 'Regulatory',
          topic_tag: 'FDA filing/approval',
          milestone_description: 'FDA approval for new indication',
          disease: 'Breast Cancer',
          status: 'Active',
          expected_date: '2024-12-31',
          trial_id: 'TEST_TRIAL_001'
        };

        await logAuditTrail('CREATE', 'milestone', 'test_milestone_789', null, milestoneData, {
          trial_id: 'TEST_TRIAL_001',
          tab_name: 'milestones',
          form_name: 'milestoneForm'
        });

        console.log('✅ Test milestone creation logged');

        console.log('✅ All test audit logging completed successfully');

      } catch (error) {
        console.error('❌ Test audit logging failed:', error);
      }
    }

    // Helper function to clean up all CKEditor instances
    async function cleanupAllCKEditorInstances() {
      const instanceIds = Object.keys(ckEditorInstances);
      for (const instanceId of instanceIds) {
        await destroyCKEditor(instanceId);
      }
    }

    // === SUMMARY TAB ===
    function renderSummaryTab(container, trialId) {
      // Get trial data from Firestore
      db.collection('trials').doc(trialId).get().then(docSnapshot => {
        if (!docSnapshot.exists) {
          container.innerHTML = '<p class="text-red-600">Trial not found.</p>';
          return;
        }

        const trial = docSnapshot.data();

        // Create compact form layout like ARMs tab
        const html = `
          <div class="mb-4">
            <h3 class="text-xl font-semibold text-blue-900">Trial Summary</h3>
            <p class="text-gray-600 mt-1">All fields are editable. Click "Save Changes" to save your modifications.</p>
          </div>

          <!-- Summary Form (like ARMs tab style) - All fields editable -->
          <form id="summaryForm" class="bg-gray-50 p-4 rounded shadow-md max-w-6xl grid grid-cols-1 md:grid-cols-3 gap-4" novalidate>
            <h4 class="md:col-span-3 text-lg font-semibold text-blue-900">Trial Information</h4>
            <!-- Trial ID -->
            <div>
              <label class="block font-medium mb-1">Trial ID</label>
              <input type="text" name="trial_id" value="${trial.id || ''}" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100 text-sm" readonly />
              <small class="text-gray-500">Trial ID cannot be changed</small>
            </div>

            <!-- Phase -->
            <div>
              <label class="block font-medium mb-1">Phase</label>
              <select name="phase" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600">
                <option value="">Select Phase</option>
                <option value="Phase I" ${trial.phase === 'Phase I' ? 'selected' : ''}>Phase I</option>
                <option value="Phase I/II" ${trial.phase === 'Phase I/II' ? 'selected' : ''}>Phase I/II</option>
                <option value="Phase II" ${trial.phase === 'Phase II' ? 'selected' : ''}>Phase II</option>
                <option value="Phase II/III" ${trial.phase === 'Phase II/III' ? 'selected' : ''}>Phase II/III</option>
                <option value="Phase III" ${trial.phase === 'Phase III' ? 'selected' : ''}>Phase III</option>
                <option value="Phase IV" ${trial.phase === 'Phase IV' ? 'selected' : ''}>Phase IV</option>
              </select>
            </div>

            <!-- Status -->
            <div>
              <label class="block font-medium mb-1">Status</label>
              <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600">
                <option value="">Select Status</option>
                <option value="Recruiting" ${trial.status === 'Recruiting' ? 'selected' : ''}>Recruiting</option>
                <option value="Active" ${trial.status === 'Active' ? 'selected' : ''}>Active</option>
                <option value="Completed" ${trial.status === 'Completed' ? 'selected' : ''}>Completed</option>
                <option value="Terminated" ${trial.status === 'Terminated' ? 'selected' : ''}>Terminated</option>
                <option value="Suspended" ${trial.status === 'Suspended' ? 'selected' : ''}>Suspended</option>
              </select>
            </div>

            <!-- Study Type -->
            <div>
              <label class="block font-medium mb-1">Study Type</label>
              <select name="study_type" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600">
                <option value="">Select Study Type</option>
                <option value="Interventional" ${trial.study_type === 'Interventional' ? 'selected' : ''}>Interventional</option>
                <option value="Observational" ${trial.study_type === 'Observational' ? 'selected' : ''}>Observational</option>
                <option value="Expanded Access" ${trial.study_type === 'Expanded Access' ? 'selected' : ''}>Expanded Access</option>
              </select>
            </div>

            <!-- Enrollment -->
            <div>
              <label class="block font-medium mb-1">Enrollment</label>
              <input type="number" name="enrollment" value="${trial.enrollment || ''}" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600" />
            </div>

            <!-- Sponsor -->
            <div>
              <label class="block font-medium mb-1">Sponsor</label>
              <input type="text" name="sponsor" value="${trial.sponsor || ''}" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600" />
            </div>

            <!-- Allocation -->
            <div>
              <label class="block font-medium mb-1">Allocation</label>
              <select name="allocation" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600">
                <option value="">Select Allocation</option>
                <option value="Randomized" ${trial.allocation === 'Randomized' ? 'selected' : ''}>Randomized</option>
                <option value="Non-Randomized" ${trial.allocation === 'Non-Randomized' ? 'selected' : ''}>Non-Randomized</option>
                <option value="Single Group" ${trial.allocation === 'Single Group' ? 'selected' : ''}>Single Group</option>
              </select>
            </div>

            <!-- Start Date -->
            <div>
              <label class="block font-medium mb-1">Start Date</label>
              <input type="date" name="start_date" value="${trial.start_date || ''}" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600" />
            </div>

            <!-- End Date -->
            <div>
              <label class="block font-medium mb-1">End Date</label>
              <input type="date" name="end_date" value="${trial.end_date || ''}" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600" />
            </div>

            <!-- Title -->
            <div class="md:col-span-3">
              <label class="block font-medium mb-1">Title</label>
              <textarea name="title" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600">${trial.title || ''}</textarea>
            </div>

            <!-- Other Study IDs -->
            <div class="md:col-span-3">
              <label class="block font-medium mb-1">Other Study ID(s)</label>
              <div id="summaryOtherStudyIdsContainer" class="space-y-2">
                ${(trial.other_study_id && Array.isArray(trial.other_study_id) && trial.other_study_id.length > 0 ? trial.other_study_id : ['']).map((id, index) =>
                  `<div class="flex gap-2 items-center">
                    <input type="text" name="other_study_id" value="${id}" placeholder="Enter Other Study ID"
                           class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600" />
                    ${index > 0 ? '<button type="button" class="remove-other-study-id bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600"><i class="fas fa-times"></i></button>' : ''}
                  </div>`
                ).join('')}
              </div>
              <button type="button" id="addOtherStudyIdSummary" class="mt-2 text-green-600 hover:text-green-800 text-sm flex items-center gap-1">
                <i class="fas fa-plus"></i> Add Another Other Study ID
              </button>
            </div>

            <!-- Indications -->
            <div class="md:col-span-3">
              <label class="block font-medium mb-1">Indication(s)</label>
              <div id="summaryIndicationsContainer" class="space-y-2">
                ${(trial.indication && Array.isArray(trial.indication) && trial.indication.length > 0 ? trial.indication : ['']).map((indication, index) =>
                  `<div class="flex gap-2 items-center indication-selector-summary">
                    <div class="relative flex-1">
                      <input type="text" name="indication_search" value="${indication}" placeholder="Search or type indication..."
                             class="w-full border border-gray-300 rounded px-3 py-2 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 indication-search-input" />
                      <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 dropdown-toggle">
                        <i class="fas fa-chevron-down"></i>
                      </button>
                      <div class="dropdown-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b max-h-40 overflow-y-auto shadow-lg">
                        <!-- Options will be loaded here -->
                      </div>
                    </div>
                    <input type="hidden" name="indication" value="${indication}" />
                    ${index > 0 ? '<button type="button" class="remove-indication bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600"><i class="fas fa-times"></i></button>' : ''}
                  </div>`
                ).join('')}
              </div>
              <button type="button" id="addIndicationSummary" class="mt-2 text-green-600 hover:text-green-800 text-sm flex items-center gap-1">
                <i class="fas fa-plus"></i> Add Another Indication
              </button>
            </div>

            <!-- Product Tags -->
            <div class="md:col-span-3">
              <label class="block font-medium mb-1">Product Tags</label>
              <div id="summaryProductTagsContainer" class="space-y-2">
                ${(trial.product_tags && Array.isArray(trial.product_tags) && trial.product_tags.length > 0 ? trial.product_tags : ['']).map((product, index) =>
                  `<div class="flex gap-2 items-center product-tag-selector-summary">
                    <div class="relative flex-1">
                      <input type="text" name="product_tag_search" value="${product}" placeholder="Search or type product name..."
                             class="w-full border border-gray-300 rounded px-3 py-2 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 product-search-input" />
                      <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 dropdown-toggle">
                        <i class="fas fa-chevron-down"></i>
                      </button>
                      <div class="dropdown-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b max-h-40 overflow-y-auto shadow-lg">
                        <!-- Options will be loaded here -->
                      </div>
                    </div>
                    <input type="hidden" name="product_tags" value="${product}" />
                    ${index > 0 ? '<button type="button" class="remove-product-tag bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600"><i class="fas fa-times"></i></button>' : ''}
                  </div>`
                ).join('')}
              </div>
              <button type="button" id="addProductTagSummary" class="mt-2 text-green-600 hover:text-green-800 text-sm flex items-center gap-1">
                <i class="fas fa-plus"></i> Add Another Product Tag
              </button>
            </div>

            <!-- Biomarkers -->
            <div class="md:col-span-3">
              <label class="block font-medium mb-1">Biomarkers</label>
              <div id="summaryBiomarkersContainer" class="grid grid-cols-1 md:grid-cols-3 gap-2">
                ${(trial.biomarkers && Array.isArray(trial.biomarkers) ? trial.biomarkers : ['']).map(biomarker =>
                  `<input type="text" name="biomarkers" value="${biomarker}" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600" />`
                ).join('')}
              </div>
            </div>

            <!-- Save button (always visible) -->
            <div id="summaryFormButtons" class="md:col-span-3">
              <button type="submit" class="bg-green-600 text-white font-semibold rounded px-6 py-2 hover:bg-green-700 transition">
                <i class="fas fa-save mr-2"></i>Save Changes
              </button>
              <div id="summaryMessage" class="mt-2 text-sm"></div>
            </div>
          </form>

          <!-- Audit Information -->
          <div class="mt-4 bg-gray-50 p-4 rounded shadow-md">
            <h4 class="text-lg font-semibold text-gray-800 mb-2">Audit Information</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <span class="font-medium text-gray-700">Created By:</span> ${trial.created_by_user || 'N/A'}
                <br><span class="font-medium text-gray-700">Created At:</span> ${trial.created_at ? new Date(trial.created_at).toLocaleString() : 'N/A'}
              </div>
              <div>
                <span class="font-medium text-gray-700">Last Updated By:</span> ${trial.last_updated_by_user || 'N/A'}
                <br><span class="font-medium text-gray-700">Last Updated At:</span> ${trial.last_updated_at ? new Date(trial.last_updated_at).toLocaleString() : 'N/A'}
              </div>
            </div>
          </div>

          <div id="summaryMessage" class="mt-4 text-sm"></div>
        `;

        container.innerHTML = html;

        // Add event listeners for edit functionality
        setupSummaryEditFunctionality(trial);

      }).catch(error => {
        console.error('Error loading trial summary:', error);
        container.innerHTML = '<p class="text-red-600">Error loading trial summary.</p>';
      });
    }

    // Setup form submission functionality for summary tab (all fields editable)
    function setupSummaryEditFunctionality(trial) {
      const form = document.getElementById('summaryForm');
      const messageDiv = document.getElementById('summaryMessage');

      // Setup add/remove functionality for dynamic fields
      setupSummaryDynamicFields();

      // Form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        try {
          messageDiv.innerHTML = '<p class="text-blue-600">Saving changes...</p>';

          // Collect form data
          const formData = new FormData(form);

          // For searchable dropdowns, get values from hidden inputs
          const indicationValues = [];
          form.querySelectorAll('input[name="indication"]').forEach(input => {
            const value = input.value.trim();
            if (value) indicationValues.push(value);
          });

          const productTagValues = [];
          form.querySelectorAll('input[name="product_tags"]').forEach(input => {
            const value = input.value.trim();
            if (value) productTagValues.push(value);
          });

          const updatedTrial = {
            ...trial,
            title: formData.get('title'),
            enrollment: formData.get('enrollment') ? parseInt(formData.get('enrollment')) : null,
            phase: formData.get('phase'),
            study_type: formData.get('study_type'),
            status: formData.get('status'),
            sponsor: formData.get('sponsor'),
            allocation: formData.get('allocation'),
            start_date: formData.get('start_date'),
            end_date: formData.get('end_date'),
            other_study_id: formData.getAll('other_study_id').filter(id => id.trim() !== ''),
            indication: indicationValues,
            product_tags: productTagValues,
            biomarkers: formData.getAll('biomarkers').filter(bio => bio.trim() !== ''),
            last_updated_at: new Date().toISOString(),
            last_updated_by_user: JSON.parse(localStorage.getItem('currentUser') || '{}').username || 'Unknown'
          };

          // Update in Firestore
          await db.collection('trials').doc(trial.id).update(updatedTrial);

          messageDiv.innerHTML = '<p class="text-green-600">Changes saved successfully!</p>';

          // Clear message after 3 seconds
          setTimeout(() => {
            messageDiv.innerHTML = '';
          }, 3000);

        } catch (error) {
          console.error('Error updating trial:', error);
          messageDiv.innerHTML = '<p class="text-red-600">Error saving changes: ' + error.message + '</p>';
        }
      });
    }

    // Setup dynamic field functionality for summary tab
    async function setupSummaryDynamicFields() {
      // Initialize existing searchable dropdowns
      document.querySelectorAll('.indication-selector-summary').forEach(selector => {
        initializeIndicationDropdown(selector);
      });

      document.querySelectorAll('.product-tag-selector-summary').forEach(selector => {
        initializeProductDropdown(selector);
      });

      // Add Other Study ID
      const addOtherStudyIdBtn = document.getElementById('addOtherStudyIdSummary');
      if (addOtherStudyIdBtn) {
        addOtherStudyIdBtn.addEventListener('click', () => {
          const container = document.getElementById('summaryOtherStudyIdsContainer');
          const newField = document.createElement('div');
          newField.className = 'flex gap-2 items-center';
          newField.innerHTML = `
            <input type="text" name="other_study_id" value="" placeholder="Enter Other Study ID"
                   class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600" />
            <button type="button" class="remove-other-study-id bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
              <i class="fas fa-times"></i>
            </button>
          `;
          container.appendChild(newField);

          // Add remove functionality
          newField.querySelector('.remove-other-study-id').addEventListener('click', () => {
            newField.remove();
          });
        });
      }

      // Add Indication
      const addIndicationBtn = document.getElementById('addIndicationSummary');
      if (addIndicationBtn) {
        addIndicationBtn.addEventListener('click', async () => {
          const container = document.getElementById('summaryIndicationsContainer');
          const newField = document.createElement('div');
          newField.className = 'flex gap-2 items-center indication-selector-summary';
          newField.innerHTML = `
            <div class="relative flex-1">
              <input type="text" name="indication_search" value="" placeholder="Search or type indication..."
                     class="w-full border border-gray-300 rounded px-3 py-2 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 indication-search-input" />
              <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 dropdown-toggle">
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="dropdown-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b max-h-40 overflow-y-auto shadow-lg">
                <!-- Options will be loaded here -->
              </div>
            </div>
            <input type="hidden" name="indication" value="" />
            <button type="button" class="remove-indication bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
              <i class="fas fa-times"></i>
            </button>
          `;
          container.appendChild(newField);

          // Initialize the searchable dropdown
          await initializeIndicationDropdown(newField);

          // Add remove functionality
          newField.querySelector('.remove-indication').addEventListener('click', () => {
            newField.remove();
          });
        });
      }

      // Add Product Tag
      const addProductTagBtn = document.getElementById('addProductTagSummary');
      if (addProductTagBtn) {
        addProductTagBtn.addEventListener('click', async () => {
          const container = document.getElementById('summaryProductTagsContainer');
          const newField = document.createElement('div');
          newField.className = 'flex gap-2 items-center product-tag-selector-summary';
          newField.innerHTML = `
            <div class="relative flex-1">
              <input type="text" name="product_tag_search" value="" placeholder="Search or type product name..."
                     class="w-full border border-gray-300 rounded px-3 py-2 pr-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 product-search-input" />
              <button type="button" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 dropdown-toggle">
                <i class="fas fa-chevron-down"></i>
              </button>
              <div class="dropdown-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded-b max-h-40 overflow-y-auto shadow-lg">
                <!-- Options will be loaded here -->
              </div>
            </div>
            <input type="hidden" name="product_tags" value="" />
            <button type="button" class="remove-product-tag bg-red-500 text-white px-2 py-1 rounded text-xs hover:bg-red-600">
              <i class="fas fa-times"></i>
            </button>
          `;
          container.appendChild(newField);

          // Initialize the searchable dropdown
          await initializeProductDropdown(newField);

          // Add remove functionality
          newField.querySelector('.remove-product-tag').addEventListener('click', () => {
            newField.remove();
          });
        });
      }

      // Setup remove functionality for existing fields
      document.querySelectorAll('.remove-other-study-id').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.flex').remove();
        });
      });

      document.querySelectorAll('.remove-indication').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.flex').remove();
        });
      });

      document.querySelectorAll('.remove-product-tag').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.flex').remove();
        });
      });
    }

    // === ARM TAB (Products) ===
    function renderProductsTab(container, trialId) {
      db.collection('trial_arms').where('trial_id', '==', trialId).get().then(querySnapshot => {
        const trialArms = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          trialArms.push(data);
        });

        let html = `
          <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <h3 class="text-xl font-semibold text-blue-900">Trial Arms</h3>
            <button id="showAddArmFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
              <i class="fas fa-plus"></i> Add ARM
            </button>
          </div>
        `;

        if (trialArms.length === 0) {
          html += `<p class="text-gray-600 italic mb-4">No ARMs added yet.</p>`;
        } else {
          html += `<div class="overflow-x-auto max-h-96 scrollbar-thin border border-gray-300 rounded">
            <table class="min-w-full border-collapse border border-gray-300 text-sm">
              <thead class="bg-blue-900 text-white">
                <tr>
                  <th class="px-3 py-2 text-left">ARM Type</th>
                  <th class="px-3 py-2 text-left">Products</th>
                  <th class="px-3 py-2 text-left">Dosage</th>
                  <th class="px-3 py-2 text-left">N</th>
                  <th class="px-3 py-2 text-left">ARM Free Text</th>
                  <th class="px-3 py-2 text-left">Is Active</th>
                  <th class="px-3 py-2 text-left">User Info</th>
                  <th class="px-3 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${trialArms.map(arm => {
                  const products = arm.products || [];
                  const productsDisplay = products.length > 0 ? products.join(', ') : 'No products';
                  const userTrackingColumn = createSingleUserTrackingColumn(arm);
                  return `<tr class="border-t border-gray-200 hover:bg-gray-100">
                    <td class="px-3 py-1">${arm.arm_type || ''}</td>
                    <td class="px-3 py-1">${productsDisplay}</td>
                    <td class="px-3 py-1">${arm.dosage || ''}</td>
                    <td class="px-3 py-1">${arm.arm_n || ''}</td>
                    <td class="px-3 py-1">${arm.arm_free_text || ''}</td>
                    <td class="px-3 py-1">${arm.is_active ? 'Yes' : 'No'}</td>
                    ${userTrackingColumn}
                    <td class="px-3 py-1">
                      <button data-doc-id="${arm._docId}" class="edit-arm-btn text-blue-700 hover:underline text-sm">Edit</button>
                      <button data-doc-id="${arm._docId}" class="remove-arm-btn text-red-600 hover:underline text-sm ml-2">Remove</button>
                    </td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>`;
        }

        // Add ARM Form (hidden initially)
        html += `
          <form id="addArmForm" class="mt-6 bg-gray-50 p-4 rounded shadow-md max-w-6xl hidden grid grid-cols-1 md:grid-cols-3 gap-4" novalidate>
            <h4 class="md:col-span-3 text-lg font-semibold text-blue-900">Add / Edit ARM</h4>
            <input type="hidden" id="armEditId" name="arm_edit_id" value="" />

            <!-- ARM Type -->
            <div>
              <label for="armType" class="block font-medium mb-1">ARM Type *</label>
              <select id="armType" name="arm_type" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                <option value="">Select ARM Type</option>
                <option value="Active Comparator">Active Comparator</option>
                <option value="Case">Case</option>
                <option value="Control">Control</option>
                <option value="Experimental">Experimental</option>
                <option value="Exposure Comparison">Exposure Comparison</option>
                <option value="No Intervention">No Intervention</option>
                <option value="Other">Other</option>
                <option value="Placebo Comparator">Placebo Comparator</option>
                <option value="Sham Comparator">Sham Comparator</option>
                <option value="Treatment Comparison">Treatment Comparison</option>
              </select>
            </div>

            <!-- Products -->
            <div>
              <label class="block font-medium mb-1">Products *</label>
              <div class="flex space-x-2 mb-2">
                <input type="text" id="productInput" placeholder="Enter product name" class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
                <button type="button" id="addProductBtn" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div id="selectedProducts" class="flex flex-wrap gap-2 min-h-[2rem] border border-gray-200 rounded p-2 bg-gray-50">
                <span class="text-gray-500 text-sm">No products added</span>
              </div>
              <input type="hidden" id="productsHidden" name="products" value="" />
            </div>

            <!-- Dosage -->
            <div>
              <label for="dosage" class="block font-medium mb-1">Dosage</label>
              <input type="text" id="dosage" name="dosage" placeholder="Enter dosage" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
            </div>

            <!-- N -->
            <div>
              <label for="armN" class="block font-medium mb-1">N</label>
              <input type="number" id="armN" name="arm_n" min="0" placeholder="Number of participants" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
            </div>

            <!-- ARM Free Text -->
            <div class="md:col-span-2">
              <label for="armFreeText" class="block font-medium mb-1">ARM Free Text</label>
              <input type="text" id="armFreeText" name="arm_free_text" maxlength="1000" placeholder="Additional ARM description" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
            </div>

            <!-- Is Active -->
            <div class="flex items-center space-x-6">
              <span class="font-medium">Is Active *</span>
              <label class="inline-flex items-center space-x-2">
                <input type="radio" name="is_active" value="1" class="form-radio text-blue-600" required />
                <span>Yes</span>
              </label>
              <label class="inline-flex items-center space-x-2">
                <input type="radio" name="is_active" value="0" class="form-radio text-blue-600" />
                <span>No</span>
              </label>
            </div>

            <div class="md:col-span-3 flex justify-end gap-4">
              <button type="button" id="cancelArmBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">Cancel</button>
              <button type="submit" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
                <i class="fas fa-save mr-2"></i> Save ARM
              </button>
            </div>
            <div id="armFormMessage" class="md:col-span-3 text-sm mt-2"></div>
          </form>
        `;

        container.innerHTML = html;

        // Store selected products
        let selectedProducts = [];

        // Add product functionality
        document.getElementById('addProductBtn').addEventListener('click', () => {
          const productInput = document.getElementById('productInput');
          const productName = productInput.value.trim();

          if (!productName) {
            showArmFormMessage('Please enter a product name.', true);
            return;
          }

          if (selectedProducts.includes(productName)) {
            showArmFormMessage('This product is already added.', true);
            return;
          }

          selectedProducts.push(productName);
          updateProductsDisplay();
          productInput.value = '';
          showArmFormMessage('');
        });

        // Allow adding product with Enter key
        document.getElementById('productInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('addProductBtn').click();
          }
        });

        function updateProductsDisplay() {
          const container = document.getElementById('selectedProducts');
          if (selectedProducts.length === 0) {
            container.innerHTML = '<span class="text-gray-500 text-sm">No products added</span>';
          } else {
            container.innerHTML = selectedProducts.map(product =>
              `<div class="flex items-center space-x-1 bg-blue-100 rounded px-3 py-1 text-sm">
                <span>${product}</span>
                <button type="button" class="remove-product text-blue-600 hover:text-blue-900 focus:outline-none" data-product="${product}">
                  <i class="fas fa-times"></i>
                </button>
              </div>`
            ).join('');

            // Add event listeners for remove buttons
            container.querySelectorAll('.remove-product').forEach(btn => {
              btn.addEventListener('click', () => {
                const productToRemove = btn.getAttribute('data-product');
                selectedProducts = selectedProducts.filter(p => p !== productToRemove);
                updateProductsDisplay();
              });
            });
          }

          // Update hidden input
          document.getElementById('productsHidden').value = JSON.stringify(selectedProducts);
        }

        // Show form
        document.getElementById('showAddArmFormBtn').addEventListener('click', () => {
          resetArmForm();
          document.getElementById('addArmForm').classList.remove('hidden');
          document.getElementById('armType').focus();
        });

        document.getElementById('cancelArmBtn').addEventListener('click', () => {
          resetArmForm();
          document.getElementById('addArmForm').classList.add('hidden');
        });

        function resetArmForm() {
          const form = document.getElementById('addArmForm');
          form.reset();
          form.arm_edit_id.value = '';
          selectedProducts = [];
          updateProductsDisplay();
          showArmFormMessage('');
        }

        function showArmFormMessage(msg, isError = false) {
          const el = document.getElementById('armFormMessage');
          el.textContent = msg;
          el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
          if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
        }

        // Form submission
        document.getElementById('addArmForm').addEventListener('submit', async e => {
          e.preventDefault();
          const form = e.target;
          const arm_type = form.arm_type.value.trim();
          const products = selectedProducts;
          const dosage = form.dosage.value.trim() || null;
          const arm_n = form.arm_n.value ? parseInt(form.arm_n.value) : null;
          const arm_free_text = form.arm_free_text.value.trim() || null;
          const is_active = form.is_active.value === '1';

          if (!arm_type) {
            showArmFormMessage('ARM Type is required.', true);
            return;
          }

          if (products.length === 0) {
            showArmFormMessage('At least one product is required.', true);
            return;
          }

          // Add arm name to trialArms for other tabs
          const armName = `${arm_type}${products.length > 0 ? ' - ' + products[0] : ''}`;
          addArm(currentTrialId, armName);

          // Save to Firestore
          const editId = form.arm_edit_id.value;
          const data = {
            trial_id: currentTrialId,
            arm_type,
            products,
            dosage,
            arm_n,
            arm_free_text,
            is_active
          };

          // Add user tracking metadata
          addUserTrackingToData(data, !editId); // isCreation = true if no editId

          if (editId) {
            try {
              // Get old data for audit trail
              const oldDoc = await db.collection('trial_arms').doc(editId).get();
              const oldData = oldDoc.exists ? oldDoc.data() : null;

              await db.collection('trial_arms').doc(editId).set(data);

              // Log audit trail for ARM update
              await logAuditTrail('UPDATE', 'arm', editId, oldData, data, {
                trial_id: currentTrialId,
                tab_name: 'arms',
                form_name: 'armForm'
              });

              showArmFormMessage('ARM updated successfully.');
              await loadTabContent('products');

              // Update trial's last updated info
              await updateTrialLastModified(currentTrialId);
            } catch (error) {
              // Log error
              await logError('ARM_UPDATE_ERROR', error.message, {
                trial_id: currentTrialId,
                arm_id: editId,
                form_data: data,
                action: 'update_arm'
              });

              showArmFormMessage('Error updating ARM: ' + error.message, true);
            }
          } else {
            try {
              const docRef = await db.collection('trial_arms').add(data);

              // Log audit trail for ARM creation
              await logAuditTrail('CREATE', 'arm', docRef.id, null, data, {
                trial_id: currentTrialId,
                tab_name: 'arms',
                form_name: 'armForm'
              });

              showArmFormMessage('ARM added successfully.');
              await loadTabContent('products');

              // Update trial's last updated info
              await updateTrialLastModified(currentTrialId);
            } catch (error) {
              // Log error
              await logError('ARM_CREATION_ERROR', error.message, {
                trial_id: currentTrialId,
                form_data: data,
                action: 'create_arm'
              });

              showArmFormMessage('Error saving ARM: ' + error.message, true);
            }
          }
        });

        // Edit ARM functionality
        container.querySelectorAll('.edit-arm-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const docId = btn.getAttribute('data-doc-id');
            db.collection('trial_arms').doc(docId).get().then(docSnapshot => {
              if (!docSnapshot.exists) return;
              const arm = docSnapshot.data();
              const form = document.getElementById('addArmForm');

              form.arm_edit_id.value = docId;
              form.arm_type.value = arm.arm_type || '';
              form.dosage.value = arm.dosage || '';
              form.arm_n.value = arm.arm_n || '';
              form.arm_free_text.value = arm.arm_free_text || '';

              // Set radio button
              const isActiveRadio = form.querySelector(`input[name="is_active"][value="${arm.is_active ? '1' : '0'}"]`);
              if (isActiveRadio) isActiveRadio.checked = true;

              // Set products
              selectedProducts = arm.products || [];
              updateProductsDisplay();

              document.getElementById('addArmForm').classList.remove('hidden');
              form.arm_type.focus();
            });
          });
        });

        // Remove ARM functionality
        container.querySelectorAll('.remove-arm-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to remove this ARM?')) {
              const docId = btn.getAttribute('data-doc-id');
              try {
                // Get old data for audit trail
                const oldDoc = await db.collection('trial_arms').doc(docId).get();
                const oldData = oldDoc.exists ? oldDoc.data() : null;

                await db.collection('trial_arms').doc(docId).delete();

                // Log audit trail for ARM deletion
                await logAuditTrail('DELETE', 'arm', docId, oldData, null, {
                  trial_id: currentTrialId,
                  tab_name: 'arms',
                  form_name: 'armDeleteAction'
                });

                await loadTabContent('products');
              } catch (error) {
                // Log error
                await logError('ARM_DELETE_ERROR', error.message, {
                  trial_id: currentTrialId,
                  arm_id: docId,
                  action: 'delete_arm'
                });

                alert('Error deleting ARM: ' + error.message);
              }
            }
          });
        });
      });
    }

    // === PATIENT DEMOGRAPHICS TAB ===
    function renderPatientsTab(container, trialId) {
      db.collection('patient_demographics').where('trial_id', '==', trialId).get().then(querySnapshot => {
        const patientDemographics = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          patientDemographics.push(data);
        });

        let html = `
          <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <h3 class="text-xl font-semibold text-blue-900">Patient Demographics</h3>
            <button id="showAddDemographicsFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
              <i class="fas fa-plus"></i> Add Demographics
            </button>
          </div>
        `;
        if (patientDemographics.length === 0) {
          html += `<p class="text-gray-600 italic mb-4">No patient demographics added yet.</p>`;
        } else {
          html += `<div class="overflow-x-auto max-h-96 scrollbar-thin border border-gray-300 rounded">
            <table class="min-w-full border-collapse border border-gray-300 text-sm">
              <thead class="bg-blue-900 text-white">
                <tr>
                  <th class="px-3 py-2 text-left">Demographics Details</th>
                  <th class="px-3 py-2 text-left">Source</th>
                  <th class="px-3 py-2 text-left">User Info</th>
                  <th class="px-3 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${patientDemographics.map(demo => {
                  const userTrackingColumn = createSingleUserTrackingColumn(demo);
                  return `<tr class="border-t border-gray-200 hover:bg-blue-50">
                    <td class="px-3 py-1 max-w-md">
                      <div class="rich-text-display whitespace-pre-wrap break-words">${demo.demographics_text || ''}</div>
                    </td>
                    <td class="px-3 py-1">
                      ${demo.source_link ?
                        `<a href="${demo.source_link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm">
                          <i class="fas fa-external-link-alt mr-1 text-xs"></i>${demo.source || 'Unknown Source'}
                        </a>` :
                        `<span class="text-gray-700 text-sm">${demo.source || 'No Source'}</span>`
                      }
                    </td>
                    ${userTrackingColumn}
                    <td class="px-3 py-1">
                      <button data-doc-id="${demo._docId}" class="edit-demographics-btn text-blue-700 hover:underline text-sm">Edit</button>
                      <button data-doc-id="${demo._docId}" class="remove-demographics-btn text-red-600 hover:underline text-sm ml-2">Remove</button>
                    </td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>`;
        }

        // Add Demographics Form (hidden initially)
        html += `
          <form id="addDemographicsForm" class="mt-6 bg-gray-50 p-4 rounded shadow-md max-w-4xl hidden" novalidate>
            <h4 class="text-lg font-semibold text-blue-900 mb-4">Add / Edit Patient Demographics</h4>
            <input type="hidden" id="demographicsEditId" name="demographics_edit_id" value="" />

            <div class="mb-4">
              <label for="demographicsText" class="block font-medium mb-1">Demographics Details *</label>
              <div id="demographicsText" name="demographics_text"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label for="demographicsSource" class="block font-medium mb-1">Source</label>
                <input type="text" id="demographicsSource" name="source" placeholder="Data source (e.g., Clinical report, Study protocol)"
                  class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
              </div>
              <div>
                <label for="demographicsSourceLink" class="block font-medium mb-1">Source Link</label>
                <input type="url" id="demographicsSourceLink" name="source_link" placeholder="https://example.com"
                  class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
              </div>
            </div>

            <div class="flex justify-end gap-4">
              <button type="button" id="cancelDemographicsBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">Cancel</button>
              <button type="submit" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
                <i class="fas fa-save mr-2"></i> Save Demographics
              </button>
            </div>
            <div id="demographicsFormMessage" class="text-sm mt-2"></div>
          </form>
        `;

        container.innerHTML = html;

        // Show form
        document.getElementById('showAddDemographicsFormBtn').addEventListener('click', async () => {
          resetDemographicsForm();
          document.getElementById('addDemographicsForm').classList.remove('hidden');
          await createCKEditor('demographicsText');
        });

        document.getElementById('cancelDemographicsBtn').addEventListener('click', async () => {
          resetDemographicsForm();
          await destroyCKEditor('demographicsText');
          document.getElementById('addDemographicsForm').classList.add('hidden');
        });

        // Form submission
        document.getElementById('addDemographicsForm').addEventListener('submit', async e => {
          e.preventDefault();
          const form = e.target;
          const demographics_text = getCKEditorData('demographicsText').trim();
          const source = form.source.value.trim() || null;
          const source_link = form.source_link.value.trim() || null;

          if (!demographics_text) {
            showDemographicsFormMessage('Demographics Details are required.', true);
            return;
          }

          const editId = form.demographics_edit_id.value;

          if (editId) {
            // Update existing record - don't include created_at
            const updateData = {
              trial_id: trialId,
              demographics_text,
              source,
              source_link,
              updated_at: new Date()
            };

            // Add user tracking metadata for update
            addUserTrackingToData(updateData, false);

            try {
              await db.collection('patient_demographics').doc(editId).update(updateData);
              showDemographicsFormMessage('Demographics updated successfully.');
              await updateTrialLastModified(trialId);
              await loadTabContent('patients');
            } catch (error) {
              showDemographicsFormMessage('Error updating demographics: ' + error.message, true);
            }
          } else {
            // Create new record - include created_at
            const newData = {
              trial_id: trialId,
              demographics_text,
              source,
              source_link,
              created_at: new Date(),
              updated_at: new Date()
            };

            // Add user tracking metadata for creation
            addUserTrackingToData(newData, true);

            try {
              const docRef = await db.collection('patient_demographics').add(newData);

              // Log audit trail for demographics creation
              await logAuditTrail('CREATE', 'demographics', docRef.id, null, newData, {
                trial_id: trialId,
                tab_name: 'demographics',
                form_name: 'demographicsForm'
              });

              showDemographicsFormMessage('Demographics added successfully.');
              await updateTrialLastModified(trialId);
              await loadTabContent('patients');
            } catch (error) {
              // Log error
              await logError('DEMOGRAPHICS_CREATION_ERROR', error.message, {
                trial_id: trialId,
                form_data: newData,
                action: 'create_demographics'
              });

              showDemographicsFormMessage('Error saving demographics: ' + error.message, true);
            }
          }
        });

        // Edit Demographics functionality
        container.querySelectorAll('.edit-demographics-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const docId = btn.getAttribute('data-doc-id');
            db.collection('patient_demographics').doc(docId).get().then(async docSnapshot => {
              if (!docSnapshot.exists) return;
              const demographics = docSnapshot.data();
              const form = document.getElementById('addDemographicsForm');

              // Clean up existing CKEditor instance first
              await destroyCKEditor('demographicsText');

              form.demographics_edit_id.value = docId;
              form.source.value = demographics.source || '';
              form.source_link.value = demographics.source_link || '';

              document.getElementById('addDemographicsForm').classList.remove('hidden');

              // Create CKEditor and set data
              await createCKEditor('demographicsText', demographics.demographics_text || '');
            });
          });
        });

        // Remove Demographics functionality
        container.querySelectorAll('.remove-demographics-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (confirm('Are you sure you want to remove this demographics entry?')) {
              const docId = btn.getAttribute('data-doc-id');
              try {
                await db.collection('patient_demographics').doc(docId).delete();
                await loadTabContent('patients');
              } catch (error) {
                alert('Error deleting demographics: ' + error.message);
              }
            }
          });
        });

        function resetDemographicsForm() {
          const form = document.getElementById('addDemographicsForm');
          form.reset();
          form.demographics_edit_id.value = '';
          setCKEditorData('demographicsText', '');
          showDemographicsFormMessage('');
        }

        function showDemographicsFormMessage(msg, isError = false) {
          const el = document.getElementById('demographicsFormMessage');
          el.textContent = msg;
          el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
          if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
        }
      });
    }

    // === OUTCOME TAB ===
    function renderOutcomeTab(container, trialId) {
      db.collection('trial_outcomes').where('trial_id', '==', trialId).get().then(querySnapshot => {
        const outcomes = {
          primary: null,
          secondary: null,
          other: null
        };

        querySnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          outcomes[data.outcome_type] = data;
        });

        let html = `
          <div class="mb-4">
            <h3 class="text-xl font-semibold text-blue-900">Trial Outcomes</h3>
          </div>
        `;
        // Primary Outcome Section
        html += `
          <div class="mb-8 bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-blue-800">Primary Outcome</h4>
              <button id="editPrimaryBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">
                <i class="fas fa-edit mr-1"></i> ${outcomes.primary ? 'Edit' : 'Add'}
              </button>
            </div>
            <div id="primaryOutcomeDisplay" class="p-4 bg-gray-50 rounded border overflow-auto">
              ${outcomes.primary ? `<div class="rich-text-display prose prose-sm max-w-none w-full">${outcomes.primary.outcome_text || ''}</div>` : '<p class="text-gray-500 italic">No primary outcome defined yet.</p>'}
            </div>
          </div>
        `;

        // Secondary Outcome Section
        html += `
          <div class="mb-8 bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-blue-800">Secondary Outcome</h4>
              <button id="editSecondaryBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">
                <i class="fas fa-edit mr-1"></i> ${outcomes.secondary ? 'Edit' : 'Add'}
              </button>
            </div>
            <div id="secondaryOutcomeDisplay" class="p-4 bg-gray-50 rounded border overflow-auto">
              ${outcomes.secondary ? `<div class="rich-text-display prose prose-sm max-w-none w-full">${outcomes.secondary.outcome_text || ''}</div>` : '<p class="text-gray-500 italic">No secondary outcome defined yet.</p>'}
            </div>
          </div>
        `;

        // Other Outcome Section
        html += `
          <div class="mb-8 bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-blue-800">Other Outcome</h4>
              <button id="editOtherBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">
                <i class="fas fa-edit mr-1"></i> ${outcomes.other ? 'Edit' : 'Add'}
              </button>
            </div>
            <div id="otherOutcomeDisplay" class="p-4 bg-gray-50 rounded border overflow-auto">
              ${outcomes.other ? `<div class="rich-text-display prose prose-sm max-w-none w-full">${outcomes.other.outcome_text || ''}</div>` : '<p class="text-gray-500 italic">No other outcome defined yet.</p>'}
            </div>
          </div>
        `;

        // Outcome Editor Form (hidden initially)
        html += `
          <div id="outcomeEditorForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h4 id="outcomeEditorTitle" class="text-xl font-semibold text-blue-900">Edit Outcome</h4>
                <button id="closeOutcomeEditor" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>

              <form id="outcomeForm" novalidate>
                <input type="hidden" id="outcomeType" name="outcome_type" value="" />
                <input type="hidden" id="outcomeEditId" name="outcome_edit_id" value="" />

                <div class="mb-4">
                  <label for="outcomeText" class="block font-medium mb-2">Outcome Details *</label>
                  <div id="outcomeText"></div>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                  <button type="button" id="cancelOutcomeBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">
                    Cancel
                  </button>
                  <button type="submit" class="bg-blue-600 text-white font-semibold rounded px-6 py-2 hover:bg-blue-700 transition">
                    <i class="fas fa-save mr-2"></i> Save Outcome
                  </button>
                </div>
                <div id="outcomeFormMessage" class="text-sm mt-2"></div>
              </form>
            </div>
          </div>
        `;

        container.innerHTML = html;

        // Event handlers for outcome editing
        ['primary', 'secondary', 'other'].forEach(type => {
          const editBtn = document.getElementById(`edit${type.charAt(0).toUpperCase() + type.slice(1)}Btn`);
          editBtn.addEventListener('click', () => {
            openOutcomeEditor(type, outcomes[type]);
          });
        });

        // Close editor handlers
        document.getElementById('closeOutcomeEditor').addEventListener('click', closeOutcomeEditor);
        document.getElementById('cancelOutcomeBtn').addEventListener('click', closeOutcomeEditor);

        // Form submission
        document.getElementById('outcomeForm').addEventListener('submit', async e => {
          e.preventDefault();
          const form = e.target;
          const outcome_type = form.outcome_type.value;
          const outcome_text = getCKEditorData('outcomeText').trim();

          if (!outcome_text) {
            showOutcomeFormMessage('Outcome details are required.', true);
            return;
          }

          const editId = form.outcome_edit_id.value;

          if (editId) {
            // Update existing record - don't include created_at
            const updateData = {
              trial_id: trialId,
              outcome_type,
              outcome_text,
              updated_at: new Date()
            };

            // Add user tracking metadata for update
            addUserTrackingToData(updateData, false);

            try {
              await db.collection('trial_outcomes').doc(editId).update(updateData);
              showOutcomeFormMessage('Outcome updated successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(async () => {
                await closeOutcomeEditor();
                await loadTabContent('outcome');
              }, 1000);
            } catch (error) {
              showOutcomeFormMessage('Error updating outcome: ' + error.message, true);
            }
          } else {
            // Create new record - include created_at
            const newData = {
              trial_id: trialId,
              outcome_type,
              outcome_text,
              created_at: new Date(),
              updated_at: new Date()
            };

            // Add user tracking metadata for creation
            addUserTrackingToData(newData, true);

            try {
              const docRef = await db.collection('trial_outcomes').add(newData);

              // Log audit trail for outcome creation
              await logAuditTrail('CREATE', 'outcome', docRef.id, null, newData, {
                trial_id: trialId,
                tab_name: 'outcomes',
                form_name: 'outcomeForm'
              });

              showOutcomeFormMessage('Outcome saved successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(async () => {
                await closeOutcomeEditor();
                await loadTabContent('outcome');
              }, 1000);
            } catch (error) {
              // Log error
              await logError('OUTCOME_CREATION_ERROR', error.message, {
                trial_id: trialId,
                form_data: newData,
                action: 'create_outcome'
              });

              showOutcomeFormMessage('Error saving outcome: ' + error.message, true);
            }
          }
        });

        async function openOutcomeEditor(type, outcomeData) {
          const form = document.getElementById('outcomeForm');
          const title = document.getElementById('outcomeEditorTitle');
          const typeCapitalized = type.charAt(0).toUpperCase() + type.slice(1);

          // Clean up existing CKEditor instance first
          await destroyCKEditor('outcomeText');

          title.textContent = `${outcomeData ? 'Edit' : 'Add'} ${typeCapitalized} Outcome`;
          form.outcome_type.value = type;
          form.outcome_edit_id.value = outcomeData ? outcomeData._docId : '';

          document.getElementById('outcomeEditorForm').classList.remove('hidden');
          await createCKEditor('outcomeText', outcomeData ? outcomeData.outcome_text || '' : '');
          showOutcomeFormMessage('');
        }

        async function closeOutcomeEditor() {
          document.getElementById('outcomeEditorForm').classList.add('hidden');
          document.getElementById('outcomeForm').reset();
          await destroyCKEditor('outcomeText');
          showOutcomeFormMessage('');
        }

        function showOutcomeFormMessage(msg, isError = false) {
          const el = document.getElementById('outcomeFormMessage');
          el.textContent = msg;
          el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
          if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
        }
      });
    }

    // === INCLUSION/EXCLUSION TAB ===
    function renderInclusionExclusionTab(container, trialId) {
      db.collection('trial_criteria').where('trial_id', '==', trialId).get().then(querySnapshot => {
        const criteria = {
          inclusion: null,
          exclusion: null,
          other_inclusion: null
        };

        querySnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          criteria[data.criteria_type] = data;
        });

        let html = `
          <div class="mb-4">
            <h3 class="text-xl font-semibold text-blue-900">Inclusion/Exclusion Criteria</h3>
          </div>
        `;
        // Inclusion Criteria Section
        html += `
          <div class="mb-8 bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-blue-800">Inclusion Criteria</h4>
              <button id="editInclusionBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">
                <i class="fas fa-edit mr-1"></i> ${criteria.inclusion ? 'Edit' : 'Add'}
              </button>
            </div>
            <div id="inclusionCriteriaDisplay" class="min-h-[100px] p-4 bg-gray-50 rounded border">
              ${criteria.inclusion ? `<div class="rich-text-display prose prose-sm max-w-none">${criteria.inclusion.criteria_text || ''}</div>` : '<p class="text-gray-500 italic">No inclusion criteria defined yet.</p>'}
            </div>
          </div>
        `;

        // Exclusion Criteria Section
        html += `
          <div class="mb-8 bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-blue-800">Exclusion Criteria</h4>
              <button id="editExclusionBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">
                <i class="fas fa-edit mr-1"></i> ${criteria.exclusion ? 'Edit' : 'Add'}
              </button>
            </div>
            <div id="exclusionCriteriaDisplay" class="min-h-[100px] p-4 bg-gray-50 rounded border">
              ${criteria.exclusion ? `<div class="rich-text-display prose prose-sm max-w-none">${criteria.exclusion.criteria_text || ''}</div>` : '<p class="text-gray-500 italic">No exclusion criteria defined yet.</p>'}
            </div>
          </div>
        `;

        // Other Inclusion Criteria Section
        html += `
          <div class="mb-8 bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
            <div class="flex justify-between items-center mb-4">
              <h4 class="text-lg font-semibold text-blue-800">Other Inclusion Criteria</h4>
              <button id="editOtherInclusionBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">
                <i class="fas fa-edit mr-1"></i> ${criteria.other_inclusion ? 'Edit' : 'Add'}
              </button>
            </div>
            <div id="otherInclusionCriteriaDisplay" class="min-h-[100px] p-4 bg-gray-50 rounded border">
              ${criteria.other_inclusion ? `<div class="rich-text-display prose prose-sm max-w-none">${criteria.other_inclusion.criteria_text || ''}</div>` : '<p class="text-gray-500 italic">No other inclusion criteria defined yet.</p>'}
            </div>
          </div>
        `;

        // Criteria Editor Form (hidden initially)
        html += `
          <div id="criteriaEditorForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h4 id="criteriaEditorTitle" class="text-xl font-semibold text-blue-900">Edit Criteria</h4>
                <button id="closeCriteriaEditor" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>

              <form id="criteriaForm" novalidate>
                <input type="hidden" id="criteriaType" name="criteria_type" value="" />
                <input type="hidden" id="criteriaEditId" name="criteria_edit_id" value="" />

                <div class="mb-4">
                  <label for="criteriaText" class="block font-medium mb-2">Criteria Details *</label>
                  <div id="criteriaText"></div>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                  <button type="button" id="cancelCriteriaBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">
                    Cancel
                  </button>
                  <button type="submit" class="bg-blue-600 text-white font-semibold rounded px-6 py-2 hover:bg-blue-700 transition">
                    <i class="fas fa-save mr-2"></i> Save Criteria
                  </button>
                </div>
                <div id="criteriaFormMessage" class="text-sm mt-2"></div>
              </form>
            </div>
          </div>
        `;

        container.innerHTML = html;

        // Event handlers for criteria editing
        const criteriaTypes = [
          { type: 'inclusion', btnId: 'editInclusionBtn' },
          { type: 'exclusion', btnId: 'editExclusionBtn' },
          { type: 'other_inclusion', btnId: 'editOtherInclusionBtn' }
        ];

        criteriaTypes.forEach(({ type, btnId }) => {
          const editBtn = document.getElementById(btnId);
          editBtn.addEventListener('click', () => {
            openCriteriaEditor(type, criteria[type]);
          });
        });



        // Close editor handlers
        document.getElementById('closeCriteriaEditor').addEventListener('click', closeCriteriaEditor);
        document.getElementById('cancelCriteriaBtn').addEventListener('click', closeCriteriaEditor);

        // Form submission
        document.getElementById('criteriaForm').addEventListener('submit', async e => {
          e.preventDefault();
          const form = e.target;
          const criteria_type = form.criteria_type.value;
          const criteria_text = getCKEditorData('criteriaText').trim();

          if (!criteria_text) {
            showCriteriaFormMessage('Criteria details are required.', true);
            return;
          }

          const editId = form.criteria_edit_id.value;

          if (editId) {
            // Update existing record - don't include created_at
            const updateData = {
              trial_id: trialId,
              criteria_type,
              criteria_text,
              updated_at: new Date()
            };

            // Add user tracking metadata for update
            addUserTrackingToData(updateData, false);

            try {
              await db.collection('trial_criteria').doc(editId).update(updateData);
              showCriteriaFormMessage('Criteria updated successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(async () => {
                await closeCriteriaEditor();
                await loadTabContent('inclusion');
              }, 1000);
            } catch (error) {
              showCriteriaFormMessage('Error updating criteria: ' + error.message, true);
            }
          } else {
            // Create new record - include created_at
            const newData = {
              trial_id: trialId,
              criteria_type,
              criteria_text,
              created_at: new Date(),
              updated_at: new Date()
            };

            // Add user tracking metadata for creation
            addUserTrackingToData(newData, true);

            try {
              await db.collection('trial_criteria').add(newData);
              showCriteriaFormMessage('Criteria saved successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(async () => {
                await closeCriteriaEditor();
                await loadTabContent('inclusion');
              }, 1000);
            } catch (error) {
              showCriteriaFormMessage('Error saving criteria: ' + error.message, true);
            }
          }
        });

        async function openCriteriaEditor(type, criteriaData) {
          const form = document.getElementById('criteriaForm');
          const title = document.getElementById('criteriaEditorTitle');

          // Clean up existing CKEditor instance first
          await destroyCKEditor('criteriaText');

          let typeDisplay = '';
          switch(type) {
            case 'inclusion': typeDisplay = 'Inclusion Criteria'; break;
            case 'exclusion': typeDisplay = 'Exclusion Criteria'; break;
            case 'other_inclusion': typeDisplay = 'Other Inclusion Criteria'; break;
          }

          title.textContent = `${criteriaData ? 'Edit' : 'Add'} ${typeDisplay}`;
          form.criteria_type.value = type;
          form.criteria_edit_id.value = criteriaData ? criteriaData._docId : '';

          document.getElementById('criteriaEditorForm').classList.remove('hidden');
          await createCKEditor('criteriaText', criteriaData ? criteriaData.criteria_text || '' : '');
          showCriteriaFormMessage('');
        }

        async function closeCriteriaEditor() {
          document.getElementById('criteriaEditorForm').classList.add('hidden');
          document.getElementById('criteriaForm').reset();
          await destroyCKEditor('criteriaText');
          showCriteriaFormMessage('');
        }

        function showCriteriaFormMessage(msg, isError = false) {
          const el = document.getElementById('criteriaFormMessage');
          el.textContent = msg;
          el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
          if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
        }
      });
    }

    // === SAFETY ASSESSMENTS TAB ===
    function renderSafetyAssessmentsTab(container, trialId) {
      db.collection('trial_safety_assessments').where('trial_id', '==', trialId).get().then(querySnapshot => {
        const safetyRecords = [];

        querySnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          safetyRecords.push(data);
        });

        let html = `
          <div class="mb-4">
            <h3 class="text-xl font-semibold text-blue-900">Safety Assessments</h3>
            <p class="text-gray-600 mt-2"></p>
          </div>

          <div class="mb-6">
            <button id="addSafetyRecordBtn" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 transition font-semibold">
              <i class="fas fa-plus mr-2"></i> Add New Safety Assessment Record
            </button>
          </div>
        `;

        // Display existing safety records
        if (safetyRecords.length === 0) {
          html += `
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
              <i class="fas fa-shield-alt text-gray-400 text-4xl mb-4"></i>
              <p class="text-gray-600 text-lg">No safety assessment records found.</p>
              <p class="text-gray-500 mt-2">Click "Add New Safety Assessment Record" to get started.</p>
            </div>
          `;
        } else {
          safetyRecords.forEach((record, index) => {
            html += `
              <div class="mb-6 bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500">
                <div class="flex justify-between items-center mb-4">
                  <div>
                    <h4 class="text-lg font-semibold text-blue-800">Safety Assessment Record #${index + 1}</h4>
                    ${record.source || record.link ? `
                      <div class="bg-gray-100 text-gray-600 px-3 py-2 mt-2 rounded border">
                        ${record.link ?
                          `<a href="${record.link}" target="_blank" class="text-gray-700 hover:text-blue-600 font-medium text-sm underline decoration-dotted">
                            <i class="fas fa-external-link-alt mr-1 text-xs"></i>${record.source || 'Unknown Source'}
                          </a>` :
                          `<span class="text-gray-700 font-medium text-sm">${record.source || 'No Source'}</span>`
                        }
                      </div>
                    ` : ''}
                  </div>
                  <div class="flex gap-2">
                    <button class="edit-safety-record-btn bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm" data-doc-id="${record._docId}">
                      <i class="fas fa-edit mr-1"></i> Edit
                    </button>
                    <button class="delete-safety-record-btn bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition text-sm" data-doc-id="${record._docId}">
                      <i class="fas fa-trash mr-1"></i> Delete
                    </button>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  ${record.grade_3_aes ? `
                    <div class="bg-red-50 p-4 rounded border-l-4 border-red-500">
                      <h5 class="font-semibold text-red-800 mb-2">Grade ≥3 AEs</h5>
                      <div class="rich-text-display prose prose-sm max-w-none text-sm">${record.grade_3_aes}</div>
                    </div>
                  ` : ''}

                  ${record.general_aes ? `
                    <div class="bg-orange-50 p-4 rounded border-l-4 border-orange-500">
                      <h5 class="font-semibold text-orange-800 mb-2">General AEs</h5>
                      <div class="rich-text-display prose prose-sm max-w-none text-sm">${record.general_aes}</div>
                    </div>
                  ` : ''}

                  ${record.grade_3_specific_aes ? `
                    <div class="bg-red-50 p-4 rounded border-l-4 border-red-500">
                      <h5 class="font-semibold text-red-800 mb-2">Grade ≥3 Specific AEs</h5>
                      <div class="rich-text-display prose prose-sm max-w-none text-sm">${record.grade_3_specific_aes}</div>
                    </div>
                  ` : ''}

                  ${record.specific_aes ? `
                    <div class="bg-yellow-50 p-4 rounded border-l-4 border-yellow-500">
                      <h5 class="font-semibold text-yellow-800 mb-2">Specific AEs</h5>
                      <div class="rich-text-display prose prose-sm max-w-none text-sm">${record.specific_aes}</div>
                    </div>
                  ` : ''}

                  ${record.grade_5_death ? `
                    <div class="bg-red-50 p-4 rounded border-l-4 border-red-500">
                      <h5 class="font-semibold text-red-800 mb-2">Grade 5/Death</h5>
                      <div class="rich-text-display prose prose-sm max-w-none text-sm">${record.grade_5_death}</div>
                    </div>
                  ` : ''}

                  ${record.treatment_discontinuation ? `
                    <div class="bg-purple-50 p-4 rounded border-l-4 border-purple-500">
                      <h5 class="font-semibold text-purple-800 mb-2">Treatment Discontinuation</h5>
                      <div class="rich-text-display prose prose-sm max-w-none text-sm">${record.treatment_discontinuation}</div>
                    </div>
                  ` : ''}
                </div>

                <!-- User Tracking Information -->
                ${formatUserTrackingInfo(record)}
              </div>
            `;
          });
        }

        // Safety Assessment Editor Form (hidden initially)
        html += `
          <div id="safetyEditorForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h4 id="safetyEditorTitle" class="text-xl font-semibold text-blue-900">Safety Assessment Record</h4>
                <button id="closeSafetyEditor" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>

              <form id="safetyForm" novalidate>
                <input type="hidden" id="safetyEditId" name="safety_edit_id" value="" />

                <!-- Source Information -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg border">
                  <h5 class="text-lg font-semibold text-blue-800 mb-3">Source Information</h5>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label for="safetySource" class="block font-medium mb-2">Source *</label>
                      <input type="text" id="safetySource" name="source" required
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter source information">
                    </div>
                    <div>
                      <label for="safetyLink" class="block font-medium mb-2">Link</label>
                      <input type="url" id="safetyLink" name="link"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter source link">
                    </div>
                  </div>
                </div>

                <!-- Safety Assessment Categories -->
                <div class="space-y-6">
                  <!-- Grade ≥3 AEs -->
                  <div class="p-4 bg-red-50 rounded-lg border">
                    <h5 class="text-lg font-semibold text-red-800 mb-3">Grade ≥3 AEs</h5>
                    <div id="grade3AesText"></div>
                  </div>

                  <!-- General AEs -->
                  <div class="p-4 bg-orange-50 rounded-lg border">
                    <h5 class="text-lg font-semibold text-orange-800 mb-3">General AEs</h5>
                    <div id="generalAesText"></div>
                  </div>

                  <!-- Grade ≥3 Specific AEs -->
                  <div class="p-4 bg-red-50 rounded-lg border">
                    <h5 class="text-lg font-semibold text-red-800 mb-3">Grade ≥3 Specific AEs</h5>
                    <div id="grade3SpecificAesText"></div>
                  </div>

                  <!-- Specific AEs -->
                  <div class="p-4 bg-yellow-50 rounded-lg border">
                    <h5 class="text-lg font-semibold text-yellow-800 mb-3">Specific AEs</h5>
                    <div id="specificAesText"></div>
                  </div>

                  <!-- Grade 5/Death -->
                  <div class="p-4 bg-red-50 rounded-lg border">
                    <h5 class="text-lg font-semibold text-red-800 mb-3">Grade 5/Death</h5>
                    <div id="grade5DeathText"></div>
                  </div>

                  <!-- Treatment Discontinuation -->
                  <div class="p-4 bg-purple-50 rounded-lg border">
                    <h5 class="text-lg font-semibold text-purple-800 mb-3">Treatment Discontinuation</h5>
                    <div id="treatmentDiscontinuationText"></div>
                  </div>
                </div>



                <div class="flex justify-end gap-4 mt-6">
                  <button type="button" id="cancelSafetyBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">
                    Cancel
                  </button>
                  <button type="submit" class="bg-blue-600 text-white font-semibold rounded px-6 py-2 hover:bg-blue-700 transition">
                    <i class="fas fa-save mr-2"></i> Save Safety Assessment
                  </button>
                </div>
                <div id="safetyFormMessage" class="text-sm mt-2"></div>
              </form>
            </div>
          </div>
        `;

        container.innerHTML = html;

        // Event handlers for adding new safety record
        document.getElementById('addSafetyRecordBtn').addEventListener('click', () => {
          openSafetyEditor();
        });

        // Event handlers for editing existing safety records
        container.querySelectorAll('.edit-safety-record-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const docId = e.target.closest('.edit-safety-record-btn').getAttribute('data-doc-id');
            const record = safetyRecords.find(r => r._docId === docId);
            openSafetyEditor(record);
          });
        });

        // Event handlers for deleting safety records
        container.querySelectorAll('.delete-safety-record-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const docId = e.target.closest('.delete-safety-record-btn').getAttribute('data-doc-id');
            if (confirm('Are you sure you want to delete this safety assessment record?')) {
              try {
                await db.collection('trial_safety_assessments').doc(docId).delete();
                alert('Safety assessment record deleted successfully.');
                await loadTabContent('safetyAssessments');
              } catch (error) {
                alert('Error deleting safety assessment record: ' + error.message);
              }
            }
          });
        });



        // Close editor handlers
        document.getElementById('closeSafetyEditor').addEventListener('click', closeSafetyEditor);
        document.getElementById('cancelSafetyBtn').addEventListener('click', closeSafetyEditor);

        // Safety assessment form submission
        document.getElementById('safetyForm').addEventListener('submit', e => {
          e.preventDefault();
          const form = e.target;
          const editId = form.safety_edit_id.value;
          const source = form.source.value.trim();

          if (!source) {
            showSafetyFormMessage('Source is required.', true);
            return;
          }

          // Collect all safety assessment data
          const updateData = {
            trial_id: trialId,
            source: source,
            link: form.link.value.trim(),
            grade_3_aes: getCKEditorData('grade3AesText').trim(),
            general_aes: getCKEditorData('generalAesText').trim(),
            grade_3_specific_aes: getCKEditorData('grade3SpecificAesText').trim(),
            specific_aes: getCKEditorData('specificAesText').trim(),
            grade_5_death: getCKEditorData('grade5DeathText').trim(),
            treatment_discontinuation: getCKEditorData('treatmentDiscontinuationText').trim(),
            updated_at: new Date()
          };

          // Add user tracking metadata
          addUserTrackingToData(updateData, !editId); // isCreation = true if no editId

          // If editing existing record, update it; otherwise create new
          if (editId) {
            db.collection('trial_safety_assessments').doc(editId).update(updateData).then(async () => {
              showSafetyFormMessage('Safety assessment record updated successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(() => {
                closeSafetyEditor();
                loadTabContent('safetyAssessments');
              }, 1000);
            }).catch(error => {
              showSafetyFormMessage('Error updating safety assessment: ' + error.message, true);
            });
          } else {
            updateData.created_at = new Date();
            db.collection('trial_safety_assessments').add(updateData).then(async () => {
              showSafetyFormMessage('Safety assessment record saved successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(() => {
                closeSafetyEditor();
                loadTabContent('safetyAssessments');
              }, 1000);
            }).catch(error => {
              showSafetyFormMessage('Error saving safety assessment: ' + error.message, true);
            });
          }
        });

        async function openSafetyEditor(record = null) {
          const title = document.getElementById('safetyEditorTitle');

          // Clean up existing CKEditor instances first
          await destroyCKEditor('grade3AesText');
          await destroyCKEditor('generalAesText');
          await destroyCKEditor('grade3SpecificAesText');
          await destroyCKEditor('specificAesText');
          await destroyCKEditor('grade5DeathText');
          await destroyCKEditor('treatmentDiscontinuationText');

          document.getElementById('safetyEditorForm').classList.remove('hidden');

          // Create CKEditor instances for all 6 fields
          await createCKEditor('grade3AesText', record ? record.grade_3_aes || '' : '');
          await createCKEditor('generalAesText', record ? record.general_aes || '' : '');
          await createCKEditor('grade3SpecificAesText', record ? record.grade_3_specific_aes || '' : '');
          await createCKEditor('specificAesText', record ? record.specific_aes || '' : '');
          await createCKEditor('grade5DeathText', record ? record.grade_5_death || '' : '');
          await createCKEditor('treatmentDiscontinuationText', record ? record.treatment_discontinuation || '' : '');

          if (record) {
            // Editing existing record
            title.textContent = 'Edit Safety Assessment Record';
            document.getElementById('safetyEditId').value = record._docId;
            document.getElementById('safetySource').value = record.source || '';
            document.getElementById('safetyLink').value = record.link || '';
          } else {
            // Adding new record
            title.textContent = 'Add New Safety Assessment Record';
            document.getElementById('safetyEditId').value = '';
            document.getElementById('safetySource').value = '';
            document.getElementById('safetyLink').value = '';
          }

          document.getElementById('safetySource').focus();
          showSafetyFormMessage('');
        }

        async function closeSafetyEditor() {
          document.getElementById('safetyEditorForm').classList.add('hidden');
          document.getElementById('safetyForm').reset();
          // Destroy all CKEditor instances
          await destroyCKEditor('grade3AesText');
          await destroyCKEditor('generalAesText');
          await destroyCKEditor('grade3SpecificAesText');
          await destroyCKEditor('specificAesText');
          await destroyCKEditor('grade5DeathText');
          await destroyCKEditor('treatmentDiscontinuationText');
          showSafetyFormMessage('');
        }

        function showSafetyFormMessage(msg, isError = false) {
          const el = document.getElementById('safetyFormMessage');
          el.textContent = msg;
          el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
          if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
        }
      });
    }

    // === RESPONSE ASSESSMENTS TAB ===
    function renderResponseAssessmentTab(container, trialId) {
      db.collection('trial_response_assessments').where('trial_id', '==', trialId).get().then(querySnapshot => {
        const responseRecords = [];

        querySnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          responseRecords.push(data);
        });

        let html = `
          <div class="mb-4">
            <h3 class="text-xl font-semibold text-blue-900">Response Assessment</h3>
            <p class="text-gray-600 mt-2"></p>
          </div>

          <div class="mb-6">
            <button id="addResponseRecordBtn" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 transition font-semibold">
              <i class="fas fa-plus mr-2"></i> Add New Response Assessment
            </button>
          </div>
        `;

        // Display existing response records grouped by source
        if (responseRecords.length === 0) {
          html += `
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
              <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
              <p class="text-gray-600 text-lg">No response assessment records found.</p>
              <p class="text-gray-500 mt-2">Click "Add New Response Assessment" to get started.</p>
            </div>
          `;
        } else {
          // Group records by source
          const groupedRecords = {};
          responseRecords.forEach(record => {
            const sourceKey = record.source || 'Unknown Source';
            if (!groupedRecords[sourceKey]) {
              groupedRecords[sourceKey] = {
                source: record.source,
                link: record.link,
                responses: []
              };
            }
            groupedRecords[sourceKey].responses.push(record);
          });

          // Display grouped records
          Object.keys(groupedRecords).forEach(sourceKey => {
            const group = groupedRecords[sourceKey];
            html += `
              <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                <div class="bg-gray-100 text-gray-600 px-4 py-2 flex justify-between items-center border-b">
                  <div class="flex items-center">
                    ${group.link ?
                      `<a href="${group.link}" target="_blank" class="text-gray-700 hover:text-blue-600 font-medium text-sm underline decoration-dotted">
                        <i class="fas fa-external-link-alt mr-1 text-xs"></i>${group.source || 'Unknown Source'}
                      </a>` :
                      `<span class="text-gray-700 font-medium text-sm">${group.source || 'Unknown Source'}</span>`
                    }
                  </div>
                  <button class="add-response-to-source-btn bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm" data-source="${group.source}" data-link="${group.link || ''}">
                    <i class="fas fa-plus mr-1"></i> Add Response Type
                  </button>
                </div>
                <div class="overflow-x-auto max-h-80 scrollbar-thin border border-gray-300 rounded">
                  <table class="min-w-full border-collapse border border-gray-300 text-sm">
                    <thead class="bg-blue-900 text-white sticky top-0">
                      <tr>
                        <th class="px-2 py-1 text-left">ARM Type</th>
                        <th class="px-2 py-1 text-left">Sub Category</th>
                        <th class="px-2 py-1 text-left">Sub Group</th>
                        <th class="px-2 py-1 text-left">Response Type</th>
                        <th class="px-2 py-1 text-left">Response N</th>
                        <th class="px-2 py-1 text-left">Percentage</th>
                        <th class="px-2 py-1 text-left">Min/Max/P-value</th>
                        <th class="px-2 py-1 text-left">Duration</th>
                        <th class="px-2 py-1 text-left">User Info</th>
                        <th class="px-2 py-1 text-left">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
            `;

            group.responses.forEach((record, index) => {
              const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
              const minMaxP = [
                record.min_value ? `Min:${record.min_value}` : '',
                record.max_value ? `Max:${record.max_value}` : '',
                record.p_value ? `P:${record.p_value}` : ''
              ].filter(Boolean).join(' ');

              const duration = [
                record.median_duration ? `Med:${record.median_duration}` : '',
                record.min_duration ? `Min:${record.min_duration}` : '',
                record.max_duration ? `Max:${record.max_duration}` : '',
                record.duration_format ? `(${record.duration_format})` : ''
              ].filter(Boolean).join(' ');

              const userTrackingColumn = createSingleUserTrackingColumn(record);
              html += `
                <tr class="${rowClass} hover:bg-blue-50 border-t border-gray-200">
                  <td class="px-2 py-1" title="${record.arm_selection || 'N/A'}">${record.arm_selection && record.arm_selection.length > 10 ? record.arm_selection.substring(0, 10) + '...' : record.arm_selection || 'N/A'}</td>
                  <td class="px-2 py-1" title="${record.sub_category || 'N/A'}">${record.sub_category && record.sub_category.length > 10 ? record.sub_category.substring(0, 10) + '...' : record.sub_category || 'N/A'}</td>
                  <td class="px-2 py-1" title="${record.sub_group || 'N/A'}">${record.sub_group && record.sub_group.length > 10 ? record.sub_group.substring(0, 10) + '...' : record.sub_group || 'N/A'}</td>
                  <td class="px-2 py-1" title="${record.response_type || 'N/A'}">${record.response_type && record.response_type.length > 12 ? record.response_type.substring(0, 12) + '...' : record.response_type || 'N/A'}</td>
                  <td class="px-2 py-1">${record.response_n || 'N/A'}</td>
                  <td class="px-2 py-1">${record.percentage ? record.percentage + '%' : 'N/A'}</td>
                  <td class="px-2 py-1" title="${minMaxP || 'N/A'}">${minMaxP && minMaxP.length > 15 ? minMaxP.substring(0, 15) + '...' : minMaxP || 'N/A'}</td>
                  <td class="px-2 py-1" title="${duration || 'N/A'}">${duration && duration.length > 15 ? duration.substring(0, 15) + '...' : duration || 'N/A'}</td>
                  ${userTrackingColumn}
                  <td class="px-2 py-1">
                    <button class="edit-response-btn text-blue-700 hover:underline text-sm" data-doc-id="${record._docId}" title="Edit">Edit</button>
                    <button class="delete-response-btn text-red-600 hover:underline text-sm ml-2" data-doc-id="${record._docId}" title="Delete">Delete</button>
                  </td>
                </tr>
              `;
            });

            html += `
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          });
        }

        // Response Assessment Editor Form (hidden initially)
        html += `
          <div id="responseEditorForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h4 id="responseEditorTitle" class="text-xl font-semibold text-blue-900">Response Assessment Record</h4>
                <button id="closeResponseEditor" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>

              <form id="responseForm" novalidate>
                <input type="hidden" id="responseEditId" name="response_edit_id" value="" />

                <!-- Source Information -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg border">
                  <h5 class="text-lg font-semibold text-blue-800 mb-3">Source Information</h5>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label for="responseSource" class="block font-medium mb-2">Source *</label>
                      <input type="text" id="responseSource" name="source" required
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter source information">
                    </div>
                    <div>
                      <label for="responseLink" class="block font-medium mb-2">Link</label>
                      <input type="url" id="responseLink" name="link"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter source link">
                    </div>
                  </div>
                </div>

                <!-- ARM Selection Section -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg border">
                  <h5 class="text-lg font-semibold text-blue-700 mb-3">ARM Selection</h5>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label for="responseArmSelection" class="block font-medium mb-2">ARM Type</label>
                      <select id="responseArmSelection" name="arm_selection"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        <option value="">Select ARM Type</option>
                      </select>
                    </div>
                    <div>
                      <label for="responseSubCategory" class="block font-medium mb-2">Sub Category</label>
                      <input type="text" id="responseSubCategory" name="sub_category"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter sub category">
                    </div>
                    <div>
                      <label for="responseSubGroup" class="block font-medium mb-2">Sub Group</label>
                      <input type="text" id="responseSubGroup" name="sub_group"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter sub group">
                    </div>
                  </div>
                </div>

                <!-- Response Assessment Data -->
                <div class="space-y-6">
                  <!-- Response Type and N -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label for="responseType" class="block font-medium mb-2">Response Type *</label>
                      <select id="responseType" name="response_type" required
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                        <option value="">Select Response Type</option>
                        <option value="Complete Response (CR)">Complete Response (CR)</option>
                        <option value="Partial Response (PR)">Partial Response (PR)</option>
                        <option value="Stable Disease (SD)">Stable Disease (SD)</option>
                        <option value="Progressive Disease (PD)">Progressive Disease (PD)</option>
                        <option value="Overall Response Rate (ORR)">Overall Response Rate (ORR)</option>
                        <option value="Disease Control Rate (DCR)">Disease Control Rate (DCR)</option>
                        <option value="Clinical Benefit Rate (CBR)">Clinical Benefit Rate (CBR)</option>
                        <option value="Objective Response Rate">Objective Response Rate</option>
                        <option value="Best Overall Response">Best Overall Response</option>
                        <option value="Confirmed Response">Confirmed Response</option>
                        <option value="Unconfirmed Response">Unconfirmed Response</option>
                        <option value="Not Evaluable (NE)">Not Evaluable (NE)</option>
                      </select>
                    </div>
                    <div>
                      <label for="responseN" class="block font-medium mb-2">Response N</label>
                      <input type="number" id="responseN" name="response_n" min="0"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter number of patients">
                    </div>
                  </div>

                  <!-- Percentage -->
                  <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
                    <div>
                      <label for="percentage" class="block font-medium mb-2">Percentage (%)</label>
                      <input type="number" id="percentage" name="percentage" min="0" max="100" step="0.1"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter percentage">
                    </div>
                  </div>

                  <!-- Min, Max, P-value -->
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label for="minValue" class="block font-medium mb-2">Min Value</label>
                      <input type="number" id="minValue" name="min_value" step="0.001"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter minimum value">
                    </div>
                    <div>
                      <label for="maxValue" class="block font-medium mb-2">Max Value</label>
                      <input type="number" id="maxValue" name="max_value" step="0.001"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter maximum value">
                    </div>
                    <div>
                      <label for="pValue" class="block font-medium mb-2">P-value</label>
                      <input type="number" id="pValue" name="p_value" step="0.0001" min="0" max="1"
                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                        placeholder="Enter p-value">
                    </div>
                  </div>

                  <!-- Duration Information -->
                  <div class="p-4 bg-blue-50 rounded-lg border">
                    <h5 class="text-lg font-semibold text-blue-700 mb-3">Duration Information</h5>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div>
                        <label for="medianDuration" class="block font-medium mb-2">Median Duration</label>
                        <input type="number" id="medianDuration" name="median_duration" step="0.1"
                          class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                          placeholder="Median">
                      </div>
                      <div>
                        <label for="minDuration" class="block font-medium mb-2">Min Duration</label>
                        <input type="number" id="minDuration" name="min_duration" step="0.1"
                          class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                          placeholder="Minimum">
                      </div>
                      <div>
                        <label for="maxDuration" class="block font-medium mb-2">Max Duration</label>
                        <input type="number" id="maxDuration" name="max_duration" step="0.1"
                          class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                          placeholder="Maximum">
                      </div>
                      <div>
                        <label for="durationFormat" class="block font-medium mb-2">Duration Format</label>
                        <select id="durationFormat" name="duration_format"
                          class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                          <option value="">Select Format</option>
                          <option value="Days">Days</option>
                          <option value="Weeks">Weeks</option>
                          <option value="Months">Months</option>
                          <option value="Years">Years</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                  <button type="button" id="cancelResponseBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">
                    Cancel
                  </button>
                  <button type="submit" class="bg-blue-600 text-white font-semibold rounded px-6 py-2 hover:bg-blue-700 transition">
                    <i class="fas fa-save mr-2"></i> Save Response Assessment
                  </button>
                </div>
                <div id="responseFormMessage" class="text-sm mt-2"></div>
              </form>
            </div>
          </div>
        `;

        container.innerHTML = html;

        // Event handlers for adding new response record
        document.getElementById('addResponseRecordBtn').addEventListener('click', () => {
          openResponseEditor();
        });

        // Event handlers for adding response type to existing source
        container.querySelectorAll('.add-response-to-source-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const source = e.target.closest('.add-response-to-source-btn').getAttribute('data-source');
            const link = e.target.closest('.add-response-to-source-btn').getAttribute('data-link');
            openResponseEditor(null, source, link);
          });
        });

        // Event handlers for editing existing response records
        container.querySelectorAll('.edit-response-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const docId = e.target.closest('.edit-response-btn').getAttribute('data-doc-id');
            const record = responseRecords.find(r => r._docId === docId);
            openResponseEditor(record);
          });
        });

        // Event handlers for deleting response records
        container.querySelectorAll('.delete-response-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const docId = e.target.closest('.delete-response-btn').getAttribute('data-doc-id');
            if (confirm('Are you sure you want to delete this response assessment record?')) {
              db.collection('trial_response_assessments').doc(docId).delete().then(() => {
                alert('Response assessment record deleted successfully.');
                loadTabContent('responseAssessment');
              }).catch(error => {
                alert('Error deleting response assessment record: ' + error.message);
              });
            }
          });
        });

        // Close editor handlers
        document.getElementById('closeResponseEditor').addEventListener('click', closeResponseEditor);
        document.getElementById('cancelResponseBtn').addEventListener('click', closeResponseEditor);

        // Response assessment form submission
        document.getElementById('responseForm').addEventListener('submit', e => {
          e.preventDefault();
          const form = e.target;
          const editId = form.response_edit_id.value;
          const source = form.source.value.trim();
          const responseType = form.response_type.value.trim();

          if (!source) {
            showResponseFormMessage('Source is required.', true);
            return;
          }

          if (!responseType) {
            showResponseFormMessage('Response Type is required.', true);
            return;
          }

          // Collect all response assessment data
          const updateData = {
            trial_id: trialId,
            source: source,
            link: form.link.value.trim(),
            arm_selection: form.arm_selection.value.trim() || null,
            sub_category: form.sub_category.value.trim() || null,
            sub_group: form.sub_group.value.trim() || null,
            response_type: responseType,
            response_n: form.response_n.value ? parseInt(form.response_n.value) : null,
            percentage: form.percentage.value ? parseFloat(form.percentage.value) : null,
            min_value: form.min_value.value ? parseFloat(form.min_value.value) : null,
            max_value: form.max_value.value ? parseFloat(form.max_value.value) : null,
            p_value: form.p_value.value ? parseFloat(form.p_value.value) : null,
            median_duration: form.median_duration.value ? parseFloat(form.median_duration.value) : null,
            min_duration: form.min_duration.value ? parseFloat(form.min_duration.value) : null,
            max_duration: form.max_duration.value ? parseFloat(form.max_duration.value) : null,
            duration_format: form.duration_format.value.trim(),
            updated_at: new Date()
          };

          // Add user tracking metadata
          addUserTrackingToData(updateData, !editId); // isCreation = true if no editId

          // If editing existing record, update it; otherwise create new
          if (editId) {
            db.collection('trial_response_assessments').doc(editId).update(updateData).then(async () => {
              showResponseFormMessage('Response assessment record updated successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(() => {
                closeResponseEditor();
                loadTabContent('responseAssessment');
              }, 1000);
            }).catch(error => {
              showResponseFormMessage('Error updating response assessment: ' + error.message, true);
            });
          } else {
            updateData.created_at = new Date();
            db.collection('trial_response_assessments').add(updateData).then(async () => {
              showResponseFormMessage('Response assessment record saved successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(() => {
                closeResponseEditor();
                loadTabContent('responseAssessment');
              }, 1000);
            }).catch(error => {
              showResponseFormMessage('Error saving response assessment: ' + error.message, true);
            });
          }
        });

        async function openResponseEditor(record = null, prefilledSource = null, prefilledLink = null) {
          console.log('Opening response editor...');
          const title = document.getElementById('responseEditorTitle');

          // Load ARM data for dropdown
          loadArmDataForResponse();

          // Load response types and duration formats from Firestore
          console.log('Loading response types dropdown...');
          await loadDropdownFromFirestore('response_types', 'responseType');
          console.log('Loading duration formats dropdown...');
          await loadDropdownFromFirestore('duration_formats', 'durationFormat');

          if (record) {
            // Editing existing record
            title.textContent = 'Edit Response Assessment Record';
            document.getElementById('responseEditId').value = record._docId;
            document.getElementById('responseSource').value = record.source || '';
            document.getElementById('responseLink').value = record.link || '';
            document.getElementById('responseArmSelection').value = record.arm_selection || '';
            document.getElementById('responseSubCategory').value = record.sub_category || '';
            document.getElementById('responseSubGroup').value = record.sub_group || '';
            document.getElementById('responseType').value = record.response_type || '';
            document.getElementById('responseN').value = record.response_n || '';
            document.getElementById('percentage').value = record.percentage || '';
            document.getElementById('minValue').value = record.min_value || '';
            document.getElementById('maxValue').value = record.max_value || '';
            document.getElementById('pValue').value = record.p_value || '';
            document.getElementById('medianDuration').value = record.median_duration || '';
            document.getElementById('minDuration').value = record.min_duration || '';
            document.getElementById('maxDuration').value = record.max_duration || '';
            document.getElementById('durationFormat').value = record.duration_format || '';
          } else {
            // Adding new record
            if (prefilledSource) {
              title.textContent = `Add Response Type to: ${prefilledSource}`;
            } else {
              title.textContent = 'Add New Response Assessment Record';
            }
            document.getElementById('responseEditId').value = '';
            document.getElementById('responseSource').value = prefilledSource || '';
            document.getElementById('responseLink').value = prefilledLink || '';
            document.getElementById('responseArmSelection').value = '';
            document.getElementById('responseSubCategory').value = '';
            document.getElementById('responseSubGroup').value = '';
            document.getElementById('responseType').value = '';
            document.getElementById('responseN').value = '';
            document.getElementById('percentage').value = '';
            document.getElementById('minValue').value = '';
            document.getElementById('maxValue').value = '';
            document.getElementById('pValue').value = '';
            document.getElementById('medianDuration').value = '';
            document.getElementById('minDuration').value = '';
            document.getElementById('maxDuration').value = '';
            document.getElementById('durationFormat').value = '';
          }

          // If source is prefilled, make it readonly and focus on response type
          const sourceField = document.getElementById('responseSource');
          const linkField = document.getElementById('responseLink');
          if (prefilledSource) {
            sourceField.readOnly = true;
            linkField.readOnly = true;
            sourceField.classList.add('bg-gray-100');
            linkField.classList.add('bg-gray-100');
            document.getElementById('responseType').focus();
          } else {
            sourceField.readOnly = false;
            linkField.readOnly = false;
            sourceField.classList.remove('bg-gray-100');
            linkField.classList.remove('bg-gray-100');
            sourceField.focus();
          }

          document.getElementById('responseEditorForm').classList.remove('hidden');
          showResponseFormMessage('');
        }

        function closeResponseEditor() {
          document.getElementById('responseEditorForm').classList.add('hidden');
          document.getElementById('responseForm').reset();
          showResponseFormMessage('');
        }

        function showResponseFormMessage(msg, isError = false) {
          const el = document.getElementById('responseFormMessage');
          el.textContent = msg;
          el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
          if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
        }

        function loadArmDataForResponse() {
          // Load ARM data from trial_arms collection
          db.collection('trial_arms').where('trial_id', '==', trialId).get().then(querySnapshot => {
            const armSelect = document.getElementById('responseArmSelection');

            // Clear existing options except the first one
            while (armSelect.children.length > 1) {
              armSelect.removeChild(armSelect.lastChild);
            }

            querySnapshot.forEach(doc => {
              const armData = doc.data();
              const option = document.createElement('option');
              option.value = armData.arm_type;
              option.textContent = armData.arm_type; // Only show ARM type, no products
              armSelect.appendChild(option);
            });
          }).catch(error => {
            console.error('Error loading ARM data:', error);
          });
        }
      });
    }

    // === SURVIVAL DATA TAB ===
    function renderSurvivalDataTab(container, trialId) {
      container.innerHTML = `
        <div class="mb-4">
          <h3 class="text-xl font-semibold text-blue-900">Survival Data - Hazard Ratio Management</h3>
          <p class="text-gray-600 mt-2"></p>
        </div>

        <!-- Main ARM Survival Data Section -->
        <div class="mb-8">
          <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <h4 class="text-lg font-semibold text-blue-800">Main ARM Survival Data</h4>
            <button id="addMainSurvivalBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-sm flex items-center gap-2">
              <i class="fas fa-plus"></i> Add Main ARM Survival Record
            </button>
          </div>
          <div id="mainSurvivalDataContainer" class="bg-white rounded shadow"></div>
        </div>

        <!-- Sub Group Survival Data Section -->
        <div class="mb-8">
          <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <h4 class="text-lg font-semibold text-slate-600">Sub Group Survival Data</h4>
            <button id="addSubGroupSurvivalBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition text-sm flex items-center gap-2">
              <i class="fas fa-plus"></i> Add Sub Group Survival Record
            </button>
          </div>
          <div id="subGroupSurvivalDataContainer" class="bg-white rounded shadow"></div>
        </div>
      `;

      // Load both main and sub group survival data
      loadMainSurvivalData(trialId);
      loadSubGroupSurvivalData(trialId);
      setupSurvivalEventHandlers(trialId);
    }

    function loadMainSurvivalData(trialId) {
      db.collection('survival_data_main').where('trial_id', '==', trialId).get().then(querySnapshot => {
        const mainSurvivalRecords = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          mainSurvivalRecords.push(data);
        });

        const container = document.getElementById('mainSurvivalDataContainer');

        if (mainSurvivalRecords.length === 0) {
          container.innerHTML = `
            <div class="p-6 text-center text-gray-500">
              <i class="fas fa-chart-line text-4xl mb-4"></i>
              <p>No main ARM survival data records found.</p>
              <p class="text-sm mt-2">Click "Add Main ARM Survival Record" to get started.</p>
            </div>
          `;
        } else {
          let html = `
            <div class="overflow-x-auto max-h-80 scrollbar-thin border border-gray-300 rounded">
              <table class="min-w-full border-collapse border border-gray-300 text-sm">
                <thead class="bg-blue-900 text-white sticky top-0">
                  <tr>
                    <th class="px-2 py-1 text-left">MFU</th>
                    <th class="px-2 py-1 text-left">Unit</th>
                    <th class="px-2 py-1 text-left">N(Arm1)</th>
                    <th class="px-2 py-1 text-left">N(Arm2)</th>
                    <th class="px-2 py-1 text-left">Assessment</th>
                    <th class="px-2 py-1 text-left">Modifier</th>
                    <th class="px-2 py-1 text-left">Endpoint</th>
                    <th class="px-2 py-1 text-left">HR</th>
                    <th class="px-2 py-1 text-left">95% CI</th>
                    <th class="px-2 py-1 text-left">P-Value</th>
                    <th class="px-2 py-1 text-left">Source</th>
                    <th class="px-2 py-1 text-left">User Info</th>
                    <th class="px-2 py-1 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody>
          `;

          mainSurvivalRecords.forEach((record, index) => {
            const ci_display = record.min_95_ci && record.max_95_ci ?
              `${record.min_95_ci}-${record.max_95_ci}` :
              (record.min_95_ci || record.max_95_ci || 'N/A');

            const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

            const userTrackingColumn = createSingleUserTrackingColumn(record);
            html += `
              <tr class="${rowClass} hover:bg-blue-50 border-t border-gray-200">
                <td class="px-2 py-1">${record.mfu || 'N/A'}</td>
                <td class="px-2 py-1">${record.mfu_unit || 'N/A'}</td>
                <td class="px-2 py-1">${record.arm1_n || 'N/A'}</td>
                <td class="px-2 py-1">${record.arm2_n || 'N/A'}</td>
                <td class="px-2 py-1" title="${record.assessment_type || 'N/A'}">${record.assessment_type && record.assessment_type.length > 12 ? record.assessment_type.substring(0, 12) + '...' : record.assessment_type || 'N/A'}</td>
                <td class="px-2 py-1" title="${record.modifier_text || 'N/A'}">${record.modifier_text && record.modifier_text.length > 12 ? record.modifier_text.substring(0, 12) + '...' : record.modifier_text || 'N/A'}</td>
                <td class="px-2 py-1" title="${record.endpoint || 'N/A'}">${record.endpoint && record.endpoint.length > 12 ? record.endpoint.substring(0, 12) + '...' : record.endpoint || 'N/A'}</td>
                <td class="px-2 py-1">${record.hazard_ratio || 'N/A'}</td>
                <td class="px-2 py-1">${ci_display}</td>
                <td class="px-2 py-1">${record.pvalue || 'N/A'}</td>
                <td class="px-2 py-1">
                  ${record.source_url && record.source_url.trim() !== "" ?
                    `<a href="${record.source_url}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm" title="${record.source_url}">
                      <i class="fas fa-external-link-alt mr-1 text-xs"></i>${record.source && record.source.length > 12 ? record.source.substring(0, 12) + '...' : record.source || 'Unknown Source'}
                    </a>` :
                    `<span class="text-gray-700 text-sm" title="${record.source || 'N/A'}">${record.source && record.source.length > 12 ? record.source.substring(0, 12) + '...' : record.source || 'No Source'}</span>`
                  }
                </td>
                ${userTrackingColumn}
                <td class="px-2 py-1">
                  <button class="edit-main-survival-btn text-blue-700 hover:underline text-sm" data-doc-id="${record._docId}" title="Edit">Edit</button>
                  <button class="delete-main-survival-btn text-red-600 hover:underline text-sm ml-2" data-doc-id="${record._docId}" title="Delete">Delete</button>
                </td>
              </tr>
            `;
          });

          html += `
                </tbody>
              </table>
            </div>
          `;
          container.innerHTML = html;
        }
      }).catch(error => {
        console.error('Error loading main survival data:', error);
        document.getElementById('mainSurvivalDataContainer').innerHTML = `
          <div class="p-6 text-center text-red-500">
            <p>Error loading main survival data: ${error.message}</p>
          </div>
        `;
      });
    }

    function loadSubGroupSurvivalData(trialId) {
      db.collection('survival_data_subgroup').where('trial_id', '==', trialId).get().then(querySnapshot => {
        const subGroupSurvivalRecords = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          subGroupSurvivalRecords.push(data);
        });

        const container = document.getElementById('subGroupSurvivalDataContainer');

        if (subGroupSurvivalRecords.length === 0) {
          container.innerHTML = `
            <div class="p-6 text-center text-gray-500">
              <i class="fas fa-users text-4xl mb-4"></i>
              <p>No sub group survival data records found.</p>
              <p class="text-sm mt-2">Click "Add Sub Group Survival Record" to get started.</p>
            </div>
          `;
        } else {
          let html = `
            <div class="overflow-x-auto max-h-80 scrollbar-thin border border-gray-300 rounded">
              <table class="min-w-full border-collapse border border-gray-300 text-sm">
                <thead class="bg-blue-900 text-white sticky top-0">
                  <tr>
                    <th class="px-2 py-1 text-left">MFU</th>
                    <th class="px-2 py-1 text-left">Unit</th>
                    <th class="px-2 py-1 text-left">Sub Group</th>
                    <th class="px-2 py-1 text-left">Category</th>
                    <th class="px-2 py-1 text-left">N(Arm1)</th>
                    <th class="px-2 py-1 text-left">N(Arm2)</th>
                    <th class="px-2 py-1 text-left">Assessment</th>
                    <th class="px-2 py-1 text-left">Modifier</th>
                    <th class="px-2 py-1 text-left">Endpoint</th>
                    <th class="px-2 py-1 text-left">HR</th>
                    <th class="px-2 py-1 text-left">95% CI</th>
                    <th class="px-2 py-1 text-left">P-Value</th>
                    <th class="px-2 py-1 text-left">Source</th>
                    <th class="px-2 py-1 text-left">User Info</th>
                    <th class="px-2 py-1 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody>
          `;

          subGroupSurvivalRecords.forEach((record, index) => {
            const ci_display = record.min_95_ci && record.max_95_ci ?
              `${record.min_95_ci}-${record.max_95_ci}` :
              (record.min_95_ci || record.max_95_ci || 'N/A');

            const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

            const userTrackingColumn = createSingleUserTrackingColumn(record);
            html += `
              <tr class="${rowClass} hover:bg-blue-50 border-t border-gray-200">
                <td class="px-2 py-1">${record.mfu || 'N/A'}</td>
                <td class="px-2 py-1">${record.mfu_unit || 'N/A'}</td>
                <td class="px-2 py-1" title="${record.sub_group || 'N/A'}">${record.sub_group && record.sub_group.length > 10 ? record.sub_group.substring(0, 10) + '...' : record.sub_group || 'N/A'}</td>
                <td class="px-2 py-1" title="${record.sub_group_category || 'N/A'}">${record.sub_group_category && record.sub_group_category.length > 10 ? record.sub_group_category.substring(0, 10) + '...' : record.sub_group_category || 'N/A'}</td>
                <td class="px-2 py-1">${record.arm1_n || 'N/A'}</td>
                <td class="px-2 py-1">${record.arm2_n || 'N/A'}</td>
                <td class="px-2 py-1" title="${record.assessment_type || 'N/A'}">${record.assessment_type && record.assessment_type.length > 10 ? record.assessment_type.substring(0, 10) + '...' : record.assessment_type || 'N/A'}</td>
                <td class="px-2 py-1" title="${record.modifier_text || 'N/A'}">${record.modifier_text && record.modifier_text.length > 10 ? record.modifier_text.substring(0, 10) + '...' : record.modifier_text || 'N/A'}</td>
                <td class="px-2 py-1" title="${record.endpoint || 'N/A'}">${record.endpoint && record.endpoint.length > 10 ? record.endpoint.substring(0, 10) + '...' : record.endpoint || 'N/A'}</td>
                <td class="px-2 py-1">${record.hazard_ratio || 'N/A'}</td>
                <td class="px-2 py-1">${ci_display}</td>
                <td class="px-2 py-1">${record.pvalue || 'N/A'}</td>
                <td class="px-2 py-1">
                  ${record.source_url && record.source_url.trim() !== "" ?
                    `<a href="${record.source_url}" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-sm" title="${record.source_url}">
                      <i class="fas fa-external-link-alt mr-1 text-xs"></i>${record.source && record.source.length > 10 ? record.source.substring(0, 10) + '...' : record.source || 'Unknown Source'}
                    </a>` :
                    `<span class="text-gray-700 text-sm" title="${record.source || 'N/A'}">${record.source && record.source.length > 10 ? record.source.substring(0, 10) + '...' : record.source || 'No Source'}</span>`
                  }
                </td>
                ${userTrackingColumn}
                <td class="px-2 py-1">
                  <button class="edit-subgroup-survival-btn text-blue-700 hover:underline text-sm" data-doc-id="${record._docId}" title="Edit">Edit</button>
                  <button class="delete-subgroup-survival-btn text-red-600 hover:underline text-sm ml-2" data-doc-id="${record._docId}" title="Delete">Delete</button>
                </td>
              </tr>
            `;
          });

          html += `
                </tbody>
              </table>
            </div>
          `;
          container.innerHTML = html;
        }
      }).catch(error => {
        console.error('Error loading sub group survival data:', error);
        document.getElementById('subGroupSurvivalDataContainer').innerHTML = `
          <div class="p-6 text-center text-red-500">
            <p>Error loading sub group survival data: ${error.message}</p>
          </div>
        `;
      });
    }

    function setupSurvivalEventHandlers(trialId) {
      // Add Main ARM Survival Record button
      document.getElementById('addMainSurvivalBtn').addEventListener('click', () => {
        openMainSurvivalEditor(trialId);
      });

      // Add Sub Group Survival Record button
      document.getElementById('addSubGroupSurvivalBtn').addEventListener('click', () => {
        openSubGroupSurvivalEditor(trialId);
      });

      // Event delegation for edit/delete buttons (will be set up after data loads)
      document.addEventListener('click', (e) => {
        if (e.target.closest('.edit-main-survival-btn')) {
          const docId = e.target.closest('.edit-main-survival-btn').getAttribute('data-doc-id');
          editMainSurvivalRecord(trialId, docId);
        }
        if (e.target.closest('.delete-main-survival-btn')) {
          const docId = e.target.closest('.delete-main-survival-btn').getAttribute('data-doc-id');
          deleteMainSurvivalRecord(trialId, docId);
        }
        if (e.target.closest('.edit-subgroup-survival-btn')) {
          const docId = e.target.closest('.edit-subgroup-survival-btn').getAttribute('data-doc-id');
          editSubGroupSurvivalRecord(trialId, docId);
        }
        if (e.target.closest('.delete-subgroup-survival-btn')) {
          const docId = e.target.closest('.delete-subgroup-survival-btn').getAttribute('data-doc-id');
          deleteSubGroupSurvivalRecord(trialId, docId);
        }
      });

      // Add modal HTML for Main ARM Survival Editor
      if (!document.getElementById('mainSurvivalEditorModal')) {
        document.body.insertAdjacentHTML('beforeend', `
          <div id="mainSurvivalEditorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h4 id="mainSurvivalEditorTitle" class="text-xl font-semibold text-red-500">Main ARM Survival Record</h4>
                <button id="closeMainSurvivalEditor" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>
              <form id="mainSurvivalForm" novalidate>
                <input type="hidden" id="mainSurvivalEditId" name="edit_id" value="" />
                ${getSurvivalFormFields('main')}
                <div class="flex justify-end gap-4 mt-6">
                  <button type="button" id="cancelMainSurvivalBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">Cancel</button>
                  <button type="submit" class="bg-red-400 text-white font-semibold rounded px-6 py-2 hover:bg-red-500 transition">
                    <i class="fas fa-save mr-2"></i> Save Main ARM Survival
                  </button>
                </div>
                <div id="mainSurvivalFormMessage" class="text-sm mt-2"></div>
              </form>
            </div>
          </div>
        `);
      }

      // Add modal HTML for Sub Group Survival Editor
      if (!document.getElementById('subGroupSurvivalEditorModal')) {
        document.body.insertAdjacentHTML('beforeend', `
          <div id="subGroupSurvivalEditorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h4 id="subGroupSurvivalEditorTitle" class="text-xl font-semibold text-orange-500">Sub Group Survival Record</h4>
                <button id="closeSubGroupSurvivalEditor" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>
              <form id="subGroupSurvivalForm" novalidate>
                <input type="hidden" id="subGroupSurvivalEditId" name="edit_id" value="" />
                ${getSurvivalFormFields('subgroup')}
                <div class="flex justify-end gap-4 mt-6">
                  <button type="button" id="cancelSubGroupSurvivalBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">Cancel</button>
                  <button type="submit" class="bg-slate-600 text-white font-semibold rounded px-6 py-2 hover:bg-slate-700 transition">
                    <i class="fas fa-save mr-2"></i> Save Sub Group Survival
                  </button>
                </div>
                <div id="subGroupSurvivalFormMessage" class="text-sm mt-2"></div>
              </form>
            </div>
          </div>
        `);
      }

      // Modal close handlers
      document.getElementById('closeMainSurvivalEditor').addEventListener('click', closeMainSurvivalEditor);
      document.getElementById('cancelMainSurvivalBtn').addEventListener('click', closeMainSurvivalEditor);
      document.getElementById('closeSubGroupSurvivalEditor').addEventListener('click', closeSubGroupSurvivalEditor);
      document.getElementById('cancelSubGroupSurvivalBtn').addEventListener('click', closeSubGroupSurvivalEditor);
    }

    function getSurvivalFormFields(type) {
      const endpointOptions = [
        "Acute GVHD Free Survival", "Biochemical Disease-Free Survival", "Biochemical Failure Free Survival",
        "Biochemical free survival", "Biochemical No Evidence of Disease", "Biochemical Progression Free Survival",
        "Biochemical Recurrence Free Survival", "Biochemical Relapse-Free Survival", "Biochemical Response Rate",
        "Bleeding Free Survival", "Bone Marrow Response", "Bone Metastasis-Free Survival", "Cancer Specific Survival",
        "Cause Specific Survival", "Complete Response", "Continuous Complete Remission", "Disease Free Survival",
        "Disease Specific Survival", "Duration of Response", "Event Free Survival", "Failure Free Survival",
        "Local Control", "Local Recurrence Free Survival", "Locoregional Control", "Locoregional Recurrence Free Survival",
        "Metastasis Free Survival", "Overall Survival", "Partial Response", "Progression Free Survival",
        "Recurrence Free Survival", "Relapse Free Survival", "Response Rate", "Time to Progression",
        "Time to Treatment Failure", "Treatment Free Survival"
      ];

      const assessmentOptions = ["ITT", "Per Protocol", "All Patients", "As Treated", "Completers Only", "Post Hoc"];
      const mfuUnitOptions = ["Days", "Weeks", "Months", "Years"];

      let subGroupFields = '';
      if (type === 'subgroup') {
        subGroupFields = `
          <!-- Sub Group Information -->
          <div class="mb-6 p-4 bg-orange-100 rounded-lg border">
            <h5 class="text-lg font-semibold text-orange-500 mb-3">Sub Group Information</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="${type}SubGroup" class="block font-medium mb-2">Sub Group *</label>
                <input type="text" id="${type}SubGroup" name="sub_group" required
                  class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-400"
                  placeholder="Enter sub group">
              </div>
              <div>
                <label for="${type}SubGroupCategory" class="block font-medium mb-2">Sub Group Category *</label>
                <input type="text" id="${type}SubGroupCategory" name="sub_group_category" required
                  class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-400"
                  placeholder="Enter sub group category">
              </div>
            </div>
          </div>
        `;
      }

      return `
        <!-- MFU Information - FIRST -->
        <div class="mb-6 p-4 bg-red-100 rounded-lg border">
          <h5 class="text-lg font-semibold text-red-500 mb-3">Median Follow-Up (MFU)</h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="${type}MFU" class="block font-medium mb-2">MFU</label>
              <input type="text" id="${type}MFU" name="mfu"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-400"
                placeholder="Enter MFU value">
            </div>
            <div>
              <label for="${type}MFUUnit" class="block font-medium mb-2">MFU Unit</label>
              <select id="${type}MFUUnit" name="mfu_unit"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-400">
                <option value="">Select MFU Unit</option>
                ${mfuUnitOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
              </select>
            </div>
          </div>
        </div>

        ${subGroupFields}

        <!-- ARM Data -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg border">
          <h5 class="text-lg font-semibold text-blue-800 mb-3">ARM Data</h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="${type}Arm1N" class="block font-medium mb-2">N (Arm 1)</label>
              <input type="number" id="${type}Arm1N" name="arm1_n" min="0"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                placeholder="Enter Arm 1 N">
            </div>
            <div>
              <label for="${type}Arm2N" class="block font-medium mb-2">N (Arm 2)</label>
              <input type="number" id="${type}Arm2N" name="arm2_n" min="0"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                placeholder="Enter Arm 2 N">
            </div>
          </div>
        </div>

        <!-- Assessment Information -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg border">
          <h5 class="text-lg font-semibold text-gray-800 mb-3">Assessment Information</h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="${type}AssessmentType" class="block font-medium mb-2">Assessment Type</label>
              <select id="${type}AssessmentType" name="assessment_type"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-600">
                <option value="">Select Assessment Type</option>
                ${assessmentOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
              </select>
            </div>
            <div>
              <label for="${type}ModifierText" class="block font-medium mb-2">Modifier Text</label>
              <input type="text" id="${type}ModifierText" name="modifier_text"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-gray-600"
                placeholder="Enter modifier text">
            </div>
          </div>
        </div>

        <!-- Endpoint -->
        <div class="mb-6 p-4 bg-indigo-50 rounded-lg border">
          <h5 class="text-lg font-semibold text-indigo-800 mb-3">Endpoint</h5>
          <div>
            <label for="${type}Endpoint" class="block font-medium mb-2">Endpoint *</label>
            <select id="${type}Endpoint" name="endpoint" required
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-600">
              <option value="">Select Endpoint</option>
              ${endpointOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
            </select>
          </div>
        </div>

        <!-- Statistical Data -->
        <div class="mb-6 p-4 bg-red-50 rounded-lg border">
          <h5 class="text-lg font-semibold text-red-800 mb-3">Statistical Data</h5>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label for="${type}HazardRatio" class="block font-medium mb-2">Hazard Ratio</label>
              <input type="text" id="${type}HazardRatio" name="hazard_ratio"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600"
                placeholder="Enter HR">
            </div>
            <div>
              <label for="${type}Min95CI" class="block font-medium mb-2">Min 95% CI</label>
              <input type="text" id="${type}Min95CI" name="min_95_ci"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600"
                placeholder="Enter Min CI">
            </div>
            <div>
              <label for="${type}Max95CI" class="block font-medium mb-2">Max 95% CI</label>
              <input type="text" id="${type}Max95CI" name="max_95_ci"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600"
                placeholder="Enter Max CI">
            </div>
          </div>
          <div class="mt-4">
            <label for="${type}PValue" class="block font-medium mb-2">P-Value</label>
            <input type="text" id="${type}PValue" name="pvalue"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600"
              placeholder="Enter P-Value (0-1)">
          </div>
        </div>

        <!-- Source Information - LAST -->
        <div class="mb-6 p-4 bg-yellow-50 rounded-lg border">
          <h5 class="text-lg font-semibold text-yellow-800 mb-3">Source Information</h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="${type}Source" class="block font-medium mb-2">Source</label>
              <input type="text" id="${type}Source" name="source"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-600"
                placeholder="Enter source">
            </div>
            <div>
              <label for="${type}SourceUrl" class="block font-medium mb-2">Source Link</label>
              <input type="url" id="${type}SourceUrl" name="source_url"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-600"
                placeholder="Enter source URL">
            </div>
          </div>
        </div>
      `;
    }

    async function openMainSurvivalEditor(trialId, record = null) {
      const modal = document.getElementById('mainSurvivalEditorModal');
      const title = document.getElementById('mainSurvivalEditorTitle');
      const form = document.getElementById('mainSurvivalForm');

      // Load dropdown options from Firestore
      console.log('Loading survival dropdowns...');
      await loadDropdownFromFirestore('survival_endpoints', 'mainEndpoint');
      await loadDropdownFromFirestore('mfu_units', 'mainMFUUnit');
      await loadDropdownFromFirestore('assessment_types', 'mainAssessmentType');

      if (record) {
        title.textContent = 'Edit Main ARM Survival Record';
        document.getElementById('mainSurvivalEditId').value = record._docId;
        populateSurvivalForm('main', record);
      } else {
        title.textContent = 'Add Main ARM Survival Record';
        document.getElementById('mainSurvivalEditId').value = '';
        form.reset();
      }

      modal.classList.remove('hidden');
      showMainSurvivalFormMessage('');
    }

    function closeMainSurvivalEditor() {
      document.getElementById('mainSurvivalEditorModal').classList.add('hidden');
      document.getElementById('mainSurvivalForm').reset();
      showMainSurvivalFormMessage('');
    }

    async function openSubGroupSurvivalEditor(trialId, record = null) {
      const modal = document.getElementById('subGroupSurvivalEditorModal');
      const title = document.getElementById('subGroupSurvivalEditorTitle');
      const form = document.getElementById('subGroupSurvivalForm');

      // Load dropdown options from Firestore
      console.log('Loading survival dropdowns for subgroup...');
      await loadDropdownFromFirestore('survival_endpoints', 'subgroupEndpoint');
      await loadDropdownFromFirestore('mfu_units', 'subgroupMFUUnit');
      await loadDropdownFromFirestore('assessment_types', 'subgroupAssessmentType');

      if (record) {
        title.textContent = 'Edit Sub Group Survival Record';
        document.getElementById('subGroupSurvivalEditId').value = record._docId;
        populateSurvivalForm('subgroup', record);
      } else {
        title.textContent = 'Add Sub Group Survival Record';
        document.getElementById('subGroupSurvivalEditId').value = '';
        form.reset();
      }

      modal.classList.remove('hidden');
      showSubGroupSurvivalFormMessage('');
    }

    function closeSubGroupSurvivalEditor() {
      document.getElementById('subGroupSurvivalEditorModal').classList.add('hidden');
      document.getElementById('subGroupSurvivalForm').reset();
      showSubGroupSurvivalFormMessage('');
    }

    function populateSurvivalForm(type, record) {
      if (type === 'subgroup') {
        document.getElementById(`${type}SubGroup`).value = record.sub_group || '';
        document.getElementById(`${type}SubGroupCategory`).value = record.sub_group_category || '';
      }

      document.getElementById(`${type}Arm1N`).value = record.arm1_n || '';
      document.getElementById(`${type}Arm2N`).value = record.arm2_n || '';
      document.getElementById(`${type}AssessmentType`).value = record.assessment_type || '';
      document.getElementById(`${type}ModifierText`).value = record.modifier_text || '';
      document.getElementById(`${type}Source`).value = record.source || '';
      document.getElementById(`${type}SourceUrl`).value = record.source_url || '';
      document.getElementById(`${type}Endpoint`).value = record.endpoint || '';
      document.getElementById(`${type}HazardRatio`).value = record.hazard_ratio || '';
      document.getElementById(`${type}Min95CI`).value = record.min_95_ci || '';
      document.getElementById(`${type}Max95CI`).value = record.max_95_ci || '';
      document.getElementById(`${type}PValue`).value = record.pvalue || '';
      document.getElementById(`${type}MFU`).value = record.mfu || '';
      document.getElementById(`${type}MFUUnit`).value = record.mfu_unit || '';
    }

    function showMainSurvivalFormMessage(msg, isError = false) {
      const el = document.getElementById('mainSurvivalFormMessage');
      el.textContent = msg;
      el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
      if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
    }

    function showSubGroupSurvivalFormMessage(msg, isError = false) {
      const el = document.getElementById('subGroupSurvivalFormMessage');
      el.textContent = msg;
      el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
      if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
    }

    // Add form submission handlers after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Main ARM Survival Form submission
      document.addEventListener('submit', (e) => {
        if (e.target.id === 'mainSurvivalForm') {
          e.preventDefault();
          handleMainSurvivalFormSubmission(e.target);
        }
        if (e.target.id === 'subGroupSurvivalForm') {
          e.preventDefault();
          handleSubGroupSurvivalFormSubmission(e.target);
        }
      });
    });

    function handleMainSurvivalFormSubmission(form) {
      const formData = new FormData(form);
      const editId = formData.get('edit_id');

      // Validate required fields
      const endpoint = formData.get('endpoint');
      if (!endpoint) {
        showMainSurvivalFormMessage('Endpoint is required.', true);
        return;
      }

      const updateData = {
        trial_id: currentTrialId,
        arm1_n: formData.get('arm1_n') ? parseInt(formData.get('arm1_n')) : null,
        arm2_n: formData.get('arm2_n') ? parseInt(formData.get('arm2_n')) : null,
        assessment_type: formData.get('assessment_type') || null,
        modifier_text: formData.get('modifier_text') || null,
        source: formData.get('source') || null,
        source_url: formData.get('source_url') || null,
        endpoint: endpoint,
        hazard_ratio: formData.get('hazard_ratio') || null,
        min_95_ci: formData.get('min_95_ci') || null,
        max_95_ci: formData.get('max_95_ci') || null,
        pvalue: formData.get('pvalue') || null,
        mfu: formData.get('mfu') || null,
        mfu_unit: formData.get('mfu_unit') || null,
        updated_at: new Date()
      };

      // Add user tracking metadata
      addUserTrackingToData(updateData, !editId); // isCreation = true if no editId

      if (editId) {
        // Update existing record
        db.collection('survival_data_main').doc(editId).update(updateData).then(async () => {
          showMainSurvivalFormMessage('Main ARM survival record updated successfully.');
          await updateTrialLastModified(currentTrialId);
          setTimeout(() => {
            closeMainSurvivalEditor();
            loadMainSurvivalData(currentTrialId);
          }, 1000);
        }).catch(error => {
          showMainSurvivalFormMessage('Error updating record: ' + error.message, true);
        });
      } else {
        // Create new record
        db.collection('survival_data_main').add(updateData).then(async () => {
          showMainSurvivalFormMessage('Main ARM survival record saved successfully.');
          await updateTrialLastModified(currentTrialId);
          setTimeout(() => {
            closeMainSurvivalEditor();
            loadMainSurvivalData(currentTrialId);
          }, 1000);
        }).catch(error => {
          showMainSurvivalFormMessage('Error saving record: ' + error.message, true);
        });
      }
    }

    function handleSubGroupSurvivalFormSubmission(form) {
      const formData = new FormData(form);
      const editId = formData.get('edit_id');

      // Validate required fields
      const endpoint = formData.get('endpoint');
      const subGroup = formData.get('sub_group');
      const subGroupCategory = formData.get('sub_group_category');

      if (!endpoint) {
        showSubGroupSurvivalFormMessage('Endpoint is required.', true);
        return;
      }
      if (!subGroup) {
        showSubGroupSurvivalFormMessage('Sub Group is required.', true);
        return;
      }
      if (!subGroupCategory) {
        showSubGroupSurvivalFormMessage('Sub Group Category is required.', true);
        return;
      }

      const updateData = {
        trial_id: currentTrialId,
        sub_group: subGroup,
        sub_group_category: subGroupCategory,
        arm1_n: formData.get('arm1_n') ? parseInt(formData.get('arm1_n')) : null,
        arm2_n: formData.get('arm2_n') ? parseInt(formData.get('arm2_n')) : null,
        assessment_type: formData.get('assessment_type') || null,
        modifier_text: formData.get('modifier_text') || null,
        source: formData.get('source') || null,
        source_url: formData.get('source_url') || null,
        endpoint: endpoint,
        hazard_ratio: formData.get('hazard_ratio') || null,
        min_95_ci: formData.get('min_95_ci') || null,
        max_95_ci: formData.get('max_95_ci') || null,
        pvalue: formData.get('pvalue') || null,
        mfu: formData.get('mfu') || null,
        mfu_unit: formData.get('mfu_unit') || null,
        updated_at: new Date()
      };

      // Add user tracking metadata
      addUserTrackingToData(updateData, !editId); // isCreation = true if no editId

      if (editId) {
        // Update existing record
        db.collection('survival_data_subgroup').doc(editId).update(updateData).then(async () => {
          showSubGroupSurvivalFormMessage('Sub group survival record updated successfully.');
          await updateTrialLastModified(currentTrialId);
          setTimeout(() => {
            closeSubGroupSurvivalEditor();
            loadSubGroupSurvivalData(currentTrialId);
          }, 1000);
        }).catch(error => {
          showSubGroupSurvivalFormMessage('Error updating record: ' + error.message, true);
        });
      } else {
        // Create new record
        db.collection('survival_data_subgroup').add(updateData).then(async () => {
          showSubGroupSurvivalFormMessage('Sub group survival record saved successfully.');
          await updateTrialLastModified(currentTrialId);
          setTimeout(() => {
            closeSubGroupSurvivalEditor();
            loadSubGroupSurvivalData(currentTrialId);
          }, 1000);
        }).catch(error => {
          showSubGroupSurvivalFormMessage('Error saving record: ' + error.message, true);
        });
      }
    }

    function editMainSurvivalRecord(trialId, docId) {
      db.collection('survival_data_main').doc(docId).get().then(docSnapshot => {
        if (!docSnapshot.exists) {
          alert('Record not found.');
          return;
        }
        const record = docSnapshot.data();
        record._docId = docId;
        openMainSurvivalEditor(trialId, record);
      }).catch(error => {
        alert('Error loading record: ' + error.message);
      });
    }

    function deleteMainSurvivalRecord(trialId, docId) {
      if (confirm('Are you sure you want to delete this main ARM survival record?')) {
        db.collection('survival_data_main').doc(docId).delete().then(() => {
          alert('Main ARM survival record deleted successfully.');
          loadMainSurvivalData(trialId);
        }).catch(error => {
          alert('Error deleting record: ' + error.message);
        });
      }
    }

    function editSubGroupSurvivalRecord(trialId, docId) {
      db.collection('survival_data_subgroup').doc(docId).get().then(docSnapshot => {
        if (!docSnapshot.exists) {
          alert('Record not found.');
          return;
        }
        const record = docSnapshot.data();
        record._docId = docId;
        openSubGroupSurvivalEditor(trialId, record);
      }).catch(error => {
        alert('Error loading record: ' + error.message);
      });
    }

    function deleteSubGroupSurvivalRecord(trialId, docId) {
      if (confirm('Are you sure you want to delete this sub group survival record?')) {
        db.collection('survival_data_subgroup').doc(docId).delete().then(() => {
          alert('Sub group survival record deleted successfully.');
          loadSubGroupSurvivalData(trialId);
        }).catch(error => {
          alert('Error deleting record: ' + error.message);
        });
      }
    }

    function initializeSurvivalGrid(trialId) {
      // Endpoint options array
      const endpoints = [
        {"Name":"", "id":""},
        {"Name":"Acute GVHD Free Survival","id":"253"},
        {"Name":"Biochemical Disease-Free Survival","id":"150"},
        {"Name":"Biochemical Failure Free Survival","id":"281"},
        {"Name":"Biochemical free survival","id":"135"},
        {"Name":"Biochemical No Evidence of Disease","id":"274"},
        {"Name":"Biochemical Progression Free Survival","id":"142"},
        {"Name":"Biochemical Recurrence Free Survival","id":"277"},
        {"Name":"Biochemical Relapse-Free Survival","id":"149"},
        {"Name":"Biochemical Response Rate","id":"351"},
        {"Name":"Bleeding Free Survival","id":"132"},
        {"Name":"Bone Marrow Response","id":"101"},
        {"Name":"Bone Metastasis-Free Survival","id":"169"},
        {"Name":"Bone Metastasis-Specific Survival","id":"164"},
        {"Name":"Bone Progression Free Survival","id":"302"},
        {"Name":"Brain Metastasis-Specific Survival","id":"121"},
        {"Name":"Brain Metastasis: Cumulative Incidence Rate","id":"75"},
        {"Name":"Cancer Free Interval","id":"325"},
        {"Name":"Cancer related deaths","id":"207"},
        {"Name":"Cancer Specific PFS","id":"329"},
        {"Name":"Cancer Specific Survival","id":"82"},
        {"Name":"Castration free survival","id":"160"},
        {"Name":"Cause Specific Survival","id":"128"},
        {"Name":"Chemotherapy Free Interval","id":"246"},
        {"Name":"Clinical Benefit Rate","id":"16"},
        {"Name":"Clinical complete response rate","id":"409"},
        {"Name":"Clinical Progression Free Survival","id":"273"},
        {"Name":"Clinical Relapse-Free Survival","id":"405"},
        {"Name":"Clinical Response Rate","id":"353"},
        {"Name":"CNS Disease free survival","id":"203"},
        {"Name":"CNS Progression-Free Survival","id":"183"},
        {"Name":"Complete Metabolic Response Rate","id":"366"},
        {"Name":"Complete Remission Rate","id":"367"},
        {"Name":"Complete Response Rate","id":"337"},
        {"Name":"Disease Control Rate","id":"15"},
        {"Name":"Disease Free Interval","id":"315"},
        {"Name":"Disease-Free Survival","id":"33"},
        {"Name":"Distant Control","id":"153"},
        {"Name":"Distant Disease-Free Survival","id":"120"},
        {"Name":"Distant Failure-Free Survival","id":"178"},
        {"Name":"Distant Metastasis-Free Survival","id":"30"},
        {"Name":"Distant Progression Free Survival","id":"265"},
        {"Name":"Distant Recurrence Free Survival","id":"99"},
        {"Name":"Distant Relapse-Free Survival","id":"172"},
        {"Name":"Duration of Response","id":"13"},
        {"Name":"Event-Free Survival","id":"34"},
        {"Name":"Freedom from Biochemical Recurrence","id":"306"},
        {"Name":"Freedom from Cancer","id":"313"},
        {"Name":"Freedom from Distant Metastases","id":"187"},
        {"Name":"Freedom from Distant Recurrence","id":"309"},
        {"Name":"Freedom from Local Recurrence","id":"314"},
        {"Name":"Freedom From Progression","id":"284"},
        {"Name":"Freedom from Recurrence","id":"259"},
        {"Name":"Freedom from Relapse","id":"240"},
        {"Name":"Health-Related Quality-of-Life","id":"17"},
        {"Name":"Immune-related Objective Response Rate","id":"352"},
        {"Name":"Immune-Related Progression-Free Survival","id":"204"},
        {"Name":"Intracranial Overall Survival","id":"295"},
        {"Name":"Intracranial Progression Free Survival","id":"138"},
        {"Name":"Local Progression Free Survival","id":"192"},
        {"Name":"Local recurrence-free survival","id":"200"},
        {"Name":"Locoregional Control","id":"198"},
        {"Name":"Locoregional Disease Free Survival","id":"213"},
        {"Name":"Locoregional Failure-Free Survival","id":"177"},
        {"Name":"Locoregional Progression Free Survival","id":"264"},
        {"Name":"Metastasis free survival","id":"64"},
        {"Name":"Minimal Residual Disease","id":"48"},
        {"Name":"Minimal Residual Disease Free Survival","id":"107"},
        {"Name":"Objective Response Rate","id":"11"},
        {"Name":"Overall Survival","id":"9"},
        {"Name":"Pathologic Complete Response Rate","id":"350"},
        {"Name":"Pathological Response Rate","id":"349"},
        {"Name":"Post-progression survival","id":"63"},
        {"Name":"Post-Recurrence Survival","id":"141"},
        {"Name":"Post-Relapse Survival","id":"119"},
        {"Name":"Progression Free Survival","id":"10"},
        {"Name":"Progression Free Survival 2","id":"39"},
        {"Name":"PSA Progression-Free Survival","id":"156"},
        {"Name":"PSA Recurrence Free Survival","id":"163"},
        {"Name":"PSA Response Rate","id":"356"},
        {"Name":"Radiographic Progression-Free Survival","id":"155"},
        {"Name":"Radiographic Response Rate","id":"355"},
        {"Name":"Recurrence Free Interval","id":"324"},
        {"Name":"Relapse Free Survival","id":"65"},
        {"Name":"Response Rate","id":"12"},
        {"Name":"Time to Progression","id":"35"},
        {"Name":"Time to Treatment Failure","id":"36"},
        {"Name":"Treatment Free Survival","id":"37"}
      ];

      // Assessment Type options
      const assessmentTypes = [
        { Name: "", Id: '' },
        { Name: "ITT", Id: 'ITT' },
        { Name: "Per Protocol", Id: 'Per Protocol' },
        { Name: "All Patients", Id: 'All Patients' },
        { Name: "As Treated", Id: 'As Treated' },
        { Name: "Completers Only", Id: 'Completers Only' },
        { Name: "Post Hoc", Id: 'Post Hoc' }
      ];

      // Initialize JSGrid
      $("#survival_grid_table").jsGrid({
        width: "100%",
        height: "auto",
        filtering: true,
        inserting: true,
        editing: true,
        sorting: true,
        paging: false,
        autoload: true,
        deleteConfirm: "Do you really want to delete this record?",

        controller: {
          loadData: function(filter) {
            return new Promise((resolve, reject) => {
              db.collection('survival_data').where('trial_id', '==', trialId).get().then(querySnapshot => {
                const data = [];
                querySnapshot.forEach(doc => {
                  const item = doc.data();
                  item._docId = doc.id;
                  data.push(item);
                });
                resolve(data);
              }).catch(error => {
                console.error("Error loading survival data:", error);
                reject(error);
              });
            });
          },
          insertItem: function(item) {
            return new Promise((resolve, reject) => {
              item.trial_id = trialId;
              item.created_at = new Date();
              db.collection('survival_data').add(item).then(docRef => {
                item._docId = docRef.id;
                resolve(item);
              }).catch(error => {
                console.error("Error inserting survival data:", error);
                reject(error);
              });
            });
          },
          updateItem: function(item) {
            return new Promise((resolve, reject) => {
              const docId = item._docId;
              delete item._docId;
              item.updated_at = new Date();
              db.collection('survival_data').doc(docId).update(item).then(() => {
                item._docId = docId;
                resolve(item);
              }).catch(error => {
                console.error("Error updating survival data:", error);
                reject(error);
              });
            });
          },
          deleteItem: function(item) {
            return new Promise((resolve, reject) => {
              db.collection('survival_data').doc(item._docId).delete().then(() => {
                resolve(item);
              }).catch(error => {
                console.error("Error deleting survival data:", error);
                reject(error);
              });
            });
          }
        },

        fields: [
          {
            name: "arm1_n",
            title: "N (Arm 1)",
            type: "number",
            width: 70,
            filtering: false,
            validate: {
              validator: function(value) {
                return value === "" || value === null || (Number(value) >= 0 && Number.isInteger(Number(value)));
              },
              message: "N (Arm 1) must be a non-negative integer."
            }
          },
          {
            name: "arm2_n",
            title: "N (Arm 2)",
            type: "number",
            width: 70,
            filtering: false,
            validate: {
              validator: function(value) {
                return value === "" || value === null || (Number(value) >= 0 && Number.isInteger(Number(value)));
              },
              message: "N (Arm 2) must be a non-negative integer."
            }
          },
          {
            name: "total_n",
            title: "Total N",
            type: "number",
            width: 60,
            filtering: false,
            editing: false,
            inserting: false,
            itemTemplate: function(value, item) {
              const arm1 = parseInt(item.arm1_n);
              const arm2 = parseInt(item.arm2_n);
              if (!isNaN(arm1) && !isNaN(arm2)) {
                return arm1 + arm2;
              }
              return value || "";
            }
          },
          {
            name: "assessment_type",
            title: "Assessment",
            type: "select",
            width: 90,
            items: assessmentTypes,
            valueField: "Id",
            textField: "Name"
          },
          {
            name: "modifier_text",
            title: "Modifier",
            type: "text",
            width: 100,
            filtering: false
          },
          {
            name: "source",
            title: "Source",
            type: "text",
            width: 120,
            filtering: true
          },
          {
            name: "source_url",
            title: "Source Link",
            type: "text",
            width: 150,
            filtering: false,
            itemTemplate: function(value, item) {
              if (value && value.trim() !== "") {
                return $('<a>')
                  .attr('href', value)
                  .attr('target', '_blank')
                  .attr('rel', 'noopener noreferrer')
                  .text(value.length > 30 ? value.substring(0, 30) + '...' : value)
                  .addClass("text-blue-600 underline hover:text-blue-800");
              }
              return "";
            }
          },
          {
            name: "endpoint",
            title: "Endpoint",
            type: "select",
            width: 180,
            filtering: true,
            items: endpoints,
            valueField: "Name",
            textField: "Name",
            validate: "required"
          },
          {
            name: "hazard_ratio",
            title: "HR",
            type: "text",
            width: 60,
            validate: {
              validator: function(value, item) {
                return value || item.min_95_ci || item.max_95_ci || item.pvalue;
              },
              message: "Enter at least one of HR, 95% CI or P-value."
            }
          },
          {
            name: "min_95_ci",
            title: "Min CI",
            type: "text",
            width: 60,
            validate: {
              validator: function(value) {
                if (value === "" || value === null) return true;
                return !isNaN(value) && Number(value) >= 0;
              },
              message: "Min 95% CI must be a non-negative number."
            }
          },
          {
            name: "max_95_ci",
            title: "Max CI",
            type: "text",
            width: 60,
            validate: {
              validator: function(value) {
                if (value === "" || value === null) return true;
                return !isNaN(value) && Number(value) >= 0;
              },
              message: "Max 95% CI must be a non-negative number."
            }
          },
          {
            name: "pvalue",
            title: "P-Value",
            type: "text",
            width: 70,
            validate: {
              validator: function(value) {
                if (value === "" || value === null) return true;
                const num = Number(value);
                return !isNaN(num) && num >= 0 && num <= 1;
              },
              message: "P-Value must be between 0 and 1."
            }
          },
          {
            type: "control",
            width: 80,
            editButton: true,
            deleteButton: true,
            modeSwitchButton: false,
            clearFilterButton: true
          }
        ]
      });
    }

    // === MILESTONES TAB ===
    function renderMilestonesTab(container, trialId) {
      db.collection('trial_milestones').where('trial_id', '==', trialId).get().then(querySnapshot => {
        const milestoneRecords = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          milestoneRecords.push(data);
        });

        let html = `
          <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <h3 class="text-xl font-semibold text-blue-900">Milestones</h3>
            <button id="showAddMilestoneFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
              <i class="fas fa-plus"></i> Add Milestone
            </button>
          </div>
        `;

        if (milestoneRecords.length === 0) {
          html += `<div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
            <p class="text-gray-600 italic">No milestone records found for this trial.</p>
          </div>`;
        } else {
          html += `<div class="space-y-4">`;
          milestoneRecords.forEach(record => {
            const statusBadgeClass = record.status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
            html += `
              <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <div class="flex justify-between items-start mb-3">
                  <div class="flex-1">
                    <h4 class="text-lg font-semibold text-blue-900">${record.milestone_event || 'N/A'}</h4>
                    <span class="inline-block px-2 py-1 text-xs font-medium rounded-full ${statusBadgeClass}">${record.status || 'N/A'}</span>
                  </div>
                  <div class="flex gap-2">
                    <button class="edit-milestone-record-btn bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition" data-doc-id="${record._docId}">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="delete-milestone-record-btn bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition" data-doc-id="${record._docId}">
                      <i class="fas fa-trash"></i> Delete
                    </button>
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div><strong>Topic Tag:</strong> ${record.topic_tag || 'N/A'}</div>
                  <div><strong>Disease:</strong> ${record.disease || 'N/A'}</div>
                  <div><strong>Description:</strong> ${record.milestone_description || 'N/A'}</div>
                  <div><strong>Active Status:</strong> <span class="px-2 py-1 text-xs font-medium rounded-full ${record.active_status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${record.active_status || 'N/A'}</span></div>
                  <div><strong>Expected Date:</strong> ${record.expected_date || 'N/A'}</div>
                  <div><strong>Completed Date:</strong> ${record.completed_date || 'N/A'}</div>
                  <div><strong>Event Link:</strong> ${record.event_link ? `<a href="${record.event_link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">View Event</a>` : 'N/A'}</div>
                  <div><strong>Result Link:</strong> ${record.result_link ? `<a href="${record.result_link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">View Result</a>` : 'N/A'}</div>
                </div>

                <!-- User Tracking Information -->
                ${formatUserTrackingInfo(record)}
              </div>
            `;
          });
          html += `</div>`;
        }

        // Add milestone editor form (hidden by default)
        html += `
          <div id="milestoneEditorForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h4 id="milestoneEditorTitle" class="text-xl font-semibold text-blue-900">Milestone Record</h4>
                <button id="closeMilestoneEditor" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>

              <form id="milestoneForm" novalidate>
                <input type="hidden" id="milestoneEditId" name="milestone_edit_id" value="" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label for="milestoneEvent" class="block text-sm font-medium text-gray-700 mb-1">Milestone Event *</label>
                    <select id="milestoneEvent" name="milestone_event" required
                            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                      <option value="">Select Milestone Event</option>
                      <option value="Regulatory">Regulatory</option>
                      <option value="Commercial">Commercial</option>
                      <option value="Clinical">Clinical</option>
                    </select>
                  </div>
                  <div>
                    <label for="topicTag" class="block text-sm font-medium text-gray-700 mb-1">Topic Tag</label>
                    <select id="topicTag" name="topic_tag"
                            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                      <option value="">Select Topic Tag</option>
                      <option value="FDA filing">FDA filing</option>
                      <option value="FDA approval">FDA approval</option>
                      <option value="Priority review">Priority review</option>
                      <option value="Fast track">Fast track</option>
                      <option value="Breakthrough therapy">Breakthrough therapy</option>
                      <option value="Orphan drug">Orphan drug</option>
                      <option value="Accelerated approval">Accelerated approval</option>
                      <option value="CRL">CRL</option>
                      <option value="PDUFA">PDUFA</option>
                      <option value="FDA event">FDA event</option>
                      <option value="PRIME">PRIME</option>
                      <option value="CHMP">CHMP</option>
                      <option value="PRAC">PRAC</option>
                      <option value="EMA filing">EMA filing</option>
                      <option value="EMA approval">EMA approval</option>
                      <option value="MHRA filing">MHRA filing</option>
                      <option value="MHRA approval">MHRA approval</option>
                      <option value="Canada filing">Canada filing</option>
                      <option value="Canada approval">Canada approval</option>
                      <option value="Japan filing">Japan filing</option>
                      <option value="Japan approval">Japan approval</option>
                      <option value="China filing">China filing</option>
                      <option value="China approval">China approval</option>
                      <option value="Korea filing">Korea filing</option>
                      <option value="Korea approval">Korea approval</option>
                      <option value="Filing">Filing</option>
                      <option value="Approval">Approval</option>
                      <option value="P1 data">P1 data</option>
                      <option value="P1/2 data">P1/2 data</option>
                      <option value="P2 data">P2 data</option>
                      <option value="P2/3 data">P2/3 data</option>
                      <option value="P3 data">P3 data</option>
                      <option value="P4 data">P4 data</option>
                      <option value="Trial Status">Trial Status</option>
                      <option value="Enrollment status">Enrollment status</option>
                      <option value="Trial Termination">Trial Termination</option>
                      <option value="Clinical data">Clinical data</option>
                    </select>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                  <div>
                    <label for="milestoneStatus" class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                    <select id="milestoneStatus" name="status" required
                            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                      <option value="">Select Status</option>
                      <option value="Completed">Completed</option>
                      <option value="Anticipated">Anticipated</option>
                    </select>
                  </div>
                  <div>
                    <label for="milestoneActiveStatus" class="block text-sm font-medium text-gray-700 mb-1">Active Status *</label>
                    <select id="milestoneActiveStatus" name="active_status" required
                            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                      <option value="">Select Active Status</option>
                      <option value="Active">Active</option>
                      <option value="Inactive">Inactive</option>
                    </select>
                  </div>
                  <div>
                    <label for="milestoneDisease" class="block text-sm font-medium text-gray-700 mb-1">Disease</label>
                    <input type="text" id="milestoneDisease" name="disease"
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                           placeholder="Enter disease">
                  </div>
                </div>

                <div class="mb-4">
                  <label for="milestoneDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                  <textarea id="milestoneDescription" name="milestone_description" rows="3"
                            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                            placeholder="Enter milestone description"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label for="expectedDate" class="block text-sm font-medium text-gray-700 mb-1">Expected Date</label>
                    <input type="date" id="expectedDate" name="expected_date"
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                  </div>
                  <div>
                    <label for="completedDate" class="block text-sm font-medium text-gray-700 mb-1">Completed Date</label>
                    <input type="date" id="completedDate" name="completed_date"
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label for="eventLink" class="block text-sm font-medium text-gray-700 mb-1">Event Link</label>
                    <input type="url" id="eventLink" name="event_link" placeholder="https://example.com"
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                  </div>
                  <div>
                    <label for="resultLink" class="block text-sm font-medium text-gray-700 mb-1">Result Link</label>
                    <input type="url" id="resultLink" name="result_link" placeholder="https://example.com"
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600">
                  </div>
                </div>

                <div id="milestoneFormMessage" class="text-sm mt-2"></div>

                <div class="flex justify-end gap-3 mt-6">
                  <button type="button" id="cancelMilestoneBtn" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50 transition">Cancel</button>
                  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Save Milestone</button>
                </div>
              </form>
            </div>
          </div>
        `;

        container.innerHTML = html;

        // Event handlers for adding new milestone
        document.getElementById('showAddMilestoneFormBtn').addEventListener('click', () => {
          openMilestoneEditor();
        });

        // Event handlers for editing milestone records
        container.querySelectorAll('.edit-milestone-record-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const docId = e.target.closest('.edit-milestone-record-btn').getAttribute('data-doc-id');
            const record = milestoneRecords.find(r => r._docId === docId);
            openMilestoneEditor(record);
          });
        });

        // Event handlers for deleting milestone records
        container.querySelectorAll('.delete-milestone-record-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const docId = e.target.closest('.delete-milestone-record-btn').getAttribute('data-doc-id');
            if (confirm('Are you sure you want to delete this milestone record?')) {
              try {
                await db.collection('trial_milestones').doc(docId).delete();
                alert('Milestone record deleted successfully.');
                await loadTabContent('milestones');
              } catch (error) {
                alert('Error deleting milestone record: ' + error.message);
              }
            }
          });
        });

        // Close editor handlers
        document.getElementById('closeMilestoneEditor').addEventListener('click', closeMilestoneEditor);
        document.getElementById('cancelMilestoneBtn').addEventListener('click', closeMilestoneEditor);

        // Milestone form submission
        document.getElementById('milestoneForm').addEventListener('submit', async e => {
          e.preventDefault();
          const form = e.target;
          const editId = form.milestone_edit_id.value;
          const milestone_event = form.milestone_event.value.trim();
          const status = form.status.value;
          const active_status = form.active_status.value;

          if (!milestone_event) {
            showMilestoneFormMessage('Milestone Event is required.', true);
            return;
          }

          if (!status) {
            showMilestoneFormMessage('Status is required.', true);
            return;
          }

          if (!active_status) {
            showMilestoneFormMessage('Active Status is required.', true);
            return;
          }

          // Collect all milestone data
          const updateData = {
            trial_id: trialId,
            milestone_event: milestone_event,
            topic_tag: form.topic_tag.value.trim() || null,
            milestone_description: form.milestone_description.value.trim() || null,
            expected_date: form.expected_date.value || null,
            completed_date: form.completed_date.value || null,
            event_link: form.event_link.value.trim() || null,
            result_link: form.result_link.value.trim() || null,
            disease: form.disease.value.trim() || null,
            status: status,
            active_status: active_status,
            updated_at: new Date()
          };

          // Add user tracking metadata
          addUserTrackingToData(updateData, !editId); // isCreation = true if no editId

          // If editing existing record, update it; otherwise create new
          if (editId) {
            try {
              await db.collection('trial_milestones').doc(editId).update(updateData);
              showMilestoneFormMessage('Milestone record updated successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(async () => {
                closeMilestoneEditor();
                await loadTabContent('milestones');
              }, 1000);
            } catch (error) {
              showMilestoneFormMessage('Error updating milestone: ' + error.message, true);
            }
          } else {
            updateData.created_at = new Date();
            try {
              const docRef = await db.collection('trial_milestones').add(updateData);

              // Log audit trail for milestone creation
              await logAuditTrail('CREATE', 'milestone', docRef.id, null, updateData, {
                trial_id: trialId,
                tab_name: 'milestones',
                form_name: 'milestoneForm'
              });

              showMilestoneFormMessage('Milestone record saved successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(async () => {
                closeMilestoneEditor();
                await loadTabContent('milestones');
              }, 1000);
            } catch (error) {
              // Log error
              await logError('MILESTONE_CREATION_ERROR', error.message, {
                trial_id: trialId,
                form_data: updateData,
                action: 'create_milestone'
              });

              showMilestoneFormMessage('Error saving milestone: ' + error.message, true);
            }
          }
        });

        function openMilestoneEditor(milestoneData = null) {
          const form = document.getElementById('milestoneForm');
          const title = document.getElementById('milestoneEditorTitle');

          if (milestoneData) {
            title.textContent = 'Edit Milestone Record';
            form.milestone_edit_id.value = milestoneData._docId;
            form.milestone_event.value = milestoneData.milestone_event || '';
            form.topic_tag.value = milestoneData.topic_tag || '';
            form.milestone_description.value = milestoneData.milestone_description || '';
            form.expected_date.value = milestoneData.expected_date || '';
            form.completed_date.value = milestoneData.completed_date || '';
            form.event_link.value = milestoneData.event_link || '';
            form.result_link.value = milestoneData.result_link || '';
            form.disease.value = milestoneData.disease || '';
            form.status.value = milestoneData.status || '';
            form.active_status.value = milestoneData.active_status || '';
          } else {
            title.textContent = 'Add New Milestone Record';
            form.reset();
            form.milestone_edit_id.value = '';
          }

          document.getElementById('milestoneEditorForm').classList.remove('hidden');
          document.getElementById('milestoneEvent').focus();
          showMilestoneFormMessage('');
        }

        function closeMilestoneEditor() {
          document.getElementById('milestoneEditorForm').classList.add('hidden');
          document.getElementById('milestoneForm').reset();
          showMilestoneFormMessage('');
        }

        function showMilestoneFormMessage(msg, isError = false) {
          const el = document.getElementById('milestoneFormMessage');
          el.textContent = msg;
          el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
          if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
        }
      });
    }

    // === ALL REFERENCES TAB ===
    async function renderReferencesTab(container, trialId) {
      try {
        // Collect all references from different tabs
        const allReferences = [];

        // Get Patient Demographics references
        const demographicsSnapshot = await db.collection('patient_demographics').where('trial_id', '==', trialId).get();
        demographicsSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.source || data.source_link) {
            allReferences.push({
              type: 'Patient Demographics',
              source: data.source || 'N/A',
              link: data.source_link || null,
              description: data.demographics_text ? data.demographics_text.substring(0, 100) + '...' : 'N/A'
            });
          }
        });

        // Get Safety Assessment references
        const safetySnapshot = await db.collection('trial_safety_assessments').where('trial_id', '==', trialId).get();
        safetySnapshot.forEach(doc => {
          const data = doc.data();
          if (data.source || data.link) {
            allReferences.push({
              type: 'Safety Assessment',
              source: data.source || 'N/A',
              link: data.link || null,
              description: 'Safety assessment data'
            });
          }
        });

        // Get Response Assessment references
        const responseSnapshot = await db.collection('trial_response_assessments').where('trial_id', '==', trialId).get();
        responseSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.source || data.link) {
            allReferences.push({
              type: 'Response Assessment',
              source: data.source || 'N/A',
              link: data.link || null,
              description: `${data.response_type || 'N/A'} - ${data.response_n || 'N/A'} patients`
            });
          }
        });

        // Get Milestone references
        const milestonesSnapshot = await db.collection('trial_milestones').where('trial_id', '==', trialId).get();
        milestonesSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.reference_link) {
            allReferences.push({
              type: 'Milestones',
              source: data.milestone_event || 'N/A',
              link: data.reference_link || null,
              description: data.milestone_description || 'Milestone reference'
            });
          }
        });

        // Get specific references (new collection for standalone references)
        const specificRefsSnapshot = await db.collection('trial_specific_references').where('trial_id', '==', trialId).get();
        const specificReferences = [];
        specificRefsSnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          specificReferences.push(data);
          allReferences.push({
            type: 'Specific Reference',
            source: data.source || 'N/A',
            link: data.reference_link || null,
            description: data.description || 'Specific reference'
          });
        });

        let html = `
          <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <h3 class="text-xl font-semibold text-blue-900">All References</h3>
            <button id="showAddReferenceFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
              <i class="fas fa-plus"></i> Add Specific Reference
            </button>
          </div>
        `;

        if (allReferences.length === 0) {
          html += `<div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
            <p class="text-gray-600 italic">No references found for this trial.</p>
          </div>`;
        } else {
          html += `<div class="space-y-4">`;

          // Group references by type
          const groupedRefs = {};
          allReferences.forEach(ref => {
            if (!groupedRefs[ref.type]) {
              groupedRefs[ref.type] = [];
            }
            groupedRefs[ref.type].push(ref);
          });

          Object.keys(groupedRefs).forEach(type => {
            html += `
              <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <h4 class="text-lg font-semibold text-blue-900 mb-3">${type}</h4>
                <div class="space-y-2">
            `;

            groupedRefs[type].forEach(ref => {
              const linkHtml = ref.link ?
                (ref.source === 'CT.gov' ?
                  `<a href="${ref.link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline font-medium">${trialId}</a>` :
                  `<a href="${ref.link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">${ref.link}</a>`
                ) : 'No link';

              html += `
                <div class="flex justify-between items-start p-3 bg-gray-50 rounded border">
                  <div class="flex-1">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                      <div><strong>Source:</strong> ${ref.source}</div>
                      <div><strong>Link:</strong> ${linkHtml}</div>
                      <div><strong>Description:</strong> ${ref.description}</div>
                    </div>
                  </div>
                </div>
              `;
            });

            html += `
                </div>
              </div>
            `;
          });

          html += `</div>`;
        }

        // Show specific references with edit/delete options
        if (specificReferences.length > 0) {
          html += `
            <div class="mt-6">
              <h4 class="text-lg font-semibold text-blue-900 mb-3">Manage Specific References</h4>
              <div class="space-y-2">
          `;

          specificReferences.forEach(ref => {
            const linkHtml = ref.reference_link ?
              (ref.source === 'CT.gov' ?
                `<a href="${ref.reference_link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline font-medium">${trialId}</a>` :
                `<a href="${ref.reference_link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">${ref.reference_link}</a>`
              ) : 'No link';

            html += `
              <div class="flex justify-between items-start p-3 bg-white border rounded">
                <div class="flex-1">
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                    <div><strong>Source:</strong> ${ref.source || 'N/A'}</div>
                    <div><strong>Link:</strong> ${linkHtml}</div>
                    <div><strong>Description:</strong> ${ref.description || 'N/A'}</div>
                  </div>
                </div>
                <div class="flex gap-2 ml-4">
                  <button class="edit-reference-btn bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition" data-doc-id="${ref._docId}">
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <button class="delete-reference-btn bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition" data-doc-id="${ref._docId}">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </div>
            `;
          });

          html += `
              </div>
            </div>
          `;
        }

        // Add reference editor form (hidden by default)
        html += `
          <div id="referenceEditorForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h4 id="referenceEditorTitle" class="text-xl font-semibold text-blue-900">Add Specific Reference</h4>
                <button id="closeReferenceEditor" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>

              <form id="referenceForm" novalidate>
                <input type="hidden" id="referenceEditId" name="reference_edit_id" value="" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label for="referenceSource" class="block text-sm font-medium text-gray-700 mb-1">Source *</label>
                    <input type="text" id="referenceSource" name="source" required
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                           placeholder="e.g., CT.gov, PubMed, etc.">
                  </div>
                  <div>
                    <label for="referenceLink" class="block text-sm font-medium text-gray-700 mb-1">Reference Link</label>
                    <input type="url" id="referenceLink" name="reference_link"
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                           placeholder="https://example.com">
                  </div>
                </div>

                <div class="mb-4">
                  <label for="referenceDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                  <textarea id="referenceDescription" name="description" rows="3"
                            class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                            placeholder="Brief description of this reference"></textarea>
                </div>

                <div id="referenceFormMessage" class="text-sm mt-2"></div>

                <div class="flex justify-end gap-3 mt-6">
                  <button type="button" id="cancelReferenceBtn" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50 transition">Cancel</button>
                  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Save Reference</button>
                </div>
              </form>
            </div>
          </div>
        `;

        container.innerHTML = html;

        // Event handlers for adding new reference
        document.getElementById('showAddReferenceFormBtn').addEventListener('click', () => {
          openReferenceEditor();
        });

        // Event handlers for editing specific references
        container.querySelectorAll('.edit-reference-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const docId = e.target.closest('.edit-reference-btn').getAttribute('data-doc-id');
            const record = specificReferences.find(r => r._docId === docId);
            openReferenceEditor(record);
          });
        });

        // Event handlers for deleting specific references
        container.querySelectorAll('.delete-reference-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const docId = e.target.closest('.delete-reference-btn').getAttribute('data-doc-id');
            if (confirm('Are you sure you want to delete this reference?')) {
              try {
                await db.collection('trial_specific_references').doc(docId).delete();
                alert('Reference deleted successfully.');
                await loadTabContent('references');
              } catch (error) {
                alert('Error deleting reference: ' + error.message);
              }
            }
          });
        });

        // Close editor handlers
        document.getElementById('closeReferenceEditor').addEventListener('click', closeReferenceEditor);
        document.getElementById('cancelReferenceBtn').addEventListener('click', closeReferenceEditor);

        // Reference form submission
        document.getElementById('referenceForm').addEventListener('submit', async e => {
          e.preventDefault();
          const form = e.target;
          const editId = form.reference_edit_id.value;
          const source = form.source.value.trim();

          if (!source) {
            showReferenceFormMessage('Source is required.', true);
            return;
          }

          // Collect all reference data
          const updateData = {
            trial_id: trialId,
            source: source,
            reference_link: form.reference_link.value.trim() || null,
            description: form.description.value.trim() || null,
            updated_at: new Date()
          };

          // Add user tracking metadata
          addUserTrackingToData(updateData, !editId); // isCreation = true if no editId

          // If editing existing record, update it; otherwise create new
          if (editId) {
            try {
              await db.collection('trial_specific_references').doc(editId).update(updateData);
              showReferenceFormMessage('Reference updated successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(async () => {
                closeReferenceEditor();
                await loadTabContent('references');
              }, 1000);
            } catch (error) {
              showReferenceFormMessage('Error updating reference: ' + error.message, true);
            }
          } else {
            updateData.created_at = new Date();
            try {
              await db.collection('trial_specific_references').add(updateData);
              showReferenceFormMessage('Reference saved successfully.');
              await updateTrialLastModified(trialId);
              setTimeout(async () => {
                closeReferenceEditor();
                await loadTabContent('references');
              }, 1000);
            } catch (error) {
              showReferenceFormMessage('Error saving reference: ' + error.message, true);
            }
          }
        });

        function openReferenceEditor(referenceData = null) {
          const form = document.getElementById('referenceForm');
          const title = document.getElementById('referenceEditorTitle');

          if (referenceData) {
            title.textContent = 'Edit Specific Reference';
            form.reference_edit_id.value = referenceData._docId;
            form.source.value = referenceData.source || '';
            form.reference_link.value = referenceData.reference_link || '';
            form.description.value = referenceData.description || '';
          } else {
            title.textContent = 'Add Specific Reference';
            form.reset();
            form.reference_edit_id.value = '';
          }

          document.getElementById('referenceEditorForm').classList.remove('hidden');
          document.getElementById('referenceSource').focus();
          showReferenceFormMessage('');
        }

        function closeReferenceEditor() {
          document.getElementById('referenceEditorForm').classList.add('hidden');
          document.getElementById('referenceForm').reset();
          showReferenceFormMessage('');
        }

        function showReferenceFormMessage(msg, isError = false) {
          const el = document.getElementById('referenceFormMessage');
          el.textContent = msg;
          el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
          if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
        }

      } catch (error) {
        container.innerHTML = `<div class="text-red-600">Error loading references: ${error.message}</div>`;
      }
    }

    // === ALL REFERENCES TAB ===
    async function renderReferencesTab(container, trialId) {
      try {
        // Collect all references from different tabs
        const allReferences = [];

        // Get Patient Demographics references
        const demographicsSnapshot = await db.collection('patient_demographics').where('trial_id', '==', trialId).get();
        demographicsSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.source || data.source_link) {
            allReferences.push({
              source: data.source || 'N/A',
              link: data.source_link || null
            });
          }
        });

        // Get Safety Assessment references
        const safetySnapshot = await db.collection('trial_safety_assessments').where('trial_id', '==', trialId).get();
        safetySnapshot.forEach(doc => {
          const data = doc.data();
          if (data.source || data.link) {
            allReferences.push({
              source: data.source || 'N/A',
              link: data.link || null
            });
          }
        });

        // Get Response Assessment references
        const responseSnapshot = await db.collection('trial_response_assessments').where('trial_id', '==', trialId).get();
        responseSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.source || data.link) {
            allReferences.push({
              source: data.source || 'N/A',
              link: data.link || null
            });
          }
        });

        // Get Milestone references
        const milestonesSnapshot = await db.collection('trial_milestones').where('trial_id', '==', trialId).get();
        milestonesSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.reference_link) {
            allReferences.push({
              source: data.milestone_event || 'N/A',
              link: data.reference_link || null
            });
          }
        });

        // Get specific references (new collection for standalone references)
        const specificRefsSnapshot = await db.collection('trial_specific_references').where('trial_id', '==', trialId).get();
        const specificReferences = [];
        specificRefsSnapshot.forEach(doc => {
          const data = doc.data();
          data._docId = doc.id;
          specificReferences.push(data);
          // Note: NOT adding to allReferences - specific references only show in manage section
        });

        // Remove duplicates based on source and link combination
        const uniqueReferences = [];
        const seen = new Set();

        allReferences.forEach(ref => {
          const key = `${ref.source}|${ref.link || ''}`;
          if (!seen.has(key)) {
            seen.add(key);
            uniqueReferences.push(ref);
          }
        });

        let html = `
          <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <h3 class="text-xl font-semibold text-blue-900">All References</h3>
            <button id="showAddReferenceFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
              <i class="fas fa-plus"></i> Add Specific Reference
            </button>
          </div>
        `;

        if (uniqueReferences.length === 0) {
          html += `<div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
            <p class="text-gray-600 italic">No references found for this trial.</p>
          </div>`;
        } else {
          html += `
            <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
              <h4 class="text-lg font-semibold text-blue-900 mb-3">All References</h4>
              <div class="overflow-x-auto max-h-80 scrollbar-thin border border-gray-300 rounded">
                <table class="min-w-full border-collapse border border-gray-300 text-sm">
                  <thead class="bg-blue-900 text-white sticky top-0">
                    <tr>
                      <th class="px-2 py-1 text-left">Source</th>
                      <th class="px-2 py-1 text-left">Reference Link</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

          uniqueReferences.forEach((ref, index) => {
            const linkHtml = ref.link ?
              (ref.source === 'CT.gov' ?
                `<a href="${ref.link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline font-medium" title="${ref.link}">${trialId}</a>` :
                `<a href="${ref.link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline" title="${ref.link}">${ref.link.length > 30 ? ref.link.substring(0, 30) + '...' : ref.link}</a>`
              ) : 'No link';

            const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

            html += `
              <tr class="${rowClass} hover:bg-blue-50 border-t border-gray-200">
                <td class="px-2 py-1" title="${ref.source}">${ref.source && ref.source.length > 25 ? ref.source.substring(0, 25) + '...' : ref.source}</td>
                <td class="px-2 py-1">${linkHtml}</td>
              </tr>
            `;
          });

          html += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }

        // Show specific references with edit/delete options
        if (specificReferences.length > 0) {
          html += `
            <div class="mt-6">
              <h4 class="text-lg font-semibold text-blue-900 mb-3">Manage Specific References</h4>
              <div class="overflow-x-auto max-h-80 scrollbar-thin border border-gray-300 rounded">
                <table class="min-w-full border-collapse border border-gray-300 text-sm">
                  <thead class="bg-blue-900 text-white sticky top-0">
                    <tr>
                      <th class="px-2 py-1 text-left">Source</th>
                      <th class="px-2 py-1 text-left">Reference Link</th>
                      <th class="px-2 py-1 text-left">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

          specificReferences.forEach((ref, index) => {
            const linkHtml = ref.reference_link ?
              (ref.source === 'CT.gov' ?
                `<a href="${ref.reference_link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline font-medium" title="${ref.reference_link}">${trialId}</a>` :
                `<a href="${ref.reference_link}" target="_blank" class="text-blue-600 hover:text-blue-800 underline" title="${ref.reference_link}">${ref.reference_link.length > 30 ? ref.reference_link.substring(0, 30) + '...' : ref.reference_link}</a>`
              ) : 'No link';

            const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

            html += `
              <tr class="${rowClass} hover:bg-blue-50 border-t border-gray-200">
                <td class="px-2 py-1" title="${ref.source || 'N/A'}">${ref.source && ref.source.length > 20 ? ref.source.substring(0, 20) + '...' : ref.source || 'N/A'}</td>
                <td class="px-2 py-1">${linkHtml}</td>
                <td class="px-2 py-1">
                  <button class="edit-reference-btn text-blue-700 hover:underline text-sm" data-doc-id="${ref._docId}" title="Edit">Edit</button>
                  <button class="delete-reference-btn text-red-600 hover:underline text-sm ml-2" data-doc-id="${ref._docId}" title="Delete">Delete</button>
                </td>
              </tr>
            `;
          });

          html += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }

        // Add reference editor form (hidden by default)
        html += `
          <div id="referenceEditorForm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
              <div class="flex justify-between items-center mb-4">
                <h4 id="referenceEditorTitle" class="text-xl font-semibold text-blue-900">Add Specific Reference</h4>
                <button id="closeReferenceEditor" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
              </div>

              <form id="referenceForm" novalidate>
                <input type="hidden" id="referenceEditId" name="reference_edit_id" value="" />

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label for="referenceSource" class="block text-sm font-medium text-gray-700 mb-1">Source *</label>
                    <input type="text" id="referenceSource" name="source" required
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                           placeholder="e.g., CT.gov, PubMed, etc.">
                  </div>
                  <div>
                    <label for="referenceLink" class="block text-sm font-medium text-gray-700 mb-1">Reference Link</label>
                    <input type="url" id="referenceLink" name="reference_link"
                           class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"
                           placeholder="https://example.com">
                  </div>
                </div>

                <div id="referenceFormMessage" class="text-sm mt-2"></div>

                <div class="flex justify-end gap-3 mt-6">
                  <button type="button" id="cancelReferenceBtn" class="px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50 transition">Cancel</button>
                  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">Save Reference</button>
                </div>
              </form>
            </div>
          </div>
        `;

        container.innerHTML = html;

        // Event handlers for adding new reference
        document.getElementById('showAddReferenceFormBtn').addEventListener('click', () => {
          openReferenceEditor();
        });

        // Event handlers for editing specific references
        container.querySelectorAll('.edit-reference-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const docId = e.target.closest('.edit-reference-btn').getAttribute('data-doc-id');
            const record = specificReferences.find(r => r._docId === docId);
            openReferenceEditor(record);
          });
        });

        // Event handlers for deleting specific references
        container.querySelectorAll('.delete-reference-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const docId = e.target.closest('.delete-reference-btn').getAttribute('data-doc-id');
            if (confirm('Are you sure you want to delete this reference?')) {
              try {
                await db.collection('trial_specific_references').doc(docId).delete();
                alert('Reference deleted successfully.');
                await loadTabContent('references');
              } catch (error) {
                alert('Error deleting reference: ' + error.message);
              }
            }
          });
        });

        // Close editor handlers
        document.getElementById('closeReferenceEditor').addEventListener('click', closeReferenceEditor);
        document.getElementById('cancelReferenceBtn').addEventListener('click', closeReferenceEditor);

        // Reference form submission
        document.getElementById('referenceForm').addEventListener('submit', async e => {
          e.preventDefault();
          const form = e.target;
          const editId = form.reference_edit_id.value;
          const source = form.source.value.trim();

          if (!source) {
            showReferenceFormMessage('Source is required.', true);
            return;
          }

          // Collect all reference data
          const updateData = {
            trial_id: trialId,
            source: source,
            reference_link: form.reference_link.value.trim() || null,
            updated_at: new Date()
          };

          // If editing existing record, update it; otherwise create new
          if (editId) {
            try {
              await db.collection('trial_specific_references').doc(editId).update(updateData);
              showReferenceFormMessage('Reference updated successfully.');
              setTimeout(async () => {
                closeReferenceEditor();
                await loadTabContent('references');
              }, 1000);
            } catch (error) {
              showReferenceFormMessage('Error updating reference: ' + error.message, true);
            }
          } else {
            updateData.created_at = new Date();
            try {
              await db.collection('trial_specific_references').add(updateData);
              showReferenceFormMessage('Reference saved successfully.');
              setTimeout(async () => {
                closeReferenceEditor();
                await loadTabContent('references');
              }, 1000);
            } catch (error) {
              showReferenceFormMessage('Error saving reference: ' + error.message, true);
            }
          }
        });

        function openReferenceEditor(referenceData = null) {
          const form = document.getElementById('referenceForm');
          const title = document.getElementById('referenceEditorTitle');

          if (referenceData) {
            title.textContent = 'Edit Specific Reference';
            form.reference_edit_id.value = referenceData._docId;
            form.source.value = referenceData.source || '';
            form.reference_link.value = referenceData.reference_link || '';
          } else {
            title.textContent = 'Add Specific Reference';
            form.reset();
            form.reference_edit_id.value = '';
          }

          document.getElementById('referenceEditorForm').classList.remove('hidden');
          document.getElementById('referenceSource').focus();
          showReferenceFormMessage('');
        }

        function closeReferenceEditor() {
          document.getElementById('referenceEditorForm').classList.add('hidden');
          document.getElementById('referenceForm').reset();
          showReferenceFormMessage('');
        }

        function showReferenceFormMessage(msg, isError = false) {
          const el = document.getElementById('referenceFormMessage');
          el.textContent = msg;
          el.className = isError ? 'text-sm mt-2 text-red-600' : 'text-sm mt-2 text-green-600';
          if (msg) setTimeout(() => { el.textContent = ''; }, 4000);
        }

      } catch (error) {
        container.innerHTML = `<div class="text-red-600">Error loading references: ${error.message}</div>`;
      }
    }

    // === COMMENTARY TAB ===
    async function renderCommentaryTab(container, trialId) {
      try {
        // Get commentary data from new trial_commentary collection (doesn't affect existing data)
        let comments = [];
        try {
          const querySnapshot = await db.collection('trial_commentary').where('trial_id', '==', trialId).get();
          querySnapshot.forEach(doc => {
            const data = doc.data();
            data._docId = doc.id;
            comments.push(data);
          });
          // Sort comments by created_at in JavaScript (newest first)
          comments.sort((a, b) => {
            const dateA = new Date(a.created_at || 0);
            const dateB = new Date(b.created_at || 0);
            return dateB - dateA;
          });
        } catch (queryError) {
          console.log('Commentary collection not found or empty, starting fresh:', queryError.message);
          // This is expected for new installations - collection will be created when first comment is added
        }

        let html = `
          <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <h3 class="text-xl font-semibold text-blue-900">Trial Commentary</h3>
            <button id="showAddCommentFormBtn" class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm flex items-center gap-2">
              <i class="fas fa-plus"></i> Add Comment
            </button>
          </div>
        `;

        if (comments.length === 0) {
          html += `<p class="text-gray-600 italic mb-4">No comments added yet. Click "Add Comment" to add the first comment.</p>`;
        } else {
          html += `<div class="space-y-4 mb-6">`;

          comments.forEach(comment => {
            const createdDate = comment.created_at ? new Date(comment.created_at).toLocaleString() : 'N/A';
            const updatedDate = comment.updated_at ? new Date(comment.updated_at).toLocaleString() : 'N/A';
            const isEdited = comment.updated_at && comment.updated_at !== comment.created_at;

            html += `
              <div class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm hover:shadow-md transition">
                <div class="flex justify-between items-start mb-3">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="font-semibold text-blue-900">${comment.created_by_user || 'Unknown User'}</span>
                      <span class="text-xs text-gray-500">•</span>
                      <span class="text-sm text-gray-600">${createdDate}</span>
                      ${isEdited ? `<span class="text-xs text-gray-500 italic">• Edited: ${updatedDate}</span>` : ''}
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button data-doc-id="${comment._docId}" class="edit-comment-btn text-blue-700 hover:underline text-sm">
                      <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button data-doc-id="${comment._docId}" class="remove-comment-btn text-red-600 hover:underline text-sm">
                      <i class="fas fa-trash mr-1"></i>Remove
                    </button>
                  </div>
                </div>
                <div class="text-gray-700 whitespace-pre-wrap">${comment.comment_text || ''}</div>
              </div>
            `;
          });

          html += `</div>`;
        }

        // Add Comment Form (hidden initially)
        html += `
          <form id="addCommentForm" class="mt-6 bg-gray-50 p-4 rounded shadow-md max-w-4xl hidden" novalidate>
            <h4 class="text-lg font-semibold text-blue-900 mb-4">Add / Edit Comment</h4>
            <input type="hidden" id="commentEditId" name="comment_edit_id" value="" />

            <div class="grid grid-cols-1 gap-4">
              <!-- Comment Text -->
              <div>
                <label for="commentText" class="block font-medium mb-1">Comment *</label>
                <textarea id="commentText" name="comment_text" rows="4" required placeholder="Enter your comment about this trial..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-600"></textarea>
              </div>

              <!-- Form Buttons -->
              <div class="flex justify-end gap-4 mt-4">
                <button type="button" id="cancelCommentBtn" class="bg-gray-400 text-white font-semibold rounded px-6 py-2 hover:bg-gray-500 transition">
                  <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button type="submit" class="bg-green-700 text-white font-semibold rounded px-6 py-2 hover:bg-green-600 transition">
                  <i class="fas fa-save mr-2"></i>Save Comment
                </button>
              </div>
              <div id="commentFormMessage" class="text-sm mt-2"></div>
            </div>
          </form>
        `;

        container.innerHTML = html;

        // Add event listeners
        setupCommentaryEventListeners(trialId);

      } catch (error) {
        console.error('Error loading commentary:', error);
        container.innerHTML = '<p class="text-red-600">Error loading commentary.</p>';
      }
    }

    // Setup event listeners for commentary tab
    function setupCommentaryEventListeners(trialId) {
      const showFormBtn = document.getElementById('showAddCommentFormBtn');
      const form = document.getElementById('addCommentForm');
      const cancelBtn = document.getElementById('cancelCommentBtn');
      const messageDiv = document.getElementById('commentFormMessage');

      // Show add comment form
      showFormBtn.addEventListener('click', () => {
        form.classList.remove('hidden');
        form.reset();
        document.getElementById('commentEditId').value = '';
        form.querySelector('h4').textContent = 'Add Comment';
        form.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Save Comment';
        messageDiv.innerHTML = '';
        document.getElementById('commentText').focus();
      });

      // Cancel form
      cancelBtn.addEventListener('click', () => {
        form.classList.add('hidden');
        form.reset();
        messageDiv.innerHTML = '';
      });

      // Form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const commentText = formData.get('comment_text').trim();

        if (!commentText) {
          messageDiv.innerHTML = '<p class="text-red-600">Comment text is required.</p>';
          return;
        }

        try {
          messageDiv.innerHTML = '<p class="text-blue-600">Saving comment...</p>';

          const editId = formData.get('comment_edit_id');
          const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');

          // Create new comment data (doesn't modify existing trial data)
          const commentData = {
            trial_id: trialId,
            comment_text: commentText,
            created_by_user: currentUser.username || 'Unknown',
            created_at: editId ? undefined : new Date().toISOString(),
            updated_at: new Date().toISOString()
          };

          if (editId) {
            // Update existing comment (only in trial_commentary collection)
            delete commentData.created_at;
            await db.collection('trial_commentary').doc(editId).update(commentData);
            messageDiv.innerHTML = '<p class="text-green-600">Comment updated successfully!</p>';
          } else {
            // Add new comment (only to trial_commentary collection)
            await db.collection('trial_commentary').add(commentData);
            messageDiv.innerHTML = '<p class="text-green-600">Comment added successfully!</p>';
          }

          // Hide form and refresh
          setTimeout(() => {
            form.classList.add('hidden');
            renderCommentaryTab(document.getElementById('tabContent'), trialId);
          }, 1000);

        } catch (error) {
          console.error('Error saving comment:', error);
          messageDiv.innerHTML = '<p class="text-red-600">Error saving comment: ' + error.message + '</p>';
        }
      });

      // Edit comment buttons
      document.querySelectorAll('.edit-comment-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const docId = btn.getAttribute('data-doc-id');
          try {
            const doc = await db.collection('trial_commentary').doc(docId).get();
            if (doc.exists) {
              const data = doc.data();

              // Pre-fill form
              document.getElementById('commentEditId').value = docId;
              document.getElementById('commentText').value = data.comment_text || '';

              // Update form title and button
              form.querySelector('h4').textContent = 'Edit Comment';
              form.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>Update Comment';

              // Show form
              form.classList.remove('hidden');
              messageDiv.innerHTML = '';
              document.getElementById('commentText').focus();
            }
          } catch (error) {
            console.error('Error loading comment for edit:', error);
            alert('Error loading comment for editing.');
          }
        });
      });

      // Remove comment buttons
      document.querySelectorAll('.remove-comment-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const docId = btn.getAttribute('data-doc-id');
          if (confirm('Are you sure you want to remove this comment?')) {
            try {
              await db.collection('trial_commentary').doc(docId).delete();
              renderCommentaryTab(document.getElementById('tabContent'), trialId);
            } catch (error) {
              console.error('Error removing comment:', error);
              alert('Error removing comment: ' + error.message);
            }
          }
        });
      });
    }

    // === ENHANCED DROPDOWN MANAGEMENT FUNCTIONS ===

    // Collection mapping for separate Firestore collections
    const DROPDOWN_COLLECTIONS = {
      'phases': 'trial_phases',
      'statuses': 'trial_statuses',
      'study_types': 'study_types',
      'allocations': 'trial_allocations',
      'product_list': 'product_list',
      'indications_list': 'indications_list',
      'arm_types': 'arm_types',
      'response_types': 'response_types',
      'duration_formats': 'duration_formats',
      'assessment_types': 'assessment_types',
      'survival_endpoints': 'survival_endpoints',
      'mfu_units': 'mfu_units',
      'milestone_events': 'milestone_events',
      'milestone_statuses': 'milestone_statuses',
      'active_statuses': 'active_statuses',
      'user_roles': 'user_roles'
    };

    // Initialize enhanced dropdown management
    function initializeEnhancedDropdownManagement() {
      const categorySelect = document.getElementById('dropdownCategory');
      const addForm = document.getElementById('addDropdownOptionForm');
      const searchInput = document.getElementById('optionsSearch');

      if (categorySelect) {
        categorySelect.addEventListener('change', loadEnhancedDropdownOptions);
      }

      if (addForm) {
        addForm.addEventListener('submit', addEnhancedDropdownOption);
      }

      if (searchInput) {
        searchInput.addEventListener('input', filterDropdownOptions);
      }
    }

    // Load dropdown options for selected category with search
    async function loadEnhancedDropdownOptions() {
      const category = document.getElementById('dropdownCategory').value;
      const optionsList = document.getElementById('optionsList');
      const synonymsField = document.getElementById('synonymsField');

      if (!category) {
        optionsList.innerHTML = '<p class="text-gray-500 italic">Select a category to view options</p>';
        synonymsField.classList.add('hidden');
        return;
      }

      // Show synonyms field only for product_list
      if (category === 'product_list') {
        synonymsField.classList.remove('hidden');
      } else {
        synonymsField.classList.add('hidden');
      }

      try {
        optionsList.innerHTML = '<p class="text-gray-500">Loading options...</p>';

        const collectionName = DROPDOWN_COLLECTIONS[category];
        console.log(`Loading from collection: ${collectionName}`);

        const snapshot = await db.collection(collectionName).orderBy('value', 'asc').get();

        if (snapshot.empty) {
          console.log(`Collection ${collectionName} is empty, initializing defaults`);
          // Initialize with default options if collection doesn't exist
          await initializeEnhancedDefaultOptions(category);
          // Reload after initialization
          setTimeout(() => loadEnhancedDropdownOptions(), 1000);
          return;
        }

        window.currentDropdownOptions = [];
        snapshot.forEach(doc => {
          const option = { id: doc.id, ...doc.data() };
          window.currentDropdownOptions.push(option);
        });

        console.log(`Loaded ${window.currentDropdownOptions.length} options for ${category}`);
        displayDropdownOptions(window.currentDropdownOptions);

      } catch (error) {
        console.error('Error loading dropdown options:', error);
        optionsList.innerHTML = '<p class="text-red-500">Error loading options: ' + error.message + '</p>';
      }
    }

    // Display dropdown options with search filtering
    function displayDropdownOptions(options) {
      const optionsList = document.getElementById('optionsList');
      const category = document.getElementById('dropdownCategory').value;

      if (!options || options.length === 0) {
        optionsList.innerHTML = '<p class="text-gray-500 italic">No options found for this category</p>';
        return;
      }

      let html = '';
      options.forEach(option => {
        const synonymsText = option.synonyms && Array.isArray(option.synonyms) && option.synonyms.length > 0
          ? option.synonyms.join(', ')
          : '';

        html += `
          <div class="flex justify-between items-center p-3 bg-gray-50 rounded border hover:bg-gray-100 transition">
            <div class="flex-1">
              <div class="font-medium text-gray-800">${option.value}</div>
              ${synonymsText ? `<div class="text-gray-600 text-sm mt-1"><strong>Synonyms:</strong> ${synonymsText}</div>` : ''}
            </div>
            <div class="flex gap-2">
              <button onclick="editDropdownOption('${option.id}', '${category}')" class="text-blue-600 hover:text-blue-800 text-sm px-2 py-1 rounded hover:bg-blue-50" title="Edit">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="removeEnhancedDropdownOption('${option.id}', '${category}')" class="text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded hover:bg-red-50" title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });

      optionsList.innerHTML = html;
    }

    // Filter dropdown options based on search
    function filterDropdownOptions() {
      const searchTerm = document.getElementById('optionsSearch').value.toLowerCase();

      if (!window.currentDropdownOptions) return;

      const filteredOptions = window.currentDropdownOptions.filter(option => {
        const value = option.value.toLowerCase();

        // Check value
        if (value.includes(searchTerm)) return true;

        // Check synonyms
        if (option.synonyms && Array.isArray(option.synonyms)) {
          return option.synonyms.some(synonym =>
            synonym.toLowerCase().includes(searchTerm)
          );
        }

        return false;
      });

      displayDropdownOptions(filteredOptions);
    }

    // Add new dropdown option to separate collection
    async function addEnhancedDropdownOption(event) {
      event.preventDefault();

      const category = document.getElementById('dropdownCategory').value;
      const value = document.getElementById('newOptionValue').value.trim();
      const synonymsText = document.getElementById('newOptionSynonyms').value.trim();
      const messageDiv = document.getElementById('dropdownMessage');

      if (!category) {
        messageDiv.innerHTML = '<p class="text-red-600">Please select a category first</p>';
        return;
      }

      if (!value) {
        messageDiv.innerHTML = '<p class="text-red-600">Option value is required</p>';
        return;
      }

      try {
        messageDiv.innerHTML = '<p class="text-blue-600">Checking for duplicates...</p>';

        const collectionName = DROPDOWN_COLLECTIONS[category];

        // Check if option already exists (case-insensitive)
        const existingSnapshot = await db.collection(collectionName).get();
        const existingValues = [];
        existingSnapshot.forEach(doc => {
          const data = doc.data();
          existingValues.push(data.value.toLowerCase());
          // Also check synonyms for duplicates
          if (data.synonyms && Array.isArray(data.synonyms)) {
            data.synonyms.forEach(synonym => {
              existingValues.push(synonym.toLowerCase());
            });
          }
        });

        // Check if the new value conflicts with existing values or synonyms
        if (existingValues.includes(value.toLowerCase())) {
          messageDiv.innerHTML = '<p class="text-red-600"><i class="fas fa-exclamation-triangle mr-1"></i>Duplicate detected! This option already exists in this category</p>';
          return;
        }

        // Process synonyms
        let synonymsArray = [];
        if (synonymsText) {
          synonymsArray = synonymsText.split(',').map(s => s.trim()).filter(s => s.length > 0);

          // Check if any synonym conflicts with existing values
          for (const synonym of synonymsArray) {
            if (existingValues.includes(synonym.toLowerCase())) {
              messageDiv.innerHTML = `<p class="text-red-600"><i class="fas fa-exclamation-triangle mr-1"></i>Duplicate detected! Synonym "${synonym}" already exists in this category</p>`;
              return;
            }
          }
        }

        messageDiv.innerHTML = '<p class="text-blue-600">Adding option...</p>';

        // Prepare option data
        const optionData = {
          value: value,
          created_at: new Date().toISOString(),
          created_by: JSON.parse(localStorage.getItem('currentUser') || '{}').username || 'Unknown'
        };

        // Add synonyms only for product_list
        if (category === 'product_list' && synonymsArray.length > 0) {
          optionData.synonyms = synonymsArray;
        }

        // Add new option to the specific collection
        await db.collection(collectionName).add(optionData);

        messageDiv.innerHTML = '<p class="text-green-600"><i class="fas fa-check mr-1"></i>Option added successfully!</p>';

        // Clear form
        document.getElementById('addDropdownOptionForm').reset();

        // Reload options
        loadEnhancedDropdownOptions();

        // Clear message after 3 seconds
        setTimeout(() => {
          messageDiv.innerHTML = '';
        }, 3000);

      } catch (error) {
        console.error('Error adding dropdown option:', error);
        messageDiv.innerHTML = '<p class="text-red-600">Error adding option: ' + error.message + '</p>';
      }
    }

    // Edit dropdown option
    async function editDropdownOption(docId, category) {
      try {
        const collectionName = DROPDOWN_COLLECTIONS[category];
        const doc = await db.collection(collectionName).doc(docId).get();

        if (!doc.exists) {
          alert('Option not found');
          return;
        }

        const option = doc.data();

        // Populate form for editing
        document.getElementById('newOptionValue').value = option.value || '';

        // Handle synonyms for product_list
        if (category === 'product_list') {
          const synonymsField = document.getElementById('newOptionSynonyms');
          if (option.synonyms && Array.isArray(option.synonyms)) {
            synonymsField.value = option.synonyms.join(', ');
          } else {
            synonymsField.value = '';
          }
        }

        // Change form to edit mode
        const form = document.getElementById('addDropdownOptionForm');
        form.dataset.mode = 'edit';
        form.dataset.docId = docId;
        form.dataset.category = category;

        // Change button text
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Update Option';

        // Scroll to form
        form.scrollIntoView({ behavior: 'smooth' });

        // Add event listener for cancel
        if (!window.editCancelListenerAdded) {
          const cancelBtn = document.createElement('button');
          cancelBtn.type = 'button';
          cancelBtn.className = 'mt-2 w-full bg-gray-500 text-white font-semibold rounded px-4 py-2 hover:bg-gray-600 transition';
          cancelBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Cancel Edit';
          cancelBtn.id = 'cancelEditBtn';

          cancelBtn.addEventListener('click', () => {
            form.reset();
            form.dataset.mode = 'add';
            delete form.dataset.docId;
            delete form.dataset.category;
            submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Add Option';
            cancelBtn.remove();
          });

          submitBtn.parentNode.insertBefore(cancelBtn, submitBtn.nextSibling);
          window.editCancelListenerAdded = true;
        }

        // Update form submission handler
        form.onsubmit = async (e) => {
          e.preventDefault();

          if (form.dataset.mode === 'edit') {
            await updateDropdownOption(form.dataset.docId, form.dataset.category);
          } else {
            await addEnhancedDropdownOption(e);
          }
        };

      } catch (error) {
        console.error('Error preparing option for edit:', error);
        alert('Error preparing option for edit: ' + error.message);
      }
    }

    // Update dropdown option
    async function updateDropdownOption(docId, category) {
      const value = document.getElementById('newOptionValue').value.trim();
      const synonymsText = document.getElementById('newOptionSynonyms').value.trim();
      const messageDiv = document.getElementById('dropdownMessage');

      if (!value) {
        messageDiv.innerHTML = '<p class="text-red-600">Option value is required</p>';
        return;
      }

      try {
        messageDiv.innerHTML = '<p class="text-blue-600">Updating option...</p>';

        const collectionName = DROPDOWN_COLLECTIONS[category];

        // Process synonyms
        let synonymsArray = [];
        if (category === 'product_list' && synonymsText) {
          synonymsArray = synonymsText.split(',').map(s => s.trim()).filter(s => s.length > 0);
        }

        // Prepare update data
        const updateData = {
          value: value,
          updated_at: new Date().toISOString(),
          updated_by: JSON.parse(localStorage.getItem('currentUser') || '{}').username || 'Unknown'
        };

        // Add synonyms only for product_list
        if (category === 'product_list') {
          updateData.synonyms = synonymsArray;
        }

        // Update option
        await db.collection(collectionName).doc(docId).update(updateData);

        messageDiv.innerHTML = '<p class="text-green-600">Option updated successfully!</p>';

        // Reset form
        const form = document.getElementById('addDropdownOptionForm');
        form.reset();
        form.dataset.mode = 'add';
        delete form.dataset.docId;
        delete form.dataset.category;

        // Change button text back
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Add Option';

        // Remove cancel button
        const cancelBtn = document.getElementById('cancelEditBtn');
        if (cancelBtn) cancelBtn.remove();

        // Reset form submission handler
        form.onsubmit = addEnhancedDropdownOption;

        // Reload options
        loadEnhancedDropdownOptions();

        // Clear message after 3 seconds
        setTimeout(() => {
          messageDiv.innerHTML = '';
        }, 3000);

      } catch (error) {
        console.error('Error updating dropdown option:', error);
        messageDiv.innerHTML = '<p class="text-red-600">Error updating option: ' + error.message + '</p>';
      }
    }

    // Remove dropdown option from separate collection
    async function removeEnhancedDropdownOption(docId, category) {
      if (!confirm('Are you sure you want to remove this option?')) {
        return;
      }

      try {
        const collectionName = DROPDOWN_COLLECTIONS[category];
        await db.collection(collectionName).doc(docId).delete();

        // Reload options
        loadEnhancedDropdownOptions();

      } catch (error) {
        console.error('Error removing dropdown option:', error);
        alert('Error removing option: ' + error.message);
      }
    }

    // Initialize default options for separate collections
    async function initializeEnhancedDefaultOptions(category) {
      const collectionName = DROPDOWN_COLLECTIONS[category];

      const defaultOptions = {
        'phases': [
          { value: 'Phase I' },
          { value: 'Phase I/II' },
          { value: 'Phase II' },
          { value: 'Phase II/III' },
          { value: 'Phase III' },
          { value: 'Phase IV' }
        ],
        'statuses': [
          { value: 'Recruiting' },
          { value: 'Active' },
          { value: 'Completed' },
          { value: 'Terminated' },
          { value: 'Suspended' }
        ],
        'study_types': [
          { value: 'Interventional' },
          { value: 'Observational' },
          { value: 'Expanded Access' }
        ],
        'allocations': [
          { value: 'Randomized' },
          { value: 'Non-Randomized' },
          { value: 'Single Group' }
        ],
        'product_list': [
          { value: 'Product A', synonyms: ['Drug A', 'Compound A'] },
          { value: 'Product B', synonyms: ['Drug B', 'Compound B'] },
          { value: 'Product C', synonyms: ['Drug C', 'Compound C'] }
        ],
        'indications_list': [
          { value: 'Breast Cancer' },
          { value: 'Lung Cancer' },
          { value: 'Colorectal Cancer' },
          { value: 'Melanoma' },
          { value: 'Leukemia' }
        ],
        'arm_types': [
          { value: 'Active Comparator', label: 'Active Comparator', order: 1 },
          { value: 'Case', label: 'Case', order: 2 },
          { value: 'Control', label: 'Control', order: 3 },
          { value: 'Experimental', label: 'Experimental', order: 4 },
          { value: 'Exposure Comparison', label: 'Exposure Comparison', order: 5 },
          { value: 'No Intervention', label: 'No Intervention', order: 6 },
          { value: 'Other', label: 'Other', order: 7 },
          { value: 'Placebo Comparator', label: 'Placebo Comparator', order: 8 },
          { value: 'Sham Comparator', label: 'Sham Comparator', order: 9 },
          { value: 'Treatment Comparison', label: 'Treatment Comparison', order: 10 }
        ],
        'response_types': [
          { value: 'Complete Response (CR)', label: 'Complete Response (CR)', order: 1 },
          { value: 'Partial Response (PR)', label: 'Partial Response (PR)', order: 2 },
          { value: 'Stable Disease (SD)', label: 'Stable Disease (SD)', order: 3 },
          { value: 'Progressive Disease (PD)', label: 'Progressive Disease (PD)', order: 4 },
          { value: 'Overall Response Rate (ORR)', label: 'Overall Response Rate (ORR)', order: 5 },
          { value: 'Disease Control Rate (DCR)', label: 'Disease Control Rate (DCR)', order: 6 },
          { value: 'Clinical Benefit Rate (CBR)', label: 'Clinical Benefit Rate (CBR)', order: 7 },
          { value: 'Objective Response Rate', label: 'Objective Response Rate', order: 8 },
          { value: 'Best Overall Response', label: 'Best Overall Response', order: 9 },
          { value: 'Confirmed Response', label: 'Confirmed Response', order: 10 },
          { value: 'Unconfirmed Response', label: 'Unconfirmed Response', order: 11 },
          { value: 'Not Evaluable (NE)', label: 'Not Evaluable (NE)', order: 12 }
        ],
        'duration_formats': [
          { value: 'Days', label: 'Days', order: 1 },
          { value: 'Weeks', label: 'Weeks', order: 2 },
          { value: 'Months', label: 'Months', order: 3 },
          { value: 'Years', label: 'Years', order: 4 }
        ],
        'mfu_units': [
          { value: 'Days', label: 'Days', order: 1 },
          { value: 'Weeks', label: 'Weeks', order: 2 },
          { value: 'Months', label: 'Months', order: 3 },
          { value: 'Years', label: 'Years', order: 4 }
        ],
        'assessment_types': [
          { value: 'RECIST', label: 'RECIST', order: 1 },
          { value: 'WHO', label: 'WHO', order: 2 },
          { value: 'Investigator Assessment', label: 'Investigator Assessment', order: 3 },
          { value: 'Independent Review', label: 'Independent Review', order: 4 }
        ],
        'survival_endpoints': [
          { value: 'Overall Survival (OS)', label: 'Overall Survival (OS)', order: 1 },
          { value: 'Progression-Free Survival (PFS)', label: 'Progression-Free Survival (PFS)', order: 2 },
          { value: 'Disease-Free Survival (DFS)', label: 'Disease-Free Survival (DFS)', order: 3 },
          { value: 'Event-Free Survival (EFS)', label: 'Event-Free Survival (EFS)', order: 4 },
          { value: 'Time to Progression (TTP)', label: 'Time to Progression (TTP)', order: 5 },
          { value: 'Duration of Response (DOR)', label: 'Duration of Response (DOR)', order: 6 }
        ],
        'milestone_events': [
          { value: 'Regulatory', label: 'Regulatory', order: 1 },
          { value: 'Commercial', label: 'Commercial', order: 2 },
          { value: 'Clinical', label: 'Clinical', order: 3 }
        ],
        'milestone_statuses': [
          { value: 'Completed', label: 'Completed', order: 1 },
          { value: 'Anticipated', label: 'Anticipated', order: 2 }
        ],
        'active_statuses': [
          { value: 'Active', label: 'Active', order: 1 },
          { value: 'Inactive', label: 'Inactive', order: 2 }
        ],
        'user_roles': [
          { value: 'admin', label: 'Admin - Full access to all features', order: 1 },
          { value: 'editor', label: 'Editor - Can view and edit data', order: 2 },
          { value: 'viewer', label: 'Viewer - Read-only access', order: 3 }
        ]
      };

      const options = defaultOptions[category];
      if (!options) return;

      try {
        const batch = db.batch();
        options.forEach(option => {
          const docRef = db.collection(collectionName).doc();
          const optionData = {
            value: option.value,
            created_at: new Date().toISOString(),
            created_by: 'system'
          };

          // Add synonyms only for product_list
          if (category === 'product_list' && option.synonyms) {
            optionData.synonyms = option.synonyms;
          }

          batch.set(docRef, optionData);
        });

        await batch.commit();
        console.log(`Initialized default options for ${category} in collection ${collectionName}`);
      } catch (error) {
        console.error(`Error initializing default options for ${category}:`, error);
      }
    }

    // Load dropdown options from Firestore (updated for separate collections)
    async function loadDropdownFromFirestore(category, selectId, includeEmpty = true) {
      try {
        console.log(`Loading dropdown for category: ${category}, selectId: ${selectId}`);

        // Use separate collection for each dropdown type
        const collectionName = DROPDOWN_COLLECTIONS[category] || category;
        console.log(`Using collection: ${collectionName}`);

        const snapshot = await db.collection(collectionName)
          .orderBy('value', 'asc')
          .get();

        const select = document.getElementById(selectId);
        if (!select) {
          console.error(`Select element with ID '${selectId}' not found`);
          return;
        }

        console.log(`Found ${snapshot.size} options for category ${category}`);

        // Clear existing options except the first one if includeEmpty is true
        if (includeEmpty && select.options.length > 0) {
          const firstOption = select.options[0];
          select.innerHTML = '';
          select.appendChild(firstOption);
        } else {
          select.innerHTML = '';
          if (includeEmpty) {
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Select ' + category.replace('_', ' ');
            select.appendChild(emptyOption);
          }
        }

        if (snapshot.empty) {
          console.log(`No options found for ${category}, initializing defaults`);
          // Initialize with defaults if empty
          await initializeEnhancedDefaultOptions(category);
          // Retry loading
          return loadDropdownFromFirestore(category, selectId, includeEmpty);
        }

        snapshot.forEach(doc => {
          const option = doc.data();
          console.log(`Adding option: ${option.value} - ${option.label || option.value}`);
          const optionElement = document.createElement('option');
          optionElement.value = option.value;
          optionElement.textContent = option.label || option.value;
          select.appendChild(optionElement);
        });

        console.log(`Successfully loaded ${snapshot.size} options for ${category}`);

      } catch (error) {
        console.error(`Error loading dropdown ${category}:`, error);
        // Fallback to initialize defaults
        await initializeEnhancedDefaultOptions(category);
      }
    }

    // === SEARCHABLE DROPDOWN FUNCTIONALITY ===

    // Initialize searchable dropdowns for products and indications
    function initializeSearchableDropdowns() {
      // Initialize product tag dropdowns
      document.querySelectorAll('.product-tag-selector').forEach(selector => {
        initializeProductDropdown(selector);
      });

      // Initialize indication dropdowns
      document.querySelectorAll('.indication-selector').forEach(selector => {
        initializeIndicationDropdown(selector);
      });
    }

    // Initialize product dropdown with search and selection
    async function initializeProductDropdown(selector) {
      const searchInput = selector.querySelector('.product-search-input');
      const hiddenInput = selector.querySelector('input[name="product_tag"]');
      const dropdownList = selector.querySelector('.dropdown-list');
      const toggleBtn = selector.querySelector('.dropdown-toggle');

      let products = [];

      // Load products from Firestore
      try {
        const snapshot = await db.collection('product_list').orderBy('order', 'asc').get();
        if (snapshot.empty) {
          // Initialize with defaults if empty
          await initializeEnhancedDefaultOptions('product_list');
          const retrySnapshot = await db.collection('product_list').orderBy('order', 'asc').get();
          retrySnapshot.forEach(doc => {
            const product = doc.data();
            products.push(product);
          });
        } else {
          snapshot.forEach(doc => {
            const product = doc.data();
            products.push(product);
          });
        }
      } catch (error) {
        console.error('Error loading products:', error);
      }

      // Search functionality
      searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filteredProducts = products.filter(product =>
          (product.label || product.value).toLowerCase().includes(searchTerm)
        );
        displayDropdownOptions(dropdownList, filteredProducts, (product) => {
          searchInput.value = product.label || product.value;
          hiddenInput.value = product.value;
          dropdownList.classList.add('hidden');
        });
        dropdownList.classList.remove('hidden');
      });

      // Toggle dropdown
      toggleBtn.addEventListener('click', () => {
        if (dropdownList.classList.contains('hidden')) {
          displayDropdownOptions(dropdownList, products, (product) => {
            searchInput.value = product.label || product.value;
            hiddenInput.value = product.value;
            dropdownList.classList.add('hidden');
          });
          dropdownList.classList.remove('hidden');
        } else {
          dropdownList.classList.add('hidden');
        }
      });

      // Hide dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!selector.contains(e.target)) {
          dropdownList.classList.add('hidden');
        }
      });

      // Allow custom values
      searchInput.addEventListener('blur', () => {
        setTimeout(() => {
          if (searchInput.value && !hiddenInput.value) {
            hiddenInput.value = searchInput.value;
          }
        }, 200);
      });
    }

    // Initialize indication dropdown with search and selection
    async function initializeIndicationDropdown(selector) {
      const searchInput = selector.querySelector('.indication-search-input');
      const hiddenInput = selector.querySelector('input[name="indication"]');
      const dropdownList = selector.querySelector('.dropdown-list');
      const toggleBtn = selector.querySelector('.dropdown-toggle');

      let indications = [];

      // Load indications from Firestore
      try {
        const snapshot = await db.collection('indications_list').orderBy('order', 'asc').get();
        if (snapshot.empty) {
          // Initialize with defaults if empty
          await initializeEnhancedDefaultOptions('indications_list');
          const retrySnapshot = await db.collection('indications_list').orderBy('order', 'asc').get();
          retrySnapshot.forEach(doc => {
            const indication = doc.data();
            indications.push(indication);
          });
        } else {
          snapshot.forEach(doc => {
            const indication = doc.data();
            indications.push(indication);
          });
        }
      } catch (error) {
        console.error('Error loading indications:', error);
      }

      // Search functionality
      searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filteredIndications = indications.filter(indication =>
          (indication.label || indication.value).toLowerCase().includes(searchTerm)
        );
        displayDropdownOptions(dropdownList, filteredIndications, (indication) => {
          searchInput.value = indication.label || indication.value;
          hiddenInput.value = indication.value;
          dropdownList.classList.add('hidden');
        });
        dropdownList.classList.remove('hidden');
      });

      // Toggle dropdown
      toggleBtn.addEventListener('click', () => {
        if (dropdownList.classList.contains('hidden')) {
          displayDropdownOptions(dropdownList, indications, (indication) => {
            searchInput.value = indication.label || indication.value;
            hiddenInput.value = indication.value;
            dropdownList.classList.add('hidden');
          });
          dropdownList.classList.remove('hidden');
        } else {
          dropdownList.classList.add('hidden');
        }
      });

      // Hide dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!selector.contains(e.target)) {
          dropdownList.classList.add('hidden');
        }
      });

      // Allow custom values
      searchInput.addEventListener('blur', () => {
        setTimeout(() => {
          if (searchInput.value && !hiddenInput.value) {
            hiddenInput.value = searchInput.value;
          }
        }, 200);
      });
    }

    // Display dropdown options with click handlers
    function displayDropdownOptions(dropdownList, options, onSelect) {
      if (!options || options.length === 0) {
        dropdownList.innerHTML = '<div class="px-3 py-2 text-gray-500 text-sm">No options found</div>';
        return;
      }

      let html = '';
      options.forEach(option => {
        html += `
          <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0"
               data-value="${option.value}">
            <div class="font-medium">${option.label || option.value}</div>
            ${option.description ? `<div class="text-gray-500 text-xs">${option.description}</div>` : ''}
          </div>
        `;
      });

      dropdownList.innerHTML = html;

      // Add click handlers
      dropdownList.querySelectorAll('[data-value]').forEach(item => {
        item.addEventListener('click', () => {
          const value = item.getAttribute('data-value');
          const option = options.find(opt => opt.value === value);
          if (option && onSelect) {
            onSelect(option);
          }
        });
      });
    }

    // Function to clear saved tab (useful for debugging or reset)
    function clearSavedTab() {
      localStorage.removeItem('currentTab');
    }

    // Function to manually set a tab (useful for programmatic navigation)
    function setActiveTab(tabName) {
      const tabBtn = document.querySelector(`[data-tab="${tabName}"]`);
      if (tabBtn) {
        // Trigger click event to activate the tab
        tabBtn.click();
      }
    }

    // Load audit trail data with enhanced filtering
    async function loadAuditTrailData() {
      try {
        const container = document.getElementById('auditLogsContainer');
        if (!container) return;

        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
            <p class="text-gray-500 mt-2">🔍 Searching audit logs...</p>
          </div>
        `;

        // Load users for filter dropdown
        await loadUsersForAuditFilter();

        // Get all filter values
        const logType = document.getElementById('auditLogType')?.value || 'all';
        const selectedUser = document.getElementById('auditUser')?.value || 'all';
        const selectedAction = document.getElementById('auditAction')?.value || 'all';
        const selectedEntity = document.getElementById('auditEntity')?.value || 'all';
        const trialId = document.getElementById('auditTrialId')?.value || '';
        const searchText = document.getElementById('auditSearch')?.value || '';
        const dateFrom = document.getElementById('auditDateFrom')?.value || '';
        const dateTo = document.getElementById('auditDateTo')?.value || '';

        console.log('🔍 Loading audit data with filters:', {
          logType, selectedUser, selectedAction, selectedEntity, trialId, searchText, dateFrom, dateTo
        });

        let auditData = [];

        // Load different types of logs based on filter
        if (logType === 'all' || logType === 'audit_trail') {
          const auditTrailData = await loadAuditTrailLogsEnhanced(selectedUser, selectedAction, selectedEntity, trialId, dateFrom, dateTo);
          auditData = auditData.concat(auditTrailData);
        }

        if (logType === 'all' || logType === 'user_activity') {
          const userActivityData = await loadUserActivityLogs(selectedUser, dateFrom, dateTo);
          auditData = auditData.concat(userActivityData);
        }

        if (logType === 'all' || logType === 'error_logs') {
          const errorLogsData = await loadErrorLogs(selectedUser, dateFrom, dateTo);
          auditData = auditData.concat(errorLogsData);
        }

        // Apply text search filter
        if (searchText) {
          auditData = auditData.filter(log => {
            const searchLower = searchText.toLowerCase();
            return (
              (log.user_name && log.user_name.toLowerCase().includes(searchLower)) ||
              (log.trial_id && log.trial_id.toLowerCase().includes(searchLower)) ||
              (log.action && log.action.toLowerCase().includes(searchLower)) ||
              (log.entity_type && log.entity_type.toLowerCase().includes(searchLower)) ||
              (log.tab_name && log.tab_name.toLowerCase().includes(searchLower))
            );
          });
        }

        // Sort by timestamp (newest first)
        auditData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        console.log(`✅ Found ${auditData.length} audit records`);
        displayAuditLogs(auditData);

      } catch (error) {
        console.error('❌ Error loading audit trail:', error);
        const container = document.getElementById('auditLogsContainer');
        if (container) {
          container.innerHTML = `
            <div class="text-center py-8 text-red-600">
              <i class="fas fa-exclamation-triangle text-2xl"></i>
              <p class="mt-2">Error loading audit logs: ${error.message}</p>
              <p class="text-sm mt-1">Check console for details</p>
            </div>
          `;
        }
      }
    }

    // Load users for audit filter
    async function loadUsersForAuditFilter() {
      try {
        const usersSnapshot = await db.collection('users').get();
        const userSelect = document.getElementById('auditUser');
        if (!userSelect) return;

        // Clear existing options except "All Users"
        userSelect.innerHTML = '<option value="all">All Users</option>';

        usersSnapshot.forEach(doc => {
          const user = doc.data();
          const option = document.createElement('option');
          option.value = user.username;
          option.textContent = `${user.full_name} (${user.username})`;
          userSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading users for filter:', error);
      }
    }

    // Enhanced audit trail loading with multiple filters
    async function loadAuditTrailLogsEnhanced(user, action, entity, trialId, dateFrom, dateTo) {
      try {
        console.log('🔍 Loading enhanced audit trail logs...', {user, action, entity, trialId, dateFrom, dateTo});

        let query = db.collection('audit_trail');

        // Apply filters one by one
        if (user && user !== 'all') {
          query = query.where('username', '==', user);
          console.log('👤 Filtering by user:', user);
        }

        if (action && action !== 'all') {
          query = query.where('action', '==', action);
          console.log('⚡ Filtering by action:', action);
        }

        if (entity && entity !== 'all') {
          query = query.where('entity_type', '==', entity);
          console.log('📊 Filtering by entity:', entity);
        }

        if (trialId && trialId.trim() !== '') {
          query = query.where('trial_id', '==', trialId.trim());
          console.log('🧪 Filtering by trial ID:', trialId);
        }

        if (dateFrom) {
          const fromDate = new Date(dateFrom).toISOString();
          query = query.where('timestamp', '>=', fromDate);
          console.log('📅 Filtering from date:', fromDate);
        }

        if (dateTo) {
          const endDate = new Date(dateTo);
          endDate.setHours(23, 59, 59, 999);
          const toDate = endDate.toISOString();
          query = query.where('timestamp', '<=', toDate);
          console.log('📅 Filtering to date:', toDate);
        }

        console.log('🔍 Executing enhanced audit trail query...');
        const snapshot = await query.orderBy('timestamp', 'desc').limit(200).get();
        console.log(`📊 Found ${snapshot.size} audit trail records`);

        const logs = [];

        snapshot.forEach(doc => {
          const data = doc.data();
          data._id = doc.id;
          data._type = 'audit_trail';
          logs.push(data);
          console.log('📝 Audit record:', {
            id: doc.id,
            action: data.action,
            entity: data.entity_type,
            user: data.user_name,
            trial: data.trial_id,
            timestamp: data.timestamp
          });
        });

        console.log(`✅ Loaded ${logs.length} enhanced audit trail logs`);
        return logs;
      } catch (error) {
        console.error('❌ Error loading enhanced audit trail logs:', error);
        console.error('Error details:', error.message);
        return [];
      }
    }

    // Keep original function for backward compatibility
    async function loadAuditTrailLogs(user, dateFrom, dateTo) {
      return await loadAuditTrailLogsEnhanced(user, 'all', 'all', '', dateFrom, dateTo);
    }

    // Load user activity logs
    async function loadUserActivityLogs(user, dateFrom, dateTo) {
      try {
        let query = db.collection('user_activity');

        if (user && user !== 'all') {
          query = query.where('username', '==', user);
        }

        if (dateFrom) {
          query = query.where('timestamp', '>=', new Date(dateFrom).toISOString());
        }

        if (dateTo) {
          const endDate = new Date(dateTo);
          endDate.setHours(23, 59, 59, 999);
          query = query.where('timestamp', '<=', endDate.toISOString());
        }

        const snapshot = await query.orderBy('timestamp', 'desc').limit(100).get();
        const logs = [];

        snapshot.forEach(doc => {
          const data = doc.data();
          data._id = doc.id;
          data._type = 'user_activity';
          logs.push(data);
        });

        return logs;
      } catch (error) {
        console.error('Error loading user activity logs:', error);
        return [];
      }
    }

    // Load error logs
    async function loadErrorLogs(user, dateFrom, dateTo) {
      try {
        let query = db.collection('error_logs');

        if (user && user !== 'all') {
          query = query.where('username', '==', user);
        }

        if (dateFrom) {
          query = query.where('timestamp', '>=', new Date(dateFrom).toISOString());
        }

        if (dateTo) {
          const endDate = new Date(dateTo);
          endDate.setHours(23, 59, 59, 999);
          query = query.where('timestamp', '<=', endDate.toISOString());
        }

        const snapshot = await query.orderBy('timestamp', 'desc').limit(100).get();
        const logs = [];

        snapshot.forEach(doc => {
          const data = doc.data();
          data._id = doc.id;
          data._type = 'error_logs';
          logs.push(data);
        });

        return logs;
      } catch (error) {
        console.error('Error loading error logs:', error);
        return [];
      }
    }

    // Display audit logs in a simple table format
    function displayAuditLogs(auditData) {
      const container = document.getElementById('auditLogsContainer');
      if (!container) return;

      if (auditData.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-search text-2xl"></i>
            <p class="mt-2">No audit logs found for the selected criteria.</p>
            <p class="text-sm mt-1">Try adjusting your search filters or create some test data.</p>
          </div>
        `;
        return;
      }

      // Filter only audit trail data for cleaner display
      const auditTrailData = auditData.filter(log => log._type === 'audit_trail');

      let html = `
        <div class="mb-4 flex justify-between items-center">
          <h4 class="text-lg font-semibold text-blue-800">📊 Data Changes Found: ${auditTrailData.length} records</h4>
          <div class="text-sm text-gray-600">
            Total logs: ${auditData.length} | Data changes: ${auditTrailData.length}
          </div>
        </div>
      `;

      if (auditTrailData.length === 0) {
        html += `
          <div class="bg-yellow-50 border border-yellow-200 rounded p-4 text-center">
            <i class="fas fa-info-circle text-yellow-600"></i>
            <p class="text-yellow-800 mt-2">No data changes found. Only user activity and error logs are available.</p>
          </div>
        `;
      } else {
        // Create a simple table view
        html += `
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
              <thead class="bg-blue-900 text-white">
                <tr>
                  <th class="px-4 py-3 text-left">Date & Time</th>
                  <th class="px-4 py-3 text-left">User</th>
                  <th class="px-4 py-3 text-left">Action</th>
                  <th class="px-4 py-3 text-left">Data Type</th>
                  <th class="px-4 py-3 text-left">Trial ID</th>
                  <th class="px-4 py-3 text-left">What Changed</th>
                  <th class="px-4 py-3 text-left">Details</th>
                </tr>
              </thead>
              <tbody>
        `;

        auditTrailData.forEach((log, index) => {
          const timestamp = new Date(log.timestamp).toLocaleString();
          const rowClass = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';

          // Get action badge
          const actionBadge = getSimpleActionBadge(log.action);

          // Get entity display name
          const entityName = getEntityDisplayName(log.entity_type);

          // Get what changed summary
          const changesSummary = getChangesSummary(log);

          html += `
            <tr class="${rowClass} hover:bg-blue-50 border-t border-gray-200">
              <td class="px-4 py-3 text-sm">${timestamp}</td>
              <td class="px-4 py-3 text-sm font-medium">${log.user_name || 'Unknown'}</td>
              <td class="px-4 py-3">${actionBadge}</td>
              <td class="px-4 py-3 text-sm">${entityName}</td>
              <td class="px-4 py-3 text-sm font-mono">${log.trial_id || 'N/A'}</td>
              <td class="px-4 py-3 text-sm" style="max-width: 300px; word-wrap: break-word;">${changesSummary}</td>
              <td class="px-4 py-3">
                <button class="view-details-btn bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700"
                        data-log='${JSON.stringify(log).replace(/'/g, "&apos;")}'>
                  Full Details
                </button>
              </td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
        `;
      }

      // Add other log types summary if they exist
      const userActivityCount = auditData.filter(log => log._type === 'user_activity').length;
      const errorLogsCount = auditData.filter(log => log._type === 'error_logs').length;

      if (userActivityCount > 0 || errorLogsCount > 0) {
        html += `
          <div class="mt-6 bg-gray-50 p-4 rounded">
            <h5 class="font-semibold text-gray-800 mb-2">Other Activity Summary:</h5>
            <div class="flex gap-4 text-sm">
              ${userActivityCount > 0 ? `<span class="text-green-600">👤 User Activities: ${userActivityCount}</span>` : ''}
              ${errorLogsCount > 0 ? `<span class="text-red-600">⚠️ Errors: ${errorLogsCount}</span>` : ''}
            </div>
          </div>
        `;
      }

      container.innerHTML = html;

      // Add event listeners for view details buttons
      container.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const logData = JSON.parse(btn.getAttribute('data-log').replace(/&apos;/g, "'"));
          showDetailedLogModal(logData);
        });
      });
    }

    // Helper function to get simple action badge
    function getSimpleActionBadge(action) {
      switch(action) {
        case 'CREATE':
          return '<span class="px-2 py-1 rounded text-xs bg-green-100 text-green-800 font-semibold">➕ CREATED</span>';
        case 'UPDATE':
          return '<span class="px-2 py-1 rounded text-xs bg-blue-100 text-blue-800 font-semibold">🔄 UPDATED</span>';
        case 'DELETE':
          return '<span class="px-2 py-1 rounded text-xs bg-red-100 text-red-800 font-semibold">🗑️ DELETED</span>';
        default:
          return '<span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-800 font-semibold">❓ UNKNOWN</span>';
      }
    }

    // Helper function to get changes summary with actual data
    function getChangesSummary(log) {
      if (log.action === 'CREATE') {
        if (log.new_data) {
          const keyData = getKeyDataSummary(log.new_data, log.entity_type);
          return `NEW: ${keyData}`;
        }
        return 'New record created';
      } else if (log.action === 'DELETE') {
        if (log.old_data) {
          const keyData = getKeyDataSummary(log.old_data, log.entity_type);
          return `DELETED: ${keyData}`;
        }
        return 'Record deleted';
      } else if (log.action === 'UPDATE') {
        if (log.old_data && log.new_data) {
          const changes = getActualChanges(log.old_data, log.new_data);
          if (changes.length > 0) {
            return changes.join('; ');
          }
        }
        return 'Data updated';
      }
      return 'Unknown change';
    }

    // Get key data summary for display
    function getKeyDataSummary(data, entityType) {
      if (!data) return 'No data';

      switch(entityType) {
        case 'trial':
          return `${data.id || 'Unknown ID'} - ${data.title || 'No title'}`;
        case 'arm':
          return `${data.arm_type || 'Unknown type'} - ${data.products ? data.products.join(', ') : 'No products'}`;
        case 'demographics':
          const demoText = data.demographics_text || '';
          return demoText.length > 50 ? demoText.substring(0, 50) + '...' : demoText;
        case 'outcome':
          return `${data.outcome_type || 'Unknown type'} outcome`;
        case 'safety':
          return 'Safety assessment data';
        case 'response':
          return `${data.response_type || 'Unknown'} response - ${data.arm_selection || 'No ARM'}`;
        case 'survival_main':
        case 'survival_subgroup':
          return `${data.endpoint || 'Unknown endpoint'} - HR: ${data.hazard_ratio || 'N/A'}`;
        case 'milestone':
          return `${data.milestone_event || 'Unknown event'} - ${data.topic_tag || 'No tag'}`;
        default:
          const firstKey = Object.keys(data)[0];
          return firstKey ? `${firstKey}: ${data[firstKey]}` : 'Data record';
      }
    }

    // Get actual changes between old and new data
    function getActualChanges(oldData, newData) {
      const changes = [];

      // Check all fields in new data
      for (const key in newData) {
        if (key.includes('created_') || key.includes('updated_') || key.includes('_at') || key.includes('_id')) {
          continue; // Skip internal fields
        }

        const oldValue = oldData[key];
        const newValue = newData[key];

        if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {
          const oldDisplay = formatValueForSummary(oldValue);
          const newDisplay = formatValueForSummary(newValue);
          changes.push(`${key}: "${oldDisplay}" → "${newDisplay}"`);
        }
      }

      // Check for removed fields
      for (const key in oldData) {
        if (key.includes('created_') || key.includes('updated_') || key.includes('_at') || key.includes('_id')) {
          continue;
        }

        if (!(key in newData)) {
          const oldDisplay = formatValueForSummary(oldData[key]);
          changes.push(`${key}: REMOVED "${oldDisplay}"`);
        }
      }

      return changes;
    }

    // Format value for summary display
    function formatValueForSummary(value) {
      if (value === null || value === undefined) return 'N/A';
      if (Array.isArray(value)) return value.join(', ');
      if (typeof value === 'object') return JSON.stringify(value);
      const str = String(value);
      return str.length > 30 ? str.substring(0, 30) + '...' : str;
    }

    // Show detailed log modal
    function showDetailedLogModal(log) {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50';

      let content = `
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-blue-900">📋 Detailed Audit Log</h3>
            <button class="close-modal text-gray-600 hover:text-gray-900 text-2xl font-bold">&times;</button>
          </div>

          <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
            <div><strong>Date & Time:</strong> ${new Date(log.timestamp).toLocaleString()}</div>
            <div><strong>User:</strong> ${log.user_name || 'Unknown'}</div>
            <div><strong>Action:</strong> ${getSimpleActionBadge(log.action)}</div>
            <div><strong>Data Type:</strong> ${getEntityDisplayName(log.entity_type)}</div>
            <div><strong>Trial ID:</strong> ${log.trial_id || 'N/A'}</div>
            <div><strong>Tab:</strong> ${log.tab_name || 'N/A'}</div>
          </div>
      `;

      if (log.action === 'CREATE' && log.new_data) {
        content += `
          <div class="mb-6">
            <h4 class="text-lg font-semibold mb-3">NEW DATA ADDED:</h4>
            <div class="bg-gray-50 border p-4 rounded">
              ${formatPlainDataDisplay(log.new_data)}
            </div>
          </div>
        `;
      }

      if (log.action === 'UPDATE') {
        if (log.old_data && log.new_data) {
          content += `
            <div class="mb-6">
              <h4 class="text-lg font-semibold mb-3">WHAT CHANGED:</h4>
              <div class="bg-gray-50 border p-4 rounded">
                ${formatPlainChangesDisplay(log.old_data, log.new_data)}
              </div>
            </div>
          `;
        }
      }

      if (log.action === 'DELETE' && log.old_data) {
        content += `
          <div class="mb-6">
            <h4 class="text-lg font-semibold mb-3">DATA DELETED:</h4>
            <div class="bg-gray-50 border p-4 rounded">
              ${formatPlainDataDisplay(log.old_data)}
            </div>
          </div>
        `;
      }

      content += `
          <div class="mt-6">
            <details>
              <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-semibold">🔍 Raw Technical Data</summary>
              <pre class="mt-2 text-xs bg-gray-100 p-3 rounded overflow-auto max-h-60">${JSON.stringify(log, null, 2)}</pre>
            </details>
          </div>
        </div>
      `;

      modal.innerHTML = content;
      document.body.appendChild(modal);

      // Close modal functionality
      modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }

    // Helper function to get action badge class
    function getActionBadgeClass(action) {
      switch(action) {
        case 'CREATE': return 'bg-green-100 text-green-800';
        case 'UPDATE': return 'bg-blue-100 text-blue-800';
        case 'DELETE': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    // Helper function to get entity display name
    function getEntityDisplayName(entityType) {
      const entityNames = {
        'trial': 'Clinical Trial',
        'arm': 'Trial ARM',
        'demographics': 'Patient Demographics',
        'outcome': 'Outcome Measures',
        'criteria': 'Inclusion/Exclusion Criteria',
        'safety': 'Safety Assessment',
        'response': 'Response Assessment',
        'survival_main': 'Main ARM Survival Data',
        'survival_subgroup': 'Sub Group Survival Data',
        'milestone': 'Milestone',
        'reference': 'Reference'
      };
      return entityNames[entityType] || entityType;
    }

    // Helper function to format data for display
    function formatDataForDisplay(data, entityType) {
      if (!data) return '<div class="text-gray-500 italic">No data available</div>';

      // Remove internal fields that aren't useful for display
      const cleanData = { ...data };
      delete cleanData.created_at;
      delete cleanData.last_updated_at;
      delete cleanData.created_by_user_id;
      delete cleanData.last_updated_by_user_id;
      delete cleanData.created_by_user;
      delete cleanData.last_updated_by_user;

      let html = '<div class="space-y-3">';

      // Format based on entity type for better readability
      if (entityType === 'trial') {
        html += formatTrialData(cleanData);
      } else if (entityType === 'arm') {
        html += formatArmData(cleanData);
      } else if (entityType === 'demographics') {
        html += formatDemographicsData(cleanData);
      } else if (entityType === 'outcome') {
        html += formatOutcomeData(cleanData);
      } else if (entityType === 'safety') {
        html += formatSafetyData(cleanData);
      } else if (entityType === 'response') {
        html += formatResponseData(cleanData);
      } else if (entityType === 'survival_main' || entityType === 'survival_subgroup') {
        html += formatSurvivalData(cleanData);
      } else if (entityType === 'milestone') {
        html += formatMilestoneData(cleanData);
      } else {
        // Generic formatting for other types
        html += formatGenericData(cleanData);
      }

      // If no specific formatting was applied, show all data
      if (html === '<div class="space-y-3">') {
        html += '<div class="text-orange-600 font-semibold mb-2">📋 All Data Fields:</div>';
        Object.keys(cleanData).forEach(key => {
          if (cleanData[key] !== null && cleanData[key] !== undefined && cleanData[key] !== '') {
            const value = typeof cleanData[key] === 'object' ? JSON.stringify(cleanData[key], null, 2) : String(cleanData[key]);
            const displayValue = value.length > 200 ? value.substring(0, 200) + '...' : value;
            html += `
              <div class="border-l-4 border-blue-300 pl-3 py-1">
                <div class="font-semibold text-blue-800">${formatFieldName(key)}</div>
                <div class="text-gray-700 mt-1">${displayValue}</div>
              </div>
            `;
          }
        });
      }

      html += '</div>';
      return html;
    }

    // Helper function to format changes for display
    function formatChangesForDisplay(changes, oldData, newData) {
      if (!changes) {
        // If no changes object, try to compare old and new data directly
        if (oldData && newData) {
          return formatDirectDataComparison(oldData, newData);
        }
        return '<div class="text-gray-500 italic">No detailed changes available</div>';
      }

      let html = '<div class="space-y-3">';

      if (changes.modified_fields && changes.modified_fields.length > 0) {
        html += '<div class="text-blue-600 font-semibold mb-2">🔄 Modified Fields:</div>';
        changes.modified_fields.forEach(change => {
          html += `
            <div class="bg-white rounded border-l-4 border-blue-400 p-3 shadow-sm">
              <div class="font-semibold text-blue-800 mb-2">${formatFieldName(change.field)}</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div class="bg-red-50 p-2 rounded">
                  <div class="text-red-700 font-semibold text-xs">❌ BEFORE:</div>
                  <div class="text-red-600 text-sm mt-1">${formatFieldValue(change.old_value)}</div>
                </div>
                <div class="bg-green-50 p-2 rounded">
                  <div class="text-green-700 font-semibold text-xs">✅ AFTER:</div>
                  <div class="text-green-600 text-sm mt-1">${formatFieldValue(change.new_value)}</div>
                </div>
              </div>
            </div>
          `;
        });
      }

      if (changes.added_fields && changes.added_fields.length > 0) {
        html += '<div class="text-green-600 font-semibold mb-2 mt-4">➕ Added Fields:</div>';
        changes.added_fields.forEach(field => {
          const value = newData && newData[field] ? newData[field] : 'N/A';
          html += `
            <div class="bg-green-50 rounded border-l-4 border-green-400 p-3 shadow-sm">
              <div class="font-semibold text-green-800">${formatFieldName(field)}</div>
              <div class="text-green-600 mt-1">✅ Added: ${formatFieldValue(value)}</div>
            </div>
          `;
        });
      }

      if (changes.removed_fields && changes.removed_fields.length > 0) {
        html += '<div class="text-red-600 font-semibold mb-2 mt-4">➖ Removed Fields:</div>';
        changes.removed_fields.forEach(field => {
          const value = oldData && oldData[field] ? oldData[field] : 'N/A';
          html += `
            <div class="bg-red-50 rounded border-l-4 border-red-400 p-3 shadow-sm">
              <div class="font-semibold text-red-800">${formatFieldName(field)}</div>
              <div class="text-red-600 mt-1">❌ Removed: ${formatFieldValue(value)}</div>
            </div>
          `;
        });
      }

      html += '</div>';
      return html;
    }

    // Helper function to compare old and new data directly
    function formatDirectDataComparison(oldData, newData) {
      let html = '<div class="space-y-3">';
      html += '<div class="text-orange-600 font-semibold mb-2">🔍 Direct Data Comparison:</div>';

      const allKeys = new Set([...Object.keys(oldData || {}), ...Object.keys(newData || {})]);

      allKeys.forEach(key => {
        if (key.includes('created_') || key.includes('updated_') || key.includes('_at') || key.includes('_id')) {
          return; // Skip internal fields
        }

        const oldValue = oldData ? oldData[key] : undefined;
        const newValue = newData ? newData[key] : undefined;

        if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {
          html += `
            <div class="bg-white rounded border-l-4 border-orange-400 p-3 shadow-sm">
              <div class="font-semibold text-orange-800 mb-2">${formatFieldName(key)}</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <div class="bg-red-50 p-2 rounded">
                  <div class="text-red-700 font-semibold text-xs">❌ BEFORE:</div>
                  <div class="text-red-600 text-sm mt-1">${formatFieldValue(oldValue)}</div>
                </div>
                <div class="bg-green-50 p-2 rounded">
                  <div class="text-green-700 font-semibold text-xs">✅ AFTER:</div>
                  <div class="text-green-600 text-sm mt-1">${formatFieldValue(newValue)}</div>
                </div>
              </div>
            </div>
          `;
        }
      });

      html += '</div>';
      return html;
    }

    // Helper function to format field names
    function formatFieldName(fieldName) {
      return fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    // Helper function to format field values
    function formatFieldValue(value) {
      if (value === null || value === undefined) return '<span class="text-gray-400 italic">N/A</span>';

      if (typeof value === 'boolean') {
        return value ? '<span class="text-green-600 font-semibold">Yes</span>' : '<span class="text-red-600 font-semibold">No</span>';
      }

      if (Array.isArray(value)) {
        if (value.length === 0) return '<span class="text-gray-400 italic">Empty array</span>';
        return `<div class="space-y-1">${value.map(item => `<div class="bg-gray-100 px-2 py-1 rounded text-sm">• ${String(item)}</div>`).join('')}</div>`;
      }

      if (typeof value === 'object') {
        const formatted = JSON.stringify(value, null, 2);
        if (formatted.length > 300) {
          return `<pre class="text-xs bg-gray-100 p-2 rounded overflow-auto max-h-20">${formatted.substring(0, 300)}...</pre>`;
        }
        return `<pre class="text-xs bg-gray-100 p-2 rounded">${formatted}</pre>`;
      }

      if (typeof value === 'string') {
        // Check if it's a URL
        if (value.startsWith('http://') || value.startsWith('https://')) {
          return `<a href="${value}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">${value.length > 50 ? value.substring(0, 50) + '...' : value}</a>`;
        }

        // Check if it's a date
        if (value.match(/^\d{4}-\d{2}-\d{2}/) || value.includes('T') && value.includes('Z')) {
          try {
            const date = new Date(value);
            if (!isNaN(date.getTime())) {
              return `<span class="text-blue-600">${date.toLocaleString()}</span>`;
            }
          } catch (e) {
            // Not a valid date, continue with string formatting
          }
        }

        // Format long text
        if (value.length > 200) {
          return `
            <div class="text-sm">
              <div>${value.substring(0, 200)}...</div>
              <details class="mt-1">
                <summary class="cursor-pointer text-blue-600 hover:text-blue-800 text-xs">Show full text</summary>
                <div class="mt-2 p-2 bg-gray-50 rounded text-xs">${value}</div>
              </details>
            </div>
          `;
        }

        return `<span class="text-gray-800">${value}</span>`;
      }

      return `<span class="text-gray-800">${String(value)}</span>`;
    }

    // Specific formatting functions for different entity types
    function formatTrialData(data) {
      let html = '<div class="text-blue-600 font-semibold mb-2">🧪 Clinical Trial Details:</div>';

      if (data.id) html += `
        <div class="border-l-4 border-blue-300 pl-3 py-1">
          <div class="font-semibold text-blue-800">Trial ID</div>
          <div class="text-gray-700">${data.id}</div>
        </div>`;

      if (data.title) html += `
        <div class="border-l-4 border-blue-300 pl-3 py-1">
          <div class="font-semibold text-blue-800">Title</div>
          <div class="text-gray-700">${data.title}</div>
        </div>`;

      if (data.phase) html += `
        <div class="border-l-4 border-blue-300 pl-3 py-1">
          <div class="font-semibold text-blue-800">Phase</div>
          <div class="text-gray-700">${data.phase}</div>
        </div>`;

      if (data.status) html += `
        <div class="border-l-4 border-blue-300 pl-3 py-1">
          <div class="font-semibold text-blue-800">Status</div>
          <div class="text-gray-700">${data.status}</div>
        </div>`;

      if (data.indication && data.indication.length > 0) {
        html += `
          <div class="border-l-4 border-blue-300 pl-3 py-1">
            <div class="font-semibold text-blue-800">Indications</div>
            <div class="text-gray-700">${data.indication.join(', ')}</div>
          </div>`;
      }

      if (data.product_tags && data.product_tags.length > 0) {
        html += `
          <div class="border-l-4 border-blue-300 pl-3 py-1">
            <div class="font-semibold text-blue-800">Products</div>
            <div class="text-gray-700">${data.product_tags.join(', ')}</div>
          </div>`;
      }

      if (data.biomarkers && data.biomarkers.length > 0) {
        html += `
          <div class="border-l-4 border-blue-300 pl-3 py-1">
            <div class="font-semibold text-blue-800">Biomarkers</div>
            <div class="text-gray-700">${data.biomarkers.join(', ')}</div>
          </div>`;
      }

      if (data.start_date) html += `
        <div class="border-l-4 border-blue-300 pl-3 py-1">
          <div class="font-semibold text-blue-800">Start Date</div>
          <div class="text-gray-700">${data.start_date}</div>
        </div>`;

      if (data.end_date) html += `
        <div class="border-l-4 border-blue-300 pl-3 py-1">
          <div class="font-semibold text-blue-800">End Date</div>
          <div class="text-gray-700">${data.end_date}</div>
        </div>`;

      return html;
    }

    function formatArmData(data) {
      let html = '<div class="text-purple-600 font-semibold mb-2">💊 Trial ARM Details:</div>';

      if (data.arm_type) html += `
        <div class="border-l-4 border-purple-300 pl-3 py-1">
          <div class="font-semibold text-purple-800">ARM Type</div>
          <div class="text-gray-700">${data.arm_type}</div>
        </div>`;

      if (data.products && data.products.length > 0) {
        html += `
          <div class="border-l-4 border-purple-300 pl-3 py-1">
            <div class="font-semibold text-purple-800">Products</div>
            <div class="text-gray-700">${data.products.join(', ')}</div>
          </div>`;
      }

      if (data.dosage) html += `
        <div class="border-l-4 border-purple-300 pl-3 py-1">
          <div class="font-semibold text-purple-800">Dosage</div>
          <div class="text-gray-700">${data.dosage}</div>
        </div>`;

      if (data.arm_n) html += `
        <div class="border-l-4 border-purple-300 pl-3 py-1">
          <div class="font-semibold text-purple-800">N (Sample Size)</div>
          <div class="text-gray-700">${data.arm_n}</div>
        </div>`;

      if (data.arm_free_text) html += `
        <div class="border-l-4 border-purple-300 pl-3 py-1">
          <div class="font-semibold text-purple-800">ARM Free Text</div>
          <div class="text-gray-700">${data.arm_free_text}</div>
        </div>`;

      if (data.is_active !== undefined) html += `
        <div class="border-l-4 border-purple-300 pl-3 py-1">
          <div class="font-semibold text-purple-800">Is Active</div>
          <div class="text-gray-700">${data.is_active ? 'Yes' : 'No'}</div>
        </div>`;

      if (data.trial_id) html += `
        <div class="border-l-4 border-purple-300 pl-3 py-1">
          <div class="font-semibold text-purple-800">Trial ID</div>
          <div class="text-gray-700">${data.trial_id}</div>
        </div>`;

      return html;
    }

    function formatDemographicsData(data) {
      let html = '';
      if (data.demographics_text) html += `<div><strong>Demographics:</strong> ${data.demographics_text.substring(0, 200)}${data.demographics_text.length > 200 ? '...' : ''}</div>`;
      if (data.source) html += `<div><strong>Source:</strong> ${data.source}</div>`;
      if (data.source_link) html += `<div><strong>Source Link:</strong> <a href="${data.source_link}" target="_blank" class="text-blue-600 underline">${data.source_link}</a></div>`;
      return html;
    }

    function formatOutcomeData(data) {
      let html = '';
      if (data.outcome_type) html += `<div><strong>Outcome Type:</strong> ${data.outcome_type}</div>`;
      if (data.outcome_text) html += `<div><strong>Outcome Text:</strong> ${data.outcome_text.substring(0, 200)}${data.outcome_text.length > 200 ? '...' : ''}</div>`;
      return html;
    }

    function formatSafetyData(data) {
      let html = '';
      if (data.grade_3_aes) html += `<div><strong>Grade ≥3 AEs:</strong> ${data.grade_3_aes.substring(0, 100)}${data.grade_3_aes.length > 100 ? '...' : ''}</div>`;
      if (data.general_aes) html += `<div><strong>General AEs:</strong> ${data.general_aes.substring(0, 100)}${data.general_aes.length > 100 ? '...' : ''}</div>`;
      if (data.source) html += `<div><strong>Source:</strong> ${data.source}</div>`;
      if (data.source_link) html += `<div><strong>Source Link:</strong> <a href="${data.source_link}" target="_blank" class="text-blue-600 underline">${data.source_link}</a></div>`;
      return html;
    }

    function formatResponseData(data) {
      let html = '';
      if (data.arm_selection) html += `<div><strong>ARM Selection:</strong> ${data.arm_selection}</div>`;
      if (data.sub_category) html += `<div><strong>Sub Category:</strong> ${data.sub_category}</div>`;
      if (data.sub_group) html += `<div><strong>Sub Group:</strong> ${data.sub_group}</div>`;
      if (data.response_type) html += `<div><strong>Response Type:</strong> ${data.response_type}</div>`;
      if (data.response_n) html += `<div><strong>Response N:</strong> ${data.response_n}</div>`;
      if (data.percentage) html += `<div><strong>Percentage:</strong> ${data.percentage}%</div>`;
      if (data.hazard_ratio) html += `<div><strong>Hazard Ratio:</strong> ${data.hazard_ratio}</div>`;
      if (data.source) html += `<div><strong>Source:</strong> ${data.source}</div>`;
      return html;
    }

    function formatSurvivalData(data) {
      let html = '';
      if (data.mfu) html += `<div><strong>MFU:</strong> ${data.mfu}</div>`;
      if (data.mfu_unit) html += `<div><strong>MFU Unit:</strong> ${data.mfu_unit}</div>`;
      if (data.arm1_n) html += `<div><strong>N (Arm 1):</strong> ${data.arm1_n}</div>`;
      if (data.arm2_n) html += `<div><strong>N (Arm 2):</strong> ${data.arm2_n}</div>`;
      if (data.assessment_type) html += `<div><strong>Assessment Type:</strong> ${data.assessment_type}</div>`;
      if (data.endpoint) html += `<div><strong>Endpoint:</strong> ${data.endpoint}</div>`;
      if (data.hazard_ratio) html += `<div><strong>Hazard Ratio:</strong> ${data.hazard_ratio}</div>`;
      if (data.min_95_ci && data.max_95_ci) html += `<div><strong>95% CI:</strong> ${data.min_95_ci}-${data.max_95_ci}</div>`;
      if (data.pvalue) html += `<div><strong>P-Value:</strong> ${data.pvalue}</div>`;
      if (data.sub_group) html += `<div><strong>Sub Group:</strong> ${data.sub_group}</div>`;
      if (data.sub_group_category) html += `<div><strong>Sub Group Category:</strong> ${data.sub_group_category}</div>`;
      if (data.source) html += `<div><strong>Source:</strong> ${data.source}</div>`;
      return html;
    }

    function formatMilestoneData(data) {
      let html = '';
      if (data.milestone_event) html += `<div><strong>Milestone Event:</strong> ${data.milestone_event}</div>`;
      if (data.topic_tag) html += `<div><strong>Topic Tag:</strong> ${data.topic_tag}</div>`;
      if (data.milestone_description) html += `<div><strong>Description:</strong> ${data.milestone_description}</div>`;
      if (data.disease) html += `<div><strong>Disease:</strong> ${data.disease}</div>`;
      if (data.status) html += `<div><strong>Status:</strong> ${data.status}</div>`;
      if (data.active_status) html += `<div><strong>Active Status:</strong> ${data.active_status}</div>`;
      if (data.expected_date) html += `<div><strong>Expected Date:</strong> ${data.expected_date}</div>`;
      if (data.completed_date) html += `<div><strong>Completed Date:</strong> ${data.completed_date}</div>`;
      if (data.event_link) html += `<div><strong>Event Link:</strong> <a href="${data.event_link}" target="_blank" class="text-blue-600 underline">${data.event_link}</a></div>`;
      if (data.result_link) html += `<div><strong>Result Link:</strong> <a href="${data.result_link}" target="_blank" class="text-blue-600 underline">${data.result_link}</a></div>`;
      return html;
    }

    function formatGenericData(data) {
      let html = '';
      Object.keys(data).forEach(key => {
        if (data[key] !== null && data[key] !== undefined && data[key] !== '') {
          const value = typeof data[key] === 'object' ? JSON.stringify(data[key], null, 2) : String(data[key]);
          const displayValue = value.length > 100 ? value.substring(0, 100) + '...' : value;
          html += `<div><strong>${formatFieldName(key)}:</strong> ${displayValue}</div>`;
        }
      });
      return html;
    }

    // Format plain data display - simple and clear
    function formatPlainDataDisplay(data) {
      if (!data) return 'No data available';

      let html = '';

      Object.keys(data).forEach(key => {
        if (key.includes('created_') || key.includes('updated_') || key.includes('_at') || key.includes('_id')) {
          return; // Skip internal fields
        }

        if (data[key] !== null && data[key] !== undefined && data[key] !== '') {
          const value = data[key];
          let displayValue = '';

          if (Array.isArray(value)) {
            displayValue = value.join(', ');
          } else if (typeof value === 'object') {
            displayValue = JSON.stringify(value);
          } else {
            displayValue = String(value);
          }

          html += `<div><strong>${formatFieldName(key)}:</strong> ${displayValue}</div>`;
        }
      });

      return html || 'No data fields found';
    }

    // Format plain changes display - show exactly what changed
    function formatPlainChangesDisplay(oldData, newData) {
      if (!oldData || !newData) return 'No comparison data available';

      let html = '';
      const changes = [];

      // Find all changed fields
      const allKeys = new Set([...Object.keys(oldData), ...Object.keys(newData)]);

      allKeys.forEach(key => {
        if (key.includes('created_') || key.includes('updated_') || key.includes('_at') || key.includes('_id')) {
          return; // Skip internal fields
        }

        const oldValue = oldData[key];
        const newValue = newData[key];

        if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {
          let oldDisplay = '';
          let newDisplay = '';

          // Format old value
          if (oldValue === null || oldValue === undefined) {
            oldDisplay = '[EMPTY]';
          } else if (Array.isArray(oldValue)) {
            oldDisplay = oldValue.join(', ');
          } else if (typeof oldValue === 'object') {
            oldDisplay = JSON.stringify(oldValue);
          } else {
            oldDisplay = String(oldValue);
          }

          // Format new value
          if (newValue === null || newValue === undefined) {
            newDisplay = '[EMPTY]';
          } else if (Array.isArray(newValue)) {
            newDisplay = newValue.join(', ');
          } else if (typeof newValue === 'object') {
            newDisplay = JSON.stringify(newValue);
          } else {
            newDisplay = String(newValue);
          }

          changes.push(`
            <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd;">
              <div><strong>${formatFieldName(key)}:</strong></div>
              <div>OLD: ${oldDisplay}</div>
              <div>NEW: ${newDisplay}</div>
            </div>
          `);
        }
      });

      if (changes.length === 0) {
        return 'No changes detected in the data';
      }

      return changes.join('');
    }

    // Keep original function for backward compatibility
    function formatSimpleDataDisplay(data) {
      return formatPlainDataDisplay(data);
    }

    // Format before/after comparison
    function formatBeforeAfterComparison(oldData, newData) {
      if (!oldData || !newData) return '<p class="text-gray-500 italic">No comparison data available</p>';

      let html = '<div class="space-y-4">';

      const allKeys = new Set([...Object.keys(oldData), ...Object.keys(newData)]);

      allKeys.forEach(key => {
        if (key.includes('created_') || key.includes('updated_') || key.includes('_at') || key.includes('_id')) {
          return; // Skip internal fields
        }

        const oldValue = oldData[key];
        const newValue = newData[key];

        if (JSON.stringify(oldValue) !== JSON.stringify(newValue)) {
          let oldDisplay = '';
          let newDisplay = '';

          if (Array.isArray(oldValue)) {
            oldDisplay = oldValue ? oldValue.join(', ') : 'N/A';
          } else if (typeof oldValue === 'object') {
            oldDisplay = oldValue ? JSON.stringify(oldValue) : 'N/A';
          } else {
            oldDisplay = oldValue !== null && oldValue !== undefined ? String(oldValue) : 'N/A';
          }

          if (Array.isArray(newValue)) {
            newDisplay = newValue ? newValue.join(', ') : 'N/A';
          } else if (typeof newValue === 'object') {
            newDisplay = newValue ? JSON.stringify(newValue) : 'N/A';
          } else {
            newDisplay = newValue !== null && newValue !== undefined ? String(newValue) : 'N/A';
          }

          html += `
            <div class="border border-gray-200 rounded p-3">
              <div class="font-semibold text-gray-800 mb-2">${formatFieldName(key)}</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="bg-red-50 border border-red-200 p-2 rounded">
                  <div class="text-red-700 font-semibold text-xs mb-1">❌ BEFORE:</div>
                  <div class="text-red-600 text-sm">${oldDisplay}</div>
                </div>
                <div class="bg-green-50 border border-green-200 p-2 rounded">
                  <div class="text-green-700 font-semibold text-xs mb-1">✅ AFTER:</div>
                  <div class="text-green-600 text-sm">${newDisplay}</div>
                </div>
              </div>
            </div>
          `;
        }
      });

      html += '</div>';
      return html;
    }

    // Export audit data to CSV
    function exportAuditDataToCSV() {
      // This would implement CSV export functionality
      alert('CSV export functionality would be implemented here');
    }

    // Initialize audit trail functionality when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Set up simple page navigation
      setupSimplePageNavigation();

      // Initialize searchable dropdowns
      setTimeout(() => {
        initializeSearchableDropdowns();
      }, 1000);

      // Check if user is already logged in and show welcome message
      if (localStorage.getItem('isLoggedIn') === 'true') {
        setTimeout(() => {
          showWelcomeMessage();
        }, 500);
      }

      // Set up audit trail event listeners
      const auditTrailBtn = document.getElementById('auditTrailBtn');
      const auditTrailModal = document.getElementById('auditTrailModal');
      const closeAuditTrailBtn = document.getElementById('closeAuditTrailBtn');

      if (auditTrailBtn) {
        auditTrailBtn.addEventListener('click', () => {
          auditTrailModal.classList.remove('hidden');
          loadAuditTrailData();
          initializeEnhancedDropdownManagement();
        });
      }

      if (closeAuditTrailBtn) {
        closeAuditTrailBtn.addEventListener('click', () => {
          auditTrailModal.classList.add('hidden');
        });
      }

      // Apply audit filters
      const applyFiltersBtn = document.getElementById('applyAuditFilters');
      if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', () => {
          loadAuditTrailData();
        });
      }

      // Clear audit filters
      const clearFiltersBtn = document.getElementById('clearAuditFilters');
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
          document.getElementById('auditLogType').value = 'all';
          document.getElementById('auditUser').value = 'all';
          document.getElementById('auditDateFrom').value = '';
          document.getElementById('auditDateTo').value = '';
          loadAuditTrailData();
        });
      }

      // Export audit data
      const exportBtn = document.getElementById('exportAuditData');
      if (exportBtn) {
        exportBtn.addEventListener('click', () => {
          exportAuditDataToCSV();
        });
      }

      // Test audit logging
      const testBtn = document.getElementById('testAuditLogging');
      if (testBtn) {
        testBtn.addEventListener('click', async () => {
          testBtn.disabled = true;
          testBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Testing...';

          try {
            await testAuditLogging();
            alert('✅ Audit system test completed! Check console for details and refresh audit logs.');

            // Refresh audit logs after test
            setTimeout(() => {
              loadAuditTrailData();
            }, 1000);

          } catch (error) {
            alert('❌ Audit system test failed: ' + error.message);
          } finally {
            testBtn.disabled = false;
            testBtn.innerHTML = '<i class="fas fa-flask mr-2"></i> Test System';
          }
        });
      }

      // Show recent changes button
      const recentBtn = document.getElementById('showRecentChanges');
      if (recentBtn) {
        recentBtn.addEventListener('click', () => {
          // Clear all filters and show recent data changes
          document.getElementById('auditLogType').value = 'audit_trail';
          document.getElementById('auditAction').value = 'all';
          document.getElementById('auditEntity').value = 'all';
          document.getElementById('auditUser').value = 'all';
          document.getElementById('auditTrialId').value = '';
          document.getElementById('auditSearch').value = '';

          // Set date to last 7 days
          const today = new Date();
          const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
          document.getElementById('auditDateFrom').value = weekAgo.toISOString().split('T')[0];
          document.getElementById('auditDateTo').value = today.toISOString().split('T')[0];

          loadAuditTrailData();
        });
      }
    });
  </script>
</body>
</html>< ! - -   r e b u i l d   - - >  
 